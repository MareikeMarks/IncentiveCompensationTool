<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Incentive Compensation Tool | Book of Business</title>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <!-- Quick.js for BigQuery access -->
    <script src="/client/quick.js"></script>
    <style>
        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-card: #1a1a24;
            --accent-green: #00ff88;
            --accent-blue: #00d4ff;
            --accent-purple: #a855f7;
            --accent-red: #ff4757;
            --accent-yellow: #ffd93d;
            --accent-orange: #ff9f43;
            --text-primary: #ffffff;
            --text-secondary: #a0a0b0;
            --border: #2a2a3a;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Space Grotesk', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            background-image: 
                radial-gradient(circle at 20% 80%, rgba(0, 255, 136, 0.05) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(0, 212, 255, 0.05) 0%, transparent 50%);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        header {
            background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-card) 100%);
            border-bottom: 1px solid var(--border);
            padding: 1.5rem 0;
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo {
            font-size: 2rem;
        }

        h1 {
            font-size: 1.75rem;
            font-weight: 700;
            background: linear-gradient(90deg, var(--accent-green), var(--accent-blue));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        /* CSM Selector */
        .csm-selector {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 2rem;
            margin: 2rem 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1.5rem;
        }

        .csm-selector h2 {
            font-size: 1.25rem;
            color: var(--text-primary);
        }

        /* Step Container */
        .step-container {
            width: 100%;
            max-width: 700px;
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
        }

        .step-container.hidden {
            display: none;
        }

        .step-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .step-badge {
            width: 28px;
            height: 28px;
            background: var(--accent-purple);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.875rem;
        }

        .step-title {
            font-weight: 600;
            color: var(--text-primary);
        }

        .step-hint {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: 0.75rem;
            text-align: center;
        }

        /* Prompt Box */
        .prompt-box {
            background: #1a1a2e;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
            position: relative;
        }

        .prompt-box pre {
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.75rem;
            color: #a8dadc;
            white-space: pre-wrap;
            word-break: break-word;
            max-height: 200px;
            overflow-y: auto;
            margin: 0;
        }

        .copy-btn {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: var(--accent-purple);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 0.4rem 0.75rem;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .copy-btn:hover {
            background: var(--accent-blue);
            transform: scale(1.02);
        }

        .copy-btn.copied {
            background: var(--accent-green);
        }

        /* JSON Textarea */
        .json-textarea {
            width: 100%;
            min-height: 150px;
            background: #1a1a2e;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
            color: var(--text-primary);
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.8rem;
            resize: vertical;
            margin-bottom: 1rem;
        }

        .json-textarea::placeholder {
            color: var(--text-secondary);
            opacity: 0.6;
        }

        .json-textarea:focus {
            outline: none;
            border-color: var(--accent-purple);
        }

        /* Reset Button */
        .reset-btn {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-secondary);
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
        }

        .reset-btn:hover {
            border-color: var(--accent-purple);
            color: var(--text-primary);
        }

        .reset-btn.hidden {
            display: none;
        }

        /* Google Sign-in */
        .google-signin-btn {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            background: white;
            color: #1f1f1f;
            border: 1px solid #dadce0;
            border-radius: 8px;
            padding: 0.75rem 1.5rem;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .google-signin-btn:hover {
            background: #f8f9fa;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        /* User Info */
        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
            padding: 1rem;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
        }

        .user-avatar {
            width: 48px;
            height: 48px;
            background: var(--accent-purple);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .user-name {
            font-weight: 600;
            color: var(--text-primary);
        }

        .user-email {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .signout-btn {
            margin-top: 0.75rem;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 0.8rem;
            cursor: pointer;
            text-decoration: underline;
        }

        .signout-btn:hover {
            color: var(--text-primary);
        }

        #user-section.hidden {
            display: none;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .input-group {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            justify-content: center;
            width: 100%;
            max-width: 600px;
        }

        .csm-input {
            flex: 1;
            min-width: 250px;
            padding: 1rem 1.5rem;
            font-size: 1rem;
            font-family: 'Space Grotesk', sans-serif;
            background: var(--bg-secondary);
            border: 2px solid var(--border);
            border-radius: 12px;
            color: var(--text-primary);
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .csm-input:focus {
            outline: none;
            border-color: var(--accent-green);
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.2);
        }

        .csm-input::placeholder {
            color: var(--text-secondary);
        }

        .load-btn {
            padding: 1rem 2rem;
            font-size: 1rem;
            font-family: 'Space Grotesk', sans-serif;
            font-weight: 600;
            background: linear-gradient(135deg, var(--accent-green), var(--accent-blue));
            border: none;
            border-radius: 12px;
            color: var(--bg-primary);
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .load-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(0, 255, 136, 0.3);
        }

        .load-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Current CSM Badge */
        .current-csm {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            background: var(--bg-card);
            border: 1px solid var(--accent-green);
            padding: 0.5rem 1rem;
            border-radius: 2rem;
        }

        .current-csm-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .current-csm-name {
            font-weight: 600;
            color: var(--accent-green);
        }

        /* Metrics */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .metric-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.25rem;
            transition: transform 0.2s, border-color 0.2s;
        }

        .metric-card:hover {
            transform: translateY(-2px);
            border-color: var(--accent-blue);
        }

        .metric-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .metric-value {
            font-size: 1.5rem;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
        }

        .metric-value.green { color: var(--accent-green); }
        .metric-value.blue { color: var(--accent-blue); }
        .metric-value.purple { color: var(--accent-purple); }
        .metric-value.yellow { color: var(--accent-yellow); }
        .metric-value.orange { color: var(--accent-orange); }

        /* YoY Comparison Card */
        .yoy-comparison-card {
            background: linear-gradient(135deg, var(--bg-card) 0%, rgba(0, 212, 255, 0.1) 100%);
            border: 1px solid var(--accent-blue);
            border-radius: 12px;
            padding: 1.25rem;
            margin-bottom: 2rem;
        }

        .yoy-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .yoy-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .yoy-note {
            font-size: 0.7rem;
            color: var(--text-secondary);
            background: var(--bg-secondary);
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
        }

        .yoy-metrics {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .yoy-metric {
            text-align: center;
            flex: 1;
            min-width: 120px;
        }

        .yoy-metric.pacing {
            background: var(--bg-secondary);
            padding: 1rem;
            border-radius: 8px;
            flex: 1.5;
        }

        .yoy-metric-label {
            font-size: 0.7rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.25rem;
        }

        .yoy-metric-value {
            font-size: 1.75rem;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
        }

        .yoy-metric-value.previous {
            color: var(--text-secondary);
        }

        .yoy-metric-value.current {
            color: var(--accent-purple);
        }

        .yoy-metric-value.pacing-value {
            color: var(--accent-yellow);
        }

        .yoy-arrow {
            font-size: 1.5rem;
            color: var(--accent-blue);
            flex-shrink: 0;
        }

        .yoy-projected {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 0.5rem;
        }

        .yoy-projected strong {
            color: var(--accent-green);
        }

        /* Sections */
        section {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        h2 {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        h2 .emoji {
            font-size: 1.25rem;
        }

        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.8rem;
        }

        th, td {
            padding: 0.625rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        th {
            background: var(--bg-secondary);
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            font-size: 0.7rem;
            letter-spacing: 0.05em;
            position: sticky;
            top: 0;
        }

        tr:hover {
            background: rgba(0, 255, 136, 0.05);
        }

        .account-link {
            color: var(--accent-blue);
            text-decoration: none;
            font-weight: 500;
        }

        .account-link:hover {
            text-decoration: underline;
        }

        .pacing-high { color: var(--accent-green); font-weight: 600; }
        .pacing-medium { color: var(--accent-yellow); font-weight: 600; }
        .pacing-low { color: var(--accent-red); font-weight: 600; }

        .table-container {
            overflow-x: auto;
            max-height: 500px;
            overflow-y: auto;
        }

        .number {
            font-family: 'JetBrains Mono', monospace;
        }

        /* Quarterly Cards */
        .quarterly-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
        }

        .quarter-card {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
        }

        .quarter-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.75rem;
        }

        .quarter-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            font-weight: 600;
        }

        .quarter-values {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .quarter-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .year-label {
            font-size: 0.7rem;
            color: var(--text-secondary);
        }

        .quarter-value {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 600;
            font-size: 0.875rem;
        }

        .yoy-badge {
            font-size: 0.7rem;
            padding: 0.125rem 0.375rem;
            border-radius: 4px;
            font-weight: 600;
        }

        .yoy-positive {
            background: rgba(0, 255, 136, 0.2);
            color: var(--accent-green);
        }

        .yoy-negative {
            background: rgba(255, 71, 87, 0.2);
            color: var(--accent-red);
        }

        .yoy-neutral {
            background: rgba(160, 160, 176, 0.2);
            color: var(--text-secondary);
        }

        /* Loading State */
        .loading {
            display: none;
            text-align: center;
            padding: 3rem;
            color: var(--text-secondary);
        }

        .loading.active {
            display: block;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border);
            border-top-color: var(--accent-green);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Report Content - always visible */
        #report-content {
            display: block;
        }

        /* Take Rate Section */
        .take-rate-section {
            background: linear-gradient(135deg, var(--bg-card) 0%, rgba(168, 85, 247, 0.1) 100%);
            border: 1px solid var(--accent-purple);
        }

        .section-description {
            color: var(--text-secondary);
            font-size: 0.875rem;
            margin-bottom: 1.5rem;
        }

        .take-rate-chart {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .chart-header span {
            font-weight: 600;
            color: var(--text-primary);
        }

        .chart-legend {
            display: flex;
            gap: 1rem;
            font-size: 0.75rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            color: var(--text-secondary);
        }

        .legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 2px;
        }

        .legend-dot.low { background: var(--accent-red); }
        .legend-dot.medium { background: var(--accent-yellow); }
        .legend-dot.high { background: var(--accent-green); }

        .bar-chart {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .bar-row {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .bar-label {
            width: 120px;
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-align: right;
            flex-shrink: 0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .bar-container {
            flex: 1;
            height: 24px;
            background: var(--bg-card);
            border-radius: 4px;
            overflow: hidden;
        }

        .bar {
            height: 100%;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 0.5rem;
            min-width: 60px;
            transition: width 0.5s ease;
        }

        .bar.low { background: linear-gradient(90deg, var(--accent-red), #ff6b7a); }
        .bar.medium { background: linear-gradient(90deg, var(--accent-yellow), #ffe066); }
        .bar.high { background: linear-gradient(90deg, var(--accent-green), #66ffaa); }

        .bar-value {
            font-size: 0.7rem;
            font-family: 'JetBrains Mono', monospace;
            font-weight: 600;
            color: var(--bg-primary);
        }

        .opportunities-table h3 {
            font-size: 1rem;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .recommendation-note {
            font-size: 0.75rem;
            color: var(--accent-yellow);
            margin-bottom: 1rem;
            padding: 0.5rem;
            background: rgba(255, 217, 61, 0.1);
            border-radius: 4px;
            border-left: 3px solid var(--accent-yellow);
        }

        .product-tag {
            display: inline-block;
            padding: 0.125rem 0.5rem;
            border-radius: 4px;
            font-size: 0.65rem;
            font-weight: 600;
            margin: 0.125rem;
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }

        .product-tag.payments {
            background: rgba(0, 212, 255, 0.2);
            color: var(--accent-blue);
            border: 1px solid var(--accent-blue);
        }

        .product-tag.installments {
            background: rgba(168, 85, 247, 0.2);
            color: var(--accent-purple);
            border: 1px solid var(--accent-purple);
        }

        .product-tag.capital {
            background: rgba(0, 255, 136, 0.2);
            color: var(--accent-green);
            border: 1px solid var(--accent-green);
        }

        .product-tag.shipping {
            background: rgba(255, 159, 67, 0.2);
            color: var(--accent-orange);
            border: 1px solid var(--accent-orange);
        }

        .product-tag.pos {
            background: rgba(255, 71, 87, 0.2);
            color: var(--accent-red);
            border: 1px solid var(--accent-red);
        }

        .product-tag.b2b {
            background: rgba(255, 217, 61, 0.2);
            color: var(--accent-yellow);
            border: 1px solid var(--accent-yellow);
        }

        .product-tag.markets {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
            border: 1px solid var(--text-secondary);
        }

        .take-rate-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .summary-card {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .summary-icon {
            font-size: 2rem;
        }

        .summary-content {
            display: flex;
            flex-direction: column;
        }

        .summary-value {
            font-size: 1.5rem;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
            color: var(--accent-green);
        }

        .summary-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        /* Filter Bar */
        .filter-bar {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            align-items: flex-end;
            margin-bottom: 1rem;
            padding: 1rem;
            background: var(--bg-secondary);
            border-radius: 8px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .filter-group label {
            font-size: 0.7rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .filter-input {
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
            font-family: 'Space Grotesk', sans-serif;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            min-width: 200px;
            transition: border-color 0.2s;
        }

        .filter-input:focus {
            outline: none;
            border-color: var(--accent-green);
        }

        .filter-select {
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
            font-family: 'Space Grotesk', sans-serif;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            cursor: pointer;
            min-width: 150px;
        }

        .filter-select:focus {
            outline: none;
            border-color: var(--accent-green);
        }

        .clear-filters-btn {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            font-family: 'Space Grotesk', sans-serif;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
        }

        .clear-filters-btn:hover {
            border-color: var(--accent-red);
            color: var(--accent-red);
        }

        .filter-count {
            margin-left: auto;
            font-size: 0.8rem;
            color: var(--accent-green);
            font-family: 'JetBrains Mono', monospace;
        }

        tr.hidden {
            display: none;
        }

        .sort-hint {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .sortable {
            cursor: pointer;
            user-select: none;
            transition: background 0.2s;
        }

        .sortable:hover {
            background: var(--bg-card);
        }

        .sort-icon {
            opacity: 0.4;
            font-size: 0.7rem;
            margin-left: 0.25rem;
        }

        .sortable.asc .sort-icon,
        .sortable.desc .sort-icon {
            opacity: 1;
            color: var(--accent-green);
        }

        .sortable.asc .sort-icon::after { content: '‚Üë'; }
        .sortable.desc .sort-icon::after { content: '‚Üì'; }

        /* Footer */
        footer {
            text-align: center;
            padding: 2rem;
            color: var(--text-secondary);
            font-size: 0.8rem;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .quarterly-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            h1 {
                font-size: 1.25rem;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo-section">
                    <span class="logo">üí∞</span>
                    <div>
                        <h1>Incentive Compensation Tool</h1>
                        <p class="subtitle">Book of Business & Revenue Tracking</p>
                    </div>
                </div>
                <div class="current-csm" id="current-csm-badge" style="display: flex;">
                    <span class="current-csm-label">Viewing:</span>
                    <span class="current-csm-name" id="current-csm-name">Maya Marks</span>
                </div>
            </div>
        </div>
    </header>

    <main class="container">
        <!-- CSM Selector - Live BigQuery Data -->
        <div class="csm-selector">
            <h2>üë§ Load Your Book of Business</h2>
            
            <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">Enter your name to pull live data from BigQuery</p>
            
            <!-- Auth Status -->
            <div id="auth-status" style="display: none; margin-bottom: 1rem; padding: 0.75rem 1rem; border-radius: 8px; font-size: 0.875rem;"></div>
            
            <!-- Name Input -->
            <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap; justify-content: center; margin-bottom: 0.75rem;">
                <input 
                    type="text" 
                    id="csm-name-input" 
                    placeholder="Enter your name (e.g., Maya Marks)"
                    value=""
                    style="padding: 0.75rem 1rem; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-primary); color: var(--text-primary); font-size: 1rem; min-width: 280px;"
                    onkeypress="if(event.key === 'Enter') loadLiveData()"
                >
                <button id="load-btn" onclick="loadLiveData()" style="padding: 0.75rem 1.5rem; border-radius: 8px; background: linear-gradient(135deg, #00ff88, #00d4ff); color: #0a0a0f; border: none; cursor: pointer; font-weight: 600;">
                    ‚ö° Load Live Data
                </button>
            </div>
            <div style="display: flex; gap: 0.5rem; align-items: center; justify-content: center; margin-bottom: 1rem;">
                <input type="checkbox" id="include-midmarket-scaled" style="width: 18px; height: 18px; cursor: pointer;">
                <label for="include-midmarket-scaled" style="color: var(--text-secondary); font-size: 0.9rem; cursor: pointer;">
                    Include Mid-Market Scaled accounts <span style="color: var(--accent-purple);">(check if you're a Mid-Market Scaled CSM)</span>
                </label>
            </div>
            
            <!-- Error Message -->
            <div id="error-message" style="display: none; background: rgba(255, 71, 87, 0.1); border: 1px solid var(--accent-red); border-radius: 8px; padding: 1rem; margin-top: 1rem; max-width: 600px; text-align: left;">
                <p style="color: var(--accent-red); margin: 0; font-size: 0.875rem;" id="error-text"></p>
            </div>
            
            <p style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 1rem;">
                ‚ö° Live data from BigQuery ‚Ä¢ <span id="data-source-label">shopify-dw.finance + shopify-dw.sales</span>
            </p>
        </div>

        <!-- Success Message (shown briefly after loading) -->
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Processing data...</p>
        </div>

        <!-- Report Content -->
        <div id="report-content">
            <!-- Metrics -->
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-label">Total Accounts</div>
                    <div class="metric-value blue" id="metric-accounts">37</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">2025 Total Revenue</div>
                    <div class="metric-value green" id="metric-2025-rev">$15.7M</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">L12M GMV</div>
                    <div class="metric-value blue" id="metric-gmv">$1.38B</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Avg Take Rate</div>
                    <div class="metric-value orange" id="metric-take-rate">4.49%</div>
                </div>
            </div>

            <!-- NRR Target Tracker (Configurable by Quarter) -->
            <div class="yoy-comparison-card" id="nrr-target-section">
                <div class="yoy-header">
                    <span class="yoy-title">üéØ <span id="nrr-quarter-title">Q1 2026</span> NRR Target</span>
                    <select id="quarter-selector" onchange="onQuarterChange()" 
                        style="padding: 0.4rem 0.8rem; border-radius: 6px; border: 1px solid var(--border); 
                        background: var(--bg-secondary); color: var(--accent-blue); font-weight: 600; cursor: pointer;">
                        <option value="Q1-2026">Q1 2026</option>
                        <option value="Q2-2026">Q2 2026</option>
                        <option value="Q3-2026">Q3 2026</option>
                        <option value="Q4-2026">Q4 2026</option>
                    </select>
                    <span class="yoy-note" id="quarter-progress-note">~22% of quarter elapsed</span>
                </div>
                <div class="yoy-metrics">
                    <div class="yoy-metric">
                        <div class="yoy-metric-label"><span id="quarter-ytd-label">Q1 2026</span> (YTD)</div>
                        <div class="yoy-metric-value current" id="q1-2026-ytd">$0</div>
                    </div>
                    <div class="yoy-arrow">‚Üí</div>
                    <div class="yoy-metric">
                        <div class="yoy-metric-label">My Target (in millions)</div>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <span style="color: var(--accent-purple); font-size: 1.5rem;">$</span>
                            <input type="number" id="nrr-target-input" placeholder="e.g. 3.88" step="0.01"
                                style="padding: 0.5rem; border-radius: 8px; border: 1px solid var(--border); 
                                background: var(--bg-secondary); color: var(--accent-purple); width: 100px; 
                                font-size: 1.25rem; font-weight: 700; text-align: center;"
                                onchange="updateNRRTracker()" onkeyup="updateNRRTracker()">
                            <span style="color: var(--text-secondary); font-size: 1rem;">M</span>
                        </div>
                    </div>
                    <div class="yoy-metric pacing">
                        <div class="yoy-metric-label">Pacing to Target</div>
                        <div class="yoy-metric-value pacing-value" id="nrr-pacing">-</div>
                        <div id="nrr-status" style="font-size: 0.85rem; margin-top: 0.25rem;"></div>
                    </div>
                    <div class="yoy-arrow">‚Üí</div>
                    <div class="yoy-metric">
                        <div class="yoy-metric-label">Estimated <span id="quarter-est-label">Q1</span> Total</div>
                        <div class="yoy-metric-value" id="nrr-projected" style="color: var(--accent-cyan);">-</div>
                        <div id="nrr-projected-note" style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.25rem;"></div>
                    </div>
                </div>
                <div id="nrr-progress-container" style="margin-top: 1rem; display: none;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem; font-size: 0.85rem;">
                        <span style="color: var(--text-secondary);">Progress: <span id="nrr-current-display">$0</span></span>
                        <span style="color: var(--text-secondary);">Target: <span id="nrr-target-display">$0</span></span>
                    </div>
                    <div style="background: var(--bg-secondary); border-radius: 8px; height: 12px; overflow: hidden;">
                        <div id="nrr-progress-bar" style="height: 100%; background: linear-gradient(90deg, var(--accent-green), var(--accent-blue)); 
                            border-radius: 8px; transition: width 0.5s ease; width: 0%;"></div>
                    </div>
                </div>
            </div>

            <!-- Quarterly Performance -->
            <section>
                <h2><span class="emoji">üìà</span> Quarterly Performance</h2>
                <div class="quarterly-grid">
                    <div class="quarter-card">
                        <div class="quarter-label">Q1</div>
                        <div class="quarter-values">
                            <div class="quarter-row">
                                <span class="year-label">2025</span>
                                <span class="quarter-value">$2.55M</span>
                            </div>
                            <div class="quarter-row">
                                <span class="year-label">2026</span>
                                <span class="quarter-value" style="color: var(--accent-green);">$930K</span>
                            </div>
                            <span class="yoy-badge yoy-positive">36.5% YoY</span>
                        </div>
                    </div>
                    <div class="quarter-card">
                        <div class="quarter-label">Q2</div>
                        <div class="quarter-values">
                            <div class="quarter-row">
                                <span class="year-label">2025</span>
                                <span class="quarter-value">$3.71M</span>
                            </div>
                            <div class="quarter-row">
                                <span class="year-label">2026</span>
                                <span class="quarter-value" style="color: var(--text-secondary);">-</span>
                            </div>
                            <span class="yoy-badge yoy-neutral">Not started</span>
                        </div>
                    </div>
                    <div class="quarter-card">
                        <div class="quarter-label">Q3</div>
                        <div class="quarter-values">
                            <div class="quarter-row">
                                <span class="year-label">2025</span>
                                <span class="quarter-value">$3.96M</span>
                            </div>
                            <div class="quarter-row">
                                <span class="year-label">2026</span>
                                <span class="quarter-value" style="color: var(--text-secondary);">-</span>
                            </div>
                            <span class="yoy-badge yoy-neutral">Not started</span>
                        </div>
                    </div>
                    <div class="quarter-card">
                        <div class="quarter-label">Q4</div>
                        <div class="quarter-values">
                            <div class="quarter-row">
                                <span class="year-label">2025</span>
                                <span class="quarter-value">$5.50M</span>
                            </div>
                            <div class="quarter-row">
                                <span class="year-label">2026</span>
                                <span class="quarter-value" style="color: var(--text-secondary);">-</span>
                            </div>
                            <span class="yoy-badge yoy-neutral">Not started</span>
                        </div>
                    </div>
                </div>
            </section>

            <!-- All Accounts Q1 Performance -->
            <section>
                <h2><span class="emoji">üìä</span> All Accounts - Q1 Performance (Sorted by Q1 2026 Revenue)</h2>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Account</th>
                                <th>Q1 2025</th>
                                <th>Q1 2026</th>
                                <th>YoY Pacing</th>
                            </tr>
                        </thead>
                        <tbody id="all-accounts-q1">
                            <tr><td colspan="4" style="text-align: center; color: var(--text-secondary);">Load your data to see Q1 performance</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Needs Attention -->
            <section>
                <h2><span class="emoji">‚ö†Ô∏è</span> Needs Attention (Q1 YoY < 25%)</h2>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Account</th>
                                <th>Q1 2025</th>
                                <th>Q1 2026</th>
                                <th>YoY Pacing</th>
                            </tr>
                        </thead>
                        <tbody id="needs-attention">
                            <tr><td colspan="4" style="text-align: center; color: var(--text-secondary);">Load your data to see accounts needing attention</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Full Book of Business -->
            <section>
                <h2><span class="emoji">üìã</span> Complete Book of Business</h2>
                <div class="filter-bar">
                    <div class="filter-group">
                        <label for="account-search">üîç Search</label>
                        <input type="text" id="account-search" class="filter-input" placeholder="Filter by account name..." onkeyup="filterTable()">
                    </div>
                    <div class="filter-group">
                        <label for="pacing-filter">üìà Q1 Pacing</label>
                        <select id="pacing-filter" class="filter-select" onchange="filterTable()">
                            <option value="all">All Accounts</option>
                            <option value="high">High (> 40%)</option>
                            <option value="medium">Medium (25-40%)</option>
                            <option value="low">Needs Attention (< 25%)</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="revenue-filter">üí∞ 2025 Revenue</label>
                        <select id="revenue-filter" class="filter-select" onchange="filterTable()">
                            <option value="all">All</option>
                            <option value="1m">$1M+</option>
                            <option value="500k">$500K - $1M</option>
                            <option value="100k">$100K - $500K</option>
                            <option value="under100k">Under $100K</option>
                        </select>
                    </div>
                    <button class="clear-filters-btn" onclick="clearFilters()">Clear Filters</button>
                    <span class="filter-count" id="filter-count">Showing 37 accounts</span>
                </div>
                <p class="sort-hint">üí° Click any column header to sort</p>
                <div class="table-container">
                    <table id="book-table">
                        <thead>
                            <tr>
                                <th class="sortable" data-col="0" onclick="sortTable(0, 'string')">Account <span class="sort-icon">‚áÖ</span></th>
                                <th>SFDC</th>
                                <th class="sortable" data-col="2" onclick="sortTable(2, 'string')">Segment <span class="sort-icon">‚áÖ</span></th>
                                <th class="sortable" data-col="3" onclick="sortTable(3, 'currency')">L12M GMV <span class="sort-icon">‚áÖ</span></th>
                                <th class="sortable" data-col="4" onclick="sortTable(4, 'currency')">L12M Rev <span class="sort-icon">‚áÖ</span></th>
                                <th class="sortable" data-col="5" onclick="sortTable(5, 'percent')">Take Rate <span class="sort-icon">‚áÖ</span></th>
                                <th class="sortable" data-col="6" onclick="sortTable(6, 'currency')">2025 Total <span class="sort-icon">‚áÖ</span></th>
                                <th class="sortable" data-col="7" onclick="sortTable(7, 'currency')">Q1 '25 <span class="sort-icon">‚áÖ</span></th>
                                <th class="sortable" data-col="8" onclick="sortTable(8, 'currency')">Q1 '26 <span class="sort-icon">‚áÖ</span></th>
                                <th class="sortable" data-col="9" onclick="sortTable(9, 'percent')">Q1 YoY <span class="sort-icon">‚áÖ</span></th>
                                <th class="sortable" data-col="10" onclick="sortTable(10, 'currency')">Q2 '25 <span class="sort-icon">‚áÖ</span></th>
                                <th class="sortable" data-col="11" onclick="sortTable(11, 'currency')">Q2 '26 <span class="sort-icon">‚áÖ</span></th>
                                <th class="sortable" data-col="12" onclick="sortTable(12, 'percent')">Q2 YoY <span class="sort-icon">‚áÖ</span></th>
                                <th class="sortable" data-col="13" onclick="sortTable(13, 'currency')">Q3 '25 <span class="sort-icon">‚áÖ</span></th>
                                <th class="sortable" data-col="14" onclick="sortTable(14, 'currency')">Q3 '26 <span class="sort-icon">‚áÖ</span></th>
                                <th class="sortable" data-col="15" onclick="sortTable(15, 'percent')">Q3 YoY <span class="sort-icon">‚áÖ</span></th>
                                <th class="sortable" data-col="16" onclick="sortTable(16, 'currency')">Q4 '25 <span class="sort-icon">‚áÖ</span></th>
                                <th class="sortable" data-col="17" onclick="sortTable(17, 'currency')">Q4 '26 <span class="sort-icon">‚áÖ</span></th>
                                <th class="sortable" data-col="18" onclick="sortTable(18, 'percent')">Q4 YoY <span class="sort-icon">‚áÖ</span></th>
                            </tr>
                        </thead>
                        <tbody id="full-book">
                            <tr><td>prepmymeal.de</td><td><a class="account-link" href="https://banff.lightning.force.com/lightning/r/Account/0018V00002czZeMQAU/view" target="_blank">üîó</a></td><td class="number">$101.5M</td><td class="number">$3.17M</td><td class="number">6.71%</td><td class="number">$1,519,010</td><td class="number">$271,910</td><td class="number">$132,521</td><td class="pacing-high">48.7%</td><td class="number">$331,451</td><td class="number">$0</td><td>-</td><td class="number">$434,642</td><td class="number">$0</td><td>-</td><td class="number">$481,007</td><td class="number">$0</td><td>-</td></tr>
                            <tr><td>Vice Golf</td><td><a class="account-link" href="https://banff.lightning.force.com/lightning/r/Account/0018V00002czJVXQA2/view" target="_blank">üîó</a></td><td class="number">$54.2M</td><td class="number">$2.46M</td><td class="number">10.69%</td><td class="number">$1,319,933</td><td class="number">$200,715</td><td class="number">$37,822</td><td class="pacing-low">18.8%</td><td class="number">$436,575</td><td class="number">$0</td><td>-</td><td class="number">$365,802</td><td class="number">$0</td><td>-</td><td class="number">$316,841</td><td class="number">$0</td><td>-</td></tr>
                            <tr><td>wunschgutschein.com</td><td><a class="account-link" href="https://banff.lightning.force.com/lightning/r/Account/0018V00002czjnKQAQ/view" target="_blank">üîó</a></td><td class="number">$130.2M</td><td class="number">$2.05M</td><td class="number">2.89%</td><td class="number">$1,062,826</td><td class="number">$184,207</td><td class="number">$75,711</td><td class="pacing-high">41.1%</td><td class="number">$213,058</td><td class="number">$0</td><td>-</td><td class="number">$219,836</td><td class="number">$0</td><td>-</td><td class="number">$445,724</td><td class="number">$0</td><td>-</td></tr>
                            <tr><td>Nature Heart</td><td><a class="account-link" href="https://banff.lightning.force.com/lightning/r/Account/0018V00002sPS9yQAG/view" target="_blank">üîó</a></td><td class="number">$68.8M</td><td class="number">$2.18M</td><td class="number">6.89%</td><td class="number">$1,057,057</td><td class="number">$222,335</td><td class="number">$39,787</td><td class="pacing-low">17.9%</td><td class="number">$282,350</td><td class="number">$0</td><td>-</td><td class="number">$258,052</td><td class="number">$0</td><td>-</td><td class="number">$294,320</td><td class="number">$0</td><td>-</td></tr>
                            <tr><td>smartport GmbH</td><td><a class="account-link" href="https://banff.lightning.force.com/lightning/r/Account/001OG00000tx5K9YAI/view" target="_blank">üîó</a></td><td class="number">$73.2M</td><td class="number">$1.31M</td><td class="number">4.00%</td><td class="number">$832,706</td><td class="number">$27,028</td><td class="number">$28,635</td><td class="pacing-high">105.9%</td><td class="number">$167,585</td><td class="number">$0</td><td>-</td><td class="number">$199,637</td><td class="number">$0</td><td>-</td><td class="number">$438,457</td><td class="number">$0</td><td>-</td></tr>
                            <tr><td>atletica.de</td><td><a class="account-link" href="https://banff.lightning.force.com/lightning/r/Account/0018V00002czoK0QAI/view" target="_blank">üîó</a></td><td class="number">$48.5M</td><td class="number">$1.43M</td><td class="number">6.39%</td><td class="number">$740,618</td><td class="number">$126,543</td><td class="number">$43,946</td><td class="pacing-medium">34.7%</td><td class="number">$170,765</td><td class="number">$0</td><td>-</td><td class="number">$177,827</td><td class="number">$0</td><td>-</td><td class="number">$265,484</td><td class="number">$0</td><td>-</td></tr>
                            <tr><td>PURELEI</td><td><a class="account-link" href="https://banff.lightning.force.com/lightning/r/Account/0018V00002czm93QAA/view" target="_blank">üîó</a></td><td class="number">$67.1M</td><td class="number">$1.40M</td><td class="number">7.37%</td><td class="number">$702,871</td><td class="number">$93,047</td><td class="number">$38,877</td><td class="pacing-high">41.8%</td><td class="number">$154,098</td><td class="number">$0</td><td>-</td><td class="number">$192,067</td><td class="number">$0</td><td>-</td><td class="number">$263,660</td><td class="number">$0</td><td>-</td></tr>
                            <tr><td>solago.de</td><td><a class="account-link" href="https://banff.lightning.force.com/lightning/r/Account/0018V00002czd5BQAQ/view" target="_blank">üîó</a></td><td class="number">$92.0M</td><td class="number">$1.28M</td><td class="number">7.14%</td><td class="number">$656,571</td><td class="number">$150,818</td><td class="number">$34,846</td><td class="pacing-low">23.1%</td><td class="number">$190,775</td><td class="number">$0</td><td>-</td><td class="number">$144,123</td><td class="number">$0</td><td>-</td><td class="number">$170,856</td><td class="number">$0</td><td>-</td></tr>
                            <tr><td>6PM</td><td><a class="account-link" href="https://banff.lightning.force.com/lightning/r/Account/0018V00002czmtdQAA/view" target="_blank">üîó</a></td><td class="number">$67.6M</td><td class="number">$1.25M</td><td class="number">2.88%</td><td class="number">$650,461</td><td class="number">$89,888</td><td class="number">$35,620</td><td class="pacing-medium">39.6%</td><td class="number">$117,297</td><td class="number">$0</td><td>-</td><td class="number">$110,216</td><td class="number">$0</td><td>-</td><td class="number">$333,061</td><td class="number">$0</td><td>-</td></tr>
                            <tr><td>Estrid Studios AB</td><td><a class="account-link" href="https://banff.lightning.force.com/lightning/r/Account/0018V00002cz9zAQAQ/view" target="_blank">üîó</a></td><td class="number">$43.4M</td><td class="number">$1.13M</td><td class="number">5.93%</td><td class="number">$645,940</td><td class="number">$109,552</td><td class="number">$30,987</td><td class="pacing-medium">28.3%</td><td class="number">$165,873</td><td class="number">$0</td><td>-</td><td class="number">$195,014</td><td class="number">$0</td><td>-</td><td class="number">$175,502</td><td class="number">$0</td><td>-</td></tr>
                            <tr><td>The Body Shop UK</td><td><a class="account-link" href="https://banff.lightning.force.com/lightning/r/Account/0018V00002cznvgQAA/view" target="_blank">üîó</a></td><td class="number">$38.6M</td><td class="number">$1.13M</td><td class="number">8.99%</td><td class="number">$624,184</td><td class="number">$81,400</td><td class="number">$30,342</td><td class="pacing-medium">37.3%</td><td class="number">$134,802</td><td class="number">$0</td><td>-</td><td class="number">$148,037</td><td class="number">$0</td><td>-</td><td class="number">$259,945</td><td class="number">$0</td><td>-</td></tr>
                            <tr><td>Solakon GmbH</td><td><a class="account-link" href="https://banff.lightning.force.com/lightning/r/Account/0018V00002eqkZ3QAI/view" target="_blank">üîó</a></td><td class="number">$75.9M</td><td class="number">$1.12M</td><td class="number">5.85%</td><td class="number">$600,354</td><td class="number">$112,511</td><td class="number">$26,978</td><td class="pacing-low">24.0%</td><td class="number">$169,351</td><td class="number">$0</td><td>-</td><td class="number">$170,010</td><td class="number">$0</td><td>-</td><td class="number">$148,482</td><td class="number">$0</td><td>-</td></tr>
                            <tr><td>formbench.com</td><td><a class="account-link" href="https://banff.lightning.force.com/lightning/r/Account/0018V00002czcZiQAI/view" target="_blank">üîó</a></td><td class="number">$48.4M</td><td class="number">$1.04M</td><td class="number">6.04%</td><td class="number">$534,005</td><td class="number">$144,044</td><td class="number">$29,472</td><td class="pacing-low">20.5%</td><td class="number">$144,211</td><td class="number">$0</td><td>-</td><td class="number">$117,759</td><td class="number">$0</td><td>-</td><td class="number">$127,991</td><td class="number">$0</td><td>-</td></tr>
                            <tr><td>zenkoh.de</td><td><a class="account-link" href="https://banff.lightning.force.com/lightning/r/Account/0018V00002czh5jQAA/view" target="_blank">üîó</a></td><td class="number">$65.4M</td><td class="number">$1.00M</td><td class="number">6.61%</td><td class="number">$526,347</td><td class="number">$102,372</td><td class="number">$31,775</td><td class="pacing-medium">31.0%</td><td class="number">$133,020</td><td class="number">$0</td><td>-</td><td class="number">$147,078</td><td class="number">$0</td><td>-</td><td class="number">$143,877</td><td class="number">$0</td><td>-</td></tr>
                            <tr><td>Rosental Organics</td><td><a class="account-link" href="https://banff.lightning.force.com/lightning/r/Account/0018V00002czgt7QAA/view" target="_blank">üîó</a></td><td class="number">$51.1M</td><td class="number">$963K</td><td class="number">7.03%</td><td class="number">$499,335</td><td class="number">$110,078</td><td class="number">$32,656</td><td class="pacing-medium">29.7%</td><td class="number">$91,696</td><td class="number">$0</td><td>-</td><td class="number">$121,396</td><td class="number">$0</td><td>-</td><td class="number">$176,165</td><td class="number">$0</td><td>-</td></tr>
                            <tr><td>Dieseo GmbH - Pummys‚Ñ¢</td><td><a class="account-link" href="https://banff.lightning.force.com/lightning/r/Account/0018V00002czAH5QAM/view" target="_blank">üîó</a></td><td class="number">$57.7M</td><td class="number">$868K</td><td class="number">5.75%</td><td class="number">$457,677</td><td class="number">$55,682</td><td class="number">$24,219</td><td class="pacing-high">43.5%</td><td class="number">$100,372</td><td class="number">$0</td><td>-</td><td class="number">$115,882</td><td class="number">$0</td><td>-</td><td class="number">$185,741</td><td class="number">$0</td><td>-</td></tr>
                            <tr><td>oace.shop</td><td><a class="account-link" href="https://banff.lightning.force.com/lightning/r/Account/0018V00002czhAxQAI/view" target="_blank">üîó</a></td><td class="number">$54.4M</td><td class="number">$783K</td><td class="number">7.93%</td><td class="number">$415,593</td><td class="number">$98,931</td><td class="number">$24,671</td><td class="pacing-low">24.9%</td><td class="number">$118,304</td><td class="number">$0</td><td>-</td><td class="number">$86,984</td><td class="number">$0</td><td>-</td><td class="number">$111,375</td><td class="number">$0</td><td>-</td></tr>
                            <tr><td>ahead-nutrition.com</td><td><a class="account-link" href="https://banff.lightning.force.com/lightning/r/Account/0018V00002cz4wLQAQ/view" target="_blank">üîó</a></td><td class="number">$48.7M</td><td class="number">$761K</td><td class="number">6.30%</td><td class="number">$401,695</td><td class="number">$71,573</td><td class="number">$23,646</td><td class="pacing-medium">33.0%</td><td class="number">$94,679</td><td class="number">$0</td><td>-</td><td class="number">$96,333</td><td class="number">$0</td><td>-</td><td class="number">$139,109</td><td class="number">$0</td><td>-</td></tr>
                            <tr><td>Karaca Deutschland GmbH</td><td><a class="account-link" href="https://banff.lightning.force.com/lightning/r/Account/0018V00002d0GBkQAM/view" target="_blank">üîó</a></td><td class="number">$43.5M</td><td class="number">$766K</td><td class="number">6.99%</td><td class="number">$392,838</td><td class="number">$81,047</td><td class="number">$22,685</td><td class="pacing-medium">28.0%</td><td class="number">$97,802</td><td class="number">$0</td><td>-</td><td class="number">$87,662</td><td class="number">$0</td><td>-</td><td class="number">$126,327</td><td class="number">$0</td><td>-</td></tr>
                            <tr><td>Vitafy GmbH</td><td><a class="account-link" href="https://banff.lightning.force.com/lightning/r/Account/0018V00002a7BcxQAE/view" target="_blank">üîó</a></td><td class="number">$30.6M</td><td class="number">$391K</td><td class="number">3.03%</td><td class="number">$392,508</td><td class="number">$15,728</td><td class="number">$39,140</td><td class="pacing-high">248.9% üî•</td><td class="number">$36,106</td><td class="number">$0</td><td>-</td><td class="number">$126,418</td><td class="number">$0</td><td>-</td><td class="number">$214,257</td><td class="number">$0</td><td>-</td></tr>
                            <tr><td>H√∂fer AcquiCo GmbH</td><td><a class="account-link" href="https://banff.lightning.force.com/lightning/r/Account/0018V00002qvIn8QAE/view" target="_blank">üîó</a></td><td class="number">$34.5M</td><td class="number">$379K</td><td class="number">4.13%</td><td class="number">$291,189</td><td class="number">$37,812</td><td class="number">$18,453</td><td class="pacing-high">48.8%</td><td class="number">$121,904</td><td class="number">$0</td><td>-</td><td class="number">$86,398</td><td class="number">$0</td><td>-</td><td class="number">$45,075</td><td class="number">$0</td><td>-</td></tr>
                            <tr><td>mymuesli AG</td><td><a class="account-link" href="https://banff.lightning.force.com/lightning/r/Account/001OG00000jN4oHYAS/view" target="_blank">üîó</a></td><td class="number">$17.1M</td><td class="number">$345K</td><td class="number">5.33%</td><td class="number">$287,185</td><td class="number">-$5,305</td><td class="number">$21,448</td><td class="pacing-high">N/A</td><td class="number">$7,011</td><td class="number">$0</td><td>-</td><td class="number">$57,768</td><td class="number">$0</td><td>-</td><td class="number">$227,711</td><td class="number">$0</td><td>-</td></tr>
                            <tr><td>Tennis Point GmbH</td><td><a class="account-link" href="https://banff.lightning.force.com/lightning/r/Account/0018V00002d0FStQAM/view" target="_blank">üîó</a></td><td class="number">$454</td><td class="number">$241K</td><td class="number">1.35%</td><td class="number">$240,957</td><td class="number">$59,504</td><td class="number">$19,725</td><td class="pacing-medium">33.1%</td><td class="number">$60,506</td><td class="number">$0</td><td>-</td><td class="number">$60,442</td><td class="number">$0</td><td>-</td><td class="number">$60,505</td><td class="number">$0</td><td>-</td></tr>
                            <tr><td>snuzone</td><td><a class="account-link" href="https://banff.lightning.force.com/lightning/r/Account/0018V00002czMMfQAM/view" target="_blank">üîó</a></td><td class="number">$42.9M</td><td class="number">$241K</td><td class="number">3.69%</td><td class="number">$231,362</td><td class="number">$59,169</td><td class="number">$19,854</td><td class="pacing-medium">33.6%</td><td class="number">$62,134</td><td class="number">$0</td><td>-</td><td class="number">$50,276</td><td class="number">$0</td><td>-</td><td class="number">$59,783</td><td class="number">$0</td><td>-</td></tr>
                            <tr><td>Sneakersnstuff Ab</td><td><a class="account-link" href="https://banff.lightning.force.com/lightning/r/Account/0018V00002a7BOXQA2/view" target="_blank">üîó</a></td><td class="number">$8.1M</td><td class="number">$179K</td><td class="number">2.86%</td><td class="number">$179,196</td><td class="number">-$12,809</td><td class="number">$17,325</td><td class="pacing-high">N/A</td><td class="number">$36,834</td><td class="number">$0</td><td>-</td><td class="number">$49,228</td><td class="number">$0</td><td>-</td><td class="number">$105,942</td><td class="number">$0</td><td>-</td></tr>
                            <tr><td>Blank's GmbH & Co. KG</td><td><a class="account-link" href="https://banff.lightning.force.com/lightning/r/Account/001OG00000wWBdFYAW/view" target="_blank">üîó</a></td><td class="number">$10.0M</td><td class="number">$109K</td><td class="number">4.02%</td><td class="number">$108,821</td><td class="number">$905</td><td class="number">$9,856</td><td class="pacing-high">1089.2% üî•</td><td class="number">$11,414</td><td class="number">$0</td><td>-</td><td class="number">$38,405</td><td class="number">$0</td><td>-</td><td class="number">$58,097</td><td class="number">$0</td><td>-</td></tr>
                            <tr><td>GastroHero GmbH</td><td><a class="account-link" href="https://banff.lightning.force.com/lightning/r/Account/0018V00002cz2QWQAY/view" target="_blank">üîó</a></td><td class="number">$7.9M</td><td class="number">$107K</td><td class="number">3.27%</td><td class="number">$106,854</td><td class="number">$12,792</td><td class="number">$10,848</td><td class="pacing-high">84.8%</td><td class="number">$24,718</td><td class="number">$0</td><td>-</td><td class="number">$37,542</td><td class="number">$0</td><td>-</td><td class="number">$31,803</td><td class="number">$0</td><td>-</td></tr>
                            <tr><td>Alfred K√§rcher</td><td><a class="account-link" href="https://banff.lightning.force.com/lightning/r/Account/0018V00002a7A0CQAU/view" target="_blank">üîó</a></td><td class="number">$11.5M</td><td class="number">$59K</td><td class="number">2.82%</td><td class="number">$58,608</td><td class="number">$14,349</td><td class="number">$8,235</td><td class="pacing-high">57.4%</td><td class="number">$12,079</td><td class="number">$0</td><td>-</td><td class="number">$7,978</td><td class="number">$0</td><td>-</td><td class="number">$24,202</td><td class="number">$0</td><td>-</td></tr>
                            <tr><td>Rebellion</td><td><a class="account-link" href="https://banff.lightning.force.com/lightning/r/Account/0018V00002lo8DLQAY/view" target="_blank">üîó</a></td><td class="number">$448K</td><td class="number">$42K</td><td class="number">3.38%</td><td class="number">$41,450</td><td class="number">$12,710</td><td class="number">$4,127</td><td class="pacing-medium">32.5%</td><td class="number">$10,009</td><td class="number">$0</td><td>-</td><td class="number">$9,054</td><td class="number">$0</td><td>-</td><td class="number">$9,677</td><td class="number">$0</td><td>-</td></tr>
                            <tr><td>Sportspar GmbH</td><td><a class="account-link" href="https://banff.lightning.force.com/lightning/r/Account/0018V00002czW9WQAU/view" target="_blank">üîó</a></td><td class="number">$23</td><td class="number">$28K</td><td class="number">1.36%</td><td class="number">$27,820</td><td class="number">$6,903</td><td class="number">$2,355</td><td class="pacing-medium">34.1%</td><td class="number">$6,956</td><td class="number">$0</td><td>-</td><td class="number">$6,968</td><td class="number">$0</td><td>-</td><td class="number">$6,993</td><td class="number">$0</td><td>-</td></tr>
                            <tr><td>REBO Landmaschinen GmbH</td><td><a class="account-link" href="https://banff.lightning.force.com/lightning/r/Account/0018V00002lHKFAQA4/view" target="_blank">üîó</a></td><td class="number">-</td><td class="number">$28K</td><td class="number">2.35%</td><td class="number">$27,681</td><td class="number">$6,843</td><td class="number">$2,342</td><td class="pacing-medium">34.2%</td><td class="number">$6,961</td><td class="number">$0</td><td>-</td><td class="number">$6,945</td><td class="number">$0</td><td>-</td><td class="number">$6,932</td><td class="number">$0</td><td>-</td></tr>
                            <tr><td>L. Stroetmann GmbH</td><td><a class="account-link" href="https://banff.lightning.force.com/lightning/r/Account/0018V00002nkJgpQAE/view" target="_blank">üîó</a></td><td class="number">-</td><td class="number">$28K</td><td class="number">2.33%</td><td class="number">$27,529</td><td class="number">$6,809</td><td class="number">$2,338</td><td class="pacing-medium">34.3%</td><td class="number">$6,852</td><td class="number">$0</td><td>-</td><td class="number">$6,935</td><td class="number">$0</td><td>-</td><td class="number">$6,933</td><td class="number">$0</td><td>-</td></tr>
                            <tr><td>Micasa (MGB Delica)</td><td><a class="account-link" href="https://banff.lightning.force.com/lightning/r/Account/0018V00002miXRHQA2/view" target="_blank">üîó</a></td><td class="number">$7.4M</td><td class="number">$22K</td><td class="number">1.98%</td><td class="number">$21,716</td><td class="number">$75</td><td class="number">$2,336</td><td class="pacing-high">3095.0% üî•</td><td class="number">$6,940</td><td class="number">$0</td><td>-</td><td class="number">$7,995</td><td class="number">$0</td><td>-</td><td class="number">$6,705</td><td class="number">$0</td><td>-</td></tr>
                            <tr><td>SCHIESSER GmbH</td><td><a class="account-link" href="https://banff.lightning.force.com/lightning/r/Account/0018V00002d0GK9QAM/view" target="_blank">üîó</a></td><td class="number">-</td><td class="number">$15K</td><td class="number">0.27%</td><td class="number">$14,718</td><td class="number">$0</td><td class="number">$2,340</td><td class="pacing-high">N/A</td><td class="number">$755</td><td class="number">$0</td><td>-</td><td class="number">$6,944</td><td class="number">$0</td><td>-</td><td class="number">$7,019</td><td class="number">$0</td><td>-</td></tr>
                            <tr><td>Rebike Mobility GmbH</td><td><a class="account-link" href="https://banff.lightning.force.com/lightning/r/Account/0018V00002nDcMsQAK/view" target="_blank">üîó</a></td><td class="number">$107K</td><td class="number">$13K</td><td class="number">0.19%</td><td class="number">$13,257</td><td class="number">$0</td><td class="number">$2,264</td><td class="pacing-high">N/A</td><td class="number">$0</td><td class="number">$0</td><td>-</td><td class="number">$5,435</td><td class="number">$0</td><td>-</td><td class="number">$7,822</td><td class="number">$0</td><td>-</td></tr>
                            <tr><td>BayWa AG</td><td><a class="account-link" href="https://banff.lightning.force.com/lightning/r/Account/0018V00002a7A0EQAU/view" target="_blank">üîó</a></td><td class="number">$203</td><td class="number">$3K</td><td class="number">0.18%</td><td class="number">$2,835</td><td class="number">$0</td><td class="number">$0</td><td>-</td><td class="number">$0</td><td class="number">$0</td><td>-</td><td class="number">-$4,109</td><td class="number">$0</td><td>-</td><td class="number">$6,944</td><td class="number">$0</td><td>-</td></tr>
                            <tr><td>Selsey</td><td><a class="account-link" href="https://banff.lightning.force.com/lightning/r/Account/001OG00000y990PYAQ/view" target="_blank">üîó</a></td><td class="number">$6.2K</td><td class="number">$371</td><td class="number">0.02%</td><td class="number">$371</td><td class="number">$0</td><td class="number">$2,340</td><td class="pacing-high">N/A</td><td class="number">-$13,652</td><td class="number">$0</td><td>-</td><td class="number">$6,956</td><td class="number">$0</td><td>-</td><td class="number">$7,068</td><td class="number">$0</td><td>-</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Take Rate Opportunities -->
            <section class="take-rate-section">
                <h2><span class="emoji">üìâ</span> Take Rate Optimization Opportunities</h2>
                <p class="section-description">Accounts with take rates below 4% have significant revenue growth potential through product enablement.</p>
                
                <div class="take-rate-chart">
                    <div class="chart-header">
                        <span>Take Rate Distribution</span>
                        <div class="chart-legend">
                            <span class="legend-item"><span class="legend-dot low"></span> < 3% (High Opportunity)</span>
                            <span class="legend-item"><span class="legend-dot medium"></span> 3-5%</span>
                            <span class="legend-item"><span class="legend-dot high"></span> > 5%</span>
                        </div>
                    </div>
                    <div class="bar-chart" id="take-rate-bars">
                        <div class="bar-row">
                            <span class="bar-label">Selsey</span>
                            <div class="bar-container"><div class="bar low" style="width: 0.4%"><span class="bar-value">0.02%</span></div></div>
                        </div>
                        <div class="bar-row">
                            <span class="bar-label">BayWa AG</span>
                            <div class="bar-container"><div class="bar low" style="width: 1.8%"><span class="bar-value">0.18%</span></div></div>
                        </div>
                        <div class="bar-row">
                            <span class="bar-label">Rebike Mobility</span>
                            <div class="bar-container"><div class="bar low" style="width: 1.9%"><span class="bar-value">0.19%</span></div></div>
                        </div>
                        <div class="bar-row">
                            <span class="bar-label">SCHIESSER GmbH</span>
                            <div class="bar-container"><div class="bar low" style="width: 2.7%"><span class="bar-value">0.27%</span></div></div>
                        </div>
                        <div class="bar-row">
                            <span class="bar-label">Tennis Point</span>
                            <div class="bar-container"><div class="bar low" style="width: 13.5%"><span class="bar-value">1.35%</span></div></div>
                        </div>
                        <div class="bar-row">
                            <span class="bar-label">Sportspar GmbH</span>
                            <div class="bar-container"><div class="bar low" style="width: 13.6%"><span class="bar-value">1.36%</span></div></div>
                        </div>
                        <div class="bar-row">
                            <span class="bar-label">Micasa</span>
                            <div class="bar-container"><div class="bar low" style="width: 19.8%"><span class="bar-value">1.98%</span></div></div>
                        </div>
                        <div class="bar-row">
                            <span class="bar-label">L. Stroetmann</span>
                            <div class="bar-container"><div class="bar low" style="width: 23.3%"><span class="bar-value">2.33%</span></div></div>
                        </div>
                        <div class="bar-row">
                            <span class="bar-label">REBO Landmasch.</span>
                            <div class="bar-container"><div class="bar low" style="width: 23.5%"><span class="bar-value">2.35%</span></div></div>
                        </div>
                        <div class="bar-row">
                            <span class="bar-label">Sneakersnstuff</span>
                            <div class="bar-container"><div class="bar low" style="width: 28.6%"><span class="bar-value">2.86%</span></div></div>
                        </div>
                    </div>
                </div>

                <div class="opportunities-table">
                    <h3>üéØ Product Enablement Recommendations</h3>
                    <p class="recommendation-note">üí° Installments: UK/US only | Capital: Germany only</p>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Account</th>
                                    <th>Country</th>
                                    <th>Current Take Rate</th>
                                    <th>L12M GMV</th>
                                    <th>Potential Products</th>
                                    <th>Est. Revenue Uplift</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><a class="account-link" href="https://banff.lightning.force.com/lightning/r/Account/001OG00000y990PYAQ/view" target="_blank">Selsey</a></td>
                                    <td>üáµüá± Poland</td>
                                    <td class="number pacing-low">0.02%</td>
                                    <td class="number">$6.2K</td>
                                    <td>
                                        <span class="product-tag payments">Shopify Payments</span>
                                        <span class="product-tag shipping">Shipping Labels</span>
                                    </td>
                                    <td class="number pacing-high">+$63K/yr</td>
                                </tr>
                                <tr>
                                    <td><a class="account-link" href="https://banff.lightning.force.com/lightning/r/Account/0018V00002a7A0EQAU/view" target="_blank">BayWa AG</a></td>
                                    <td>üá©üá™ Germany</td>
                                    <td class="number pacing-low">0.18%</td>
                                    <td class="number">$203</td>
                                    <td>
                                        <span class="product-tag payments">Shopify Payments</span>
                                        <span class="product-tag b2b">B2B</span>
                                        <span class="product-tag capital">Capital</span>
                                    </td>
                                    <td class="number pacing-high">+$61K/yr</td>
                                </tr>
                                <tr>
                                    <td><a class="account-link" href="https://banff.lightning.force.com/lightning/r/Account/0018V00002nDcMsQAK/view" target="_blank">Rebike Mobility GmbH</a></td>
                                    <td>üá©üá™ Germany</td>
                                    <td class="number pacing-low">0.19%</td>
                                    <td class="number">$107K</td>
                                    <td>
                                        <span class="product-tag payments">Shopify Payments</span>
                                        <span class="product-tag capital">Capital</span>
                                        <span class="product-tag pos">POS Pro</span>
                                    </td>
                                    <td class="number pacing-high">+$270K/yr</td>
                                </tr>
                                <tr>
                                    <td><a class="account-link" href="https://banff.lightning.force.com/lightning/r/Account/0018V00002d0GK9QAM/view" target="_blank">SCHIESSER GmbH</a></td>
                                    <td>üá©üá™ Germany</td>
                                    <td class="number pacing-low">0.27%</td>
                                    <td class="number">-</td>
                                    <td>
                                        <span class="product-tag payments">Shopify Payments</span>
                                        <span class="product-tag capital">Capital</span>
                                        <span class="product-tag pos">POS Pro</span>
                                    </td>
                                    <td class="number pacing-high">+$200K/yr</td>
                                </tr>
                                <tr>
                                    <td><a class="account-link" href="https://banff.lightning.force.com/lightning/r/Account/0018V00002d0FStQAM/view" target="_blank">Tennis Point GmbH</a></td>
                                    <td>üá©üá™ Germany</td>
                                    <td class="number pacing-low">1.35%</td>
                                    <td class="number">$454</td>
                                    <td>
                                        <span class="product-tag payments">Shopify Payments</span>
                                        <span class="product-tag capital">Capital</span>
                                        <span class="product-tag shipping">Shipping Labels</span>
                                    </td>
                                    <td class="number pacing-high">+$445K/yr</td>
                                </tr>
                                <tr>
                                    <td><a class="account-link" href="https://banff.lightning.force.com/lightning/r/Account/0018V00002czW9WQAU/view" target="_blank">Sportspar GmbH</a></td>
                                    <td>üá©üá™ Germany</td>
                                    <td class="number pacing-low">1.36%</td>
                                    <td class="number">$23</td>
                                    <td>
                                        <span class="product-tag payments">Shopify Payments</span>
                                        <span class="product-tag capital">Capital</span>
                                        <span class="product-tag shipping">Shipping Labels</span>
                                    </td>
                                    <td class="number pacing-high">+$53K/yr</td>
                                </tr>
                                <tr>
                                    <td><a class="account-link" href="https://banff.lightning.force.com/lightning/r/Account/0018V00002miXRHQA2/view" target="_blank">Micasa (MGB Delica)</a></td>
                                    <td>üá®üá≠ Switzerland</td>
                                    <td class="number pacing-low">1.98%</td>
                                    <td class="number">$1.1M</td>
                                    <td>
                                        <span class="product-tag payments">Shopify Payments</span>
                                        <span class="product-tag b2b">B2B</span>
                                    </td>
                                    <td class="number pacing-high">+$22K/yr</td>
                                </tr>
                                <tr>
                                    <td><a class="account-link" href="https://banff.lightning.force.com/lightning/r/Account/0018V00002nkJgpQAE/view" target="_blank">L. Stroetmann GmbH</a></td>
                                    <td>üá©üá™ Germany</td>
                                    <td class="number pacing-low">2.33%</td>
                                    <td class="number">$1.2M</td>
                                    <td>
                                        <span class="product-tag payments">Shopify Payments</span>
                                        <span class="product-tag b2b">B2B</span>
                                        <span class="product-tag capital">Capital</span>
                                    </td>
                                    <td class="number pacing-high">+$20K/yr</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="take-rate-summary">
                    <div class="summary-card">
                        <div class="summary-icon">üí∞</div>
                        <div class="summary-content">
                            <div class="summary-value">$1.13M</div>
                            <div class="summary-label">Total Potential Revenue Uplift</div>
                        </div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-icon">üìä</div>
                        <div class="summary-content">
                            <div class="summary-value">8</div>
                            <div class="summary-label">Accounts Below 3% Take Rate</div>
                        </div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-icon">üéØ</div>
                        <div class="summary-content">
                            <div class="summary-value">4.49%</div>
                            <div class="summary-label">Portfolio Avg Take Rate</div>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <footer>
        <p>üí∞ Incentive Compensation Tool | Data from Revenue MCP & BigQuery</p>
        <p style="margin-top: 0.5rem;">Q1 2026 data is Jan 1-15 only (~17% of quarter elapsed)</p>
    </footer>

    <script>
        // === LIVE BIGQUERY DATA FUNCTIONS ===
        
        let hasAuth = false;
        
        // Initialize and check BigQuery auth on page load
        async function initAuth() {
            try {
                const authResult = await quick.auth.requestScopes([
                    "https://www.googleapis.com/auth/bigquery",
                ]);
                hasAuth = authResult.hasRequiredScopes;
                
                if (hasAuth) {
                    showAuthStatus('‚úÖ Connected to BigQuery', 'success');
                    // Auto-populate name from user identity
                    if (quick.id && quick.id.fullName) {
                        document.getElementById('csm-name-input').value = quick.id.fullName;
                    }
                }
            } catch (e) {
                console.log('Auth check:', e);
            }
        }
        
        function showAuthStatus(message, type) {
            const el = document.getElementById('auth-status');
            el.style.display = 'block';
            el.textContent = message;
            el.style.background = type === 'success' ? 'rgba(0, 255, 136, 0.1)' : 'rgba(255, 71, 87, 0.1)';
            el.style.border = type === 'success' ? '1px solid var(--accent-green)' : '1px solid var(--accent-red)';
            el.style.color = type === 'success' ? 'var(--accent-green)' : 'var(--accent-red)';
        }
        
        function showError(message) {
            const el = document.getElementById('error-message');
            const textEl = document.getElementById('error-text');
            el.style.display = 'block';
            textEl.textContent = message;
        }
        
        function hideError() {
            document.getElementById('error-message').style.display = 'none';
        }
        
        // Main function to load live data from BigQuery
        async function loadLiveData() {
            const nameInput = document.getElementById('csm-name-input');
            const name = nameInput.value.trim();
            
            if (!name) {
                showError('Please enter your name');
                nameInput.focus();
                return;
            }
            
            hideError();
            
            // Request BigQuery auth if not already granted
            if (!hasAuth) {
                try {
                    const authResult = await quick.auth.requestScopes([
                        "https://www.googleapis.com/auth/bigquery",
                    ]);
                    if (!authResult.hasRequiredScopes) {
                        showError('BigQuery access required. Please grant permission when prompted.');
                        return;
                    }
                    hasAuth = true;
                } catch (e) {
                    showError('Failed to authenticate: ' + e.message);
                    return;
                }
            }
            
            // Show loading state
            document.getElementById('loading').classList.add('active');
            const loadBtn = document.getElementById('load-btn');
            loadBtn.textContent = '‚è≥ Loading...';
            loadBtn.disabled = true;
            
            try {
                // Debug: Log the name being searched
                console.log('üîç Searching for CSM:', name);
                showAuthStatus(`üîç Searching for: "${name}"`, 'success');
                
                // Query 1: Get accounts for this CSM from sales data
                // Filters: account_type = 'Customer' to exclude churned/prospects
                //          service_model != 'No Current Service Model' to get active CSM accounts
                //          Optionally exclude Mid-Market Scaled unless checkbox is checked
                const includeMidMarketScaled = document.getElementById('include-midmarket-scaled').checked;
                const midMarketFilter = includeMidMarketScaled ? '' : "AND sa.service_model != 'Mid-Market Scaled'";
                
                const accountsQuery = `
                    SELECT DISTINCT
                        sa.account_id,
                        sa.name AS account_name,
                        sa.account_url,
                        sa.merchant_success_manager,
                        sa.account_country_code,
                        sa.account_type,
                        sa.service_model,
                        m.shop_id
                    FROM \`shopify-dw.sales.sales_accounts\` sa
                    LEFT JOIN \`shopify-dw.sales.sales_unified_entity_mapping\` m
                        ON sa.account_id = m.salesforce_account_id
                    WHERE LOWER(sa.merchant_success_manager) LIKE '%${name.toLowerCase().split(' ').join('%')}%'
                    AND sa.account_type = 'Customer'
                    AND sa.service_model IS NOT NULL 
                    AND sa.service_model != 'No Current Service Model'
                    ${midMarketFilter}
                    AND m.shop_id IS NOT NULL
                `;
                
                const accountsResult = await quick.dw.querySync(accountsQuery);
                
                if (!accountsResult.results || accountsResult.results.length === 0) {
                    throw new Error(`No accounts found for "${name}". Make sure your name matches how it appears in Salesforce.`);
                }
                
                // Debug: Show account stats (note: results.length includes shop duplicates)
                const foundCSMs = [...new Set(accountsResult.results.map(r => r.merchant_success_manager))];
                const uniqueAccountIds = [...new Set(accountsResult.results.map(r => r.account_id))];
                console.log('üìã CSM:', foundCSMs.join(', '));
                console.log('üìä Distinct accounts:', uniqueAccountIds.length);
                console.log('üîó Total shop mappings:', accountsResult.results.length);
                
                const shopIds = accountsResult.results.map(r => r.shop_id).filter(Boolean);
                const accountMap = {};
                accountsResult.results.forEach(r => {
                    if (!accountMap[r.account_id]) {
                        accountMap[r.account_id] = {
                            name: r.account_name,
                            sfdc_url: r.account_url || `https://shopify.lightning.force.com/lightning/r/Account/${r.account_id}/view`,
                            country: r.account_country_code || 'US',
                            service_model: r.service_model || 'Unknown',
                            shop_ids: []
                        };
                    }
                    if (r.shop_id) accountMap[r.account_id].shop_ids.push(r.shop_id);
                });
                
                // Query 2: Get revenue data for these shops (includes all 2026 quarters)
                const revenueQuery = `
                    WITH shop_revenue AS (
                        SELECT 
                            shop_id,
                            SUM(CASE WHEN date >= DATE_SUB(CURRENT_DATE(), INTERVAL 365 DAY) THEN estimated_profit_usd ELSE 0 END) AS l12m_revenue,
                            SUM(CASE WHEN date BETWEEN '2025-01-01' AND '2025-03-31' THEN estimated_profit_usd ELSE 0 END) AS q1_2025,
                            SUM(CASE WHEN date BETWEEN '2025-04-01' AND '2025-06-30' THEN estimated_profit_usd ELSE 0 END) AS q2_2025,
                            SUM(CASE WHEN date BETWEEN '2025-07-01' AND '2025-09-30' THEN estimated_profit_usd ELSE 0 END) AS q3_2025,
                            SUM(CASE WHEN date BETWEEN '2025-10-01' AND '2025-12-31' THEN estimated_profit_usd ELSE 0 END) AS q4_2025,
                            SUM(CASE WHEN date BETWEEN '2026-01-01' AND '2026-03-31' THEN estimated_profit_usd ELSE 0 END) AS q1_2026,
                            SUM(CASE WHEN date BETWEEN '2026-04-01' AND '2026-06-30' THEN estimated_profit_usd ELSE 0 END) AS q2_2026,
                            SUM(CASE WHEN date BETWEEN '2026-07-01' AND '2026-09-30' THEN estimated_profit_usd ELSE 0 END) AS q3_2026,
                            SUM(CASE WHEN date BETWEEN '2026-10-01' AND '2026-12-31' THEN estimated_profit_usd ELSE 0 END) AS q4_2026
                        FROM \`shopify-dw.finance.shop_netsuite_account_daily_profit_summary\`
                        WHERE shop_id IN (${shopIds.join(',')})
                        AND account_type = 'Income'
                        AND date >= '2024-01-15'
                        GROUP BY shop_id
                    )
                    SELECT * FROM shop_revenue
                `;
                
                const revenueResult = await quick.dw.querySync(revenueQuery);
                
                // Query 3: Get GMV data
                const gmvQuery = `
                    SELECT 
                        shop_id,
                        SUM(gmv_usd) AS l12m_gmv
                    FROM \`shopify-dw.finance.shop_gmv_daily_summary\`
                    WHERE shop_id IN (${shopIds.join(',')})
                    AND date >= DATE_SUB(CURRENT_DATE(), INTERVAL 365 DAY)
                    GROUP BY shop_id
                `;
                
                const gmvResult = await quick.dw.querySync(gmvQuery);
                
                // Build revenue and GMV maps
                const revenueMap = {};
                let debugQ1_2026_Total = 0;
                (revenueResult.results || []).forEach(r => {
                    const q1_2026_val = parseFloat(r.q1_2026) || 0;
                    debugQ1_2026_Total += q1_2026_val;
                    revenueMap[r.shop_id] = {
                        l12m_revenue: parseFloat(r.l12m_revenue) || 0,
                        q1_2025: parseFloat(r.q1_2025) || 0,
                        q2_2025: parseFloat(r.q2_2025) || 0,
                        q3_2025: parseFloat(r.q3_2025) || 0,
                        q4_2025: parseFloat(r.q4_2025) || 0,
                        q1_2026: q1_2026_val,
                        q2_2026: parseFloat(r.q2_2026) || 0,
                        q3_2026: parseFloat(r.q3_2026) || 0,
                        q4_2026: parseFloat(r.q4_2026) || 0
                    };
                });
                console.log('üìä Revenue query returned', revenueResult.results?.length || 0, 'shops');
                console.log('üìä Total Q1 2026 from revenue query:', debugQ1_2026_Total);
                
                const gmvMap = {};
                (gmvResult.results || []).forEach(r => {
                    gmvMap[r.shop_id] = parseFloat(r.l12m_gmv) || 0;
                });
                
                // Aggregate data by account
                const accounts = [];
                let totalGmv = 0, totalRevenue = 0, total2025 = 0, totalQ1_2025 = 0;
                let totalQ1_2026 = 0, totalQ2_2026 = 0, totalQ3_2026 = 0, totalQ4_2026 = 0;
                
                Object.entries(accountMap).forEach(([accountId, account]) => {
                    let accGmv = 0, accRevenue = 0;
                    let accQ1_25 = 0, accQ2_25 = 0, accQ3_25 = 0, accQ4_25 = 0;
                    let accQ1_26 = 0, accQ2_26 = 0, accQ3_26 = 0, accQ4_26 = 0;
                    
                    account.shop_ids.forEach(shopId => {
                        accGmv += gmvMap[shopId] || 0;
                        const rev = revenueMap[shopId];
                        if (rev) {
                            accRevenue += rev.l12m_revenue || 0;
                            accQ1_25 += rev.q1_2025 || 0;
                            accQ2_25 += rev.q2_2025 || 0;
                            accQ3_25 += rev.q3_2025 || 0;
                            accQ4_25 += rev.q4_2025 || 0;
                            accQ1_26 += rev.q1_2026 || 0;
                            accQ2_26 += rev.q2_2026 || 0;
                            accQ3_26 += rev.q3_2026 || 0;
                            accQ4_26 += rev.q4_2026 || 0;
                        }
                    });
                    
                    const takeRate = accGmv > 0 ? (accRevenue / accGmv) * 100 : 0;
                    const acc2025 = accQ1_25 + accQ2_25 + accQ3_25 + accQ4_25;
                    
                    accounts.push({
                        name: account.name,
                        sfdc_url: account.sfdc_url,
                        service_model: account.service_model,
                        l12m_gmv: accGmv,
                        l12m_revenue: accRevenue,
                        take_rate: takeRate,
                        q1_2025: accQ1_25,
                        q2_2025: accQ2_25,
                        q3_2025: accQ3_25,
                        q4_2025: accQ4_25,
                        q1_2026: accQ1_26,
                        q2_2026: accQ2_26,
                        q3_2026: accQ3_26,
                        q4_2026: accQ4_26,
                        country: account.country
                    });
                    
                    totalGmv += accGmv;
                    totalRevenue += accRevenue;
                    total2025 += acc2025;
                    totalQ1_2025 += accQ1_25;
                    totalQ1_2026 += accQ1_26;
                    totalQ2_2026 += accQ2_26;
                    totalQ3_2026 += accQ3_26;
                    totalQ4_2026 += accQ4_26;
                });
                
                // Sort accounts by L12M revenue
                accounts.sort((a, b) => b.l12m_revenue - a.l12m_revenue);
                
                console.log('üìä After aggregation - Total Q1 2026:', totalQ1_2026);
                console.log('üìä Number of accounts:', accounts.length);
                
                // Get selected quarter's revenue
                const quarterTotals = {
                    'Q1-2026': totalQ1_2026,
                    'Q2-2026': totalQ2_2026,
                    'Q3-2026': totalQ3_2026,
                    'Q4-2026': totalQ4_2026
                };
                const selectedQuarterRevenue = quarterTotals[selectedQuarter] || totalQ1_2026;
                
                // Build final data object
                const data = {
                    csm_name: name,
                    generated_at: new Date().toISOString(),
                    data_source: 'live',
                    totals: {
                        account_count: accounts.length,
                        total_l12m_gmv: totalGmv,
                        total_l12m_revenue: totalRevenue,
                        total_2025_revenue: total2025,
                        avg_take_rate: totalGmv > 0 ? (totalRevenue / totalGmv) * 100 : 0
                    },
                    q1_comparison: {
                        q1_2025: totalQ1_2025,
                        q1_2026_ytd: totalQ1_2026,
                        pacing_rate: totalQ1_2025 > 0 ? (totalQ1_2026 / totalQ1_2025) * 100 : 0
                    },
                    quarter_totals: quarterTotals,
                    selected_quarter: selectedQuarter,
                    selected_quarter_ytd: selectedQuarterRevenue,
                    accounts: accounts
                };
                
                // Update dashboard
                updateDashboardFromGitHub(data);
                
                // Show live data indicator
                document.getElementById('current-csm-badge').style.display = 'flex';
                document.getElementById('current-csm-name').innerHTML = `<span style="color: var(--accent-green);">‚ö° LIVE</span> ${name}`;
                showAuthStatus(`‚úÖ Loaded ${accounts.length} accounts from BigQuery`, 'success');
                
            } catch (e) {
                console.error('Query error:', e);
                showError('Failed to load data: ' + e.message);
            } finally {
                document.getElementById('loading').classList.remove('active');
                loadBtn.textContent = '‚ö° Load Live Data';
                loadBtn.disabled = false;
            }
        }
        
        // Initialize auth on page load
        document.addEventListener('DOMContentLoaded', initAuth);


        function updateDashboardFromGitHub(data) {
            document.getElementById('loading').classList.remove('active');
            
            // Update header
            document.getElementById('current-csm-badge').style.display = 'flex';
            document.getElementById('current-csm-name').textContent = data.csm_name;
            
            // Update metrics
            if (data.totals) {
                document.getElementById('metric-accounts').textContent = data.totals.account_count || data.accounts.length;
                document.getElementById('metric-gmv').textContent = formatCurrency(data.totals.total_l12m_gmv, true);
                document.getElementById('metric-2025-rev').textContent = formatCurrency(data.totals.total_2025_revenue, true);
                document.getElementById('metric-take-rate').textContent = (data.totals.avg_take_rate || 0).toFixed(2) + '%';
            }
            
            // Update NRR tracker section with selected quarter
            const quarterRevenue = data.selected_quarter_ytd || data.q1_comparison?.q1_2026_ytd || 0;
            const config = quarterConfig[selectedQuarter];
            console.log(`üí∞ ${config.label} YTD Revenue:`, quarterRevenue, '‚Üí', formatCurrency(quarterRevenue, true));
            
            // Update YTD display
            const ytdElement = document.getElementById('q1-2026-ytd');
            if (ytdElement) {
                ytdElement.textContent = formatCurrency(quarterRevenue, true);
                console.log('‚úÖ Updated quarter YTD element');
            }
            
            // Update quarter elapsed note
            const elapsedPercent = getQuarterElapsedPercent(selectedQuarter);
            document.getElementById('quarter-progress-note').textContent = `~${Math.round(elapsedPercent * 100)}% of quarter elapsed`;
            
            // Set global variables for NRR tracker
            currentQuarterRevenue = quarterRevenue;
            
            // Update NRR tracker if target is set
            if (document.getElementById('nrr-target-input').value) {
                updateNRRTracker();
            }
            
            // Update table
            const tbody = document.getElementById('full-book');
            tbody.innerHTML = '';
            
            // Calculate totals
            let totals = {
                l12m_gmv: 0, l12m_revenue: 0, total_2025: 0,
                q1_2025: 0, q1_2026: 0, q2_2025: 0, q3_2025: 0, q4_2025: 0
            };
            
            data.accounts.forEach(account => {
                // Accumulate totals
                totals.l12m_gmv += account.l12m_gmv || 0;
                totals.l12m_revenue += account.l12m_revenue || 0;
                totals.q1_2025 += account.q1_2025 || 0;
                totals.q1_2026 += account.q1_2026 || 0;
                totals.q2_2025 += account.q2_2025 || 0;
                totals.q3_2025 += account.q3_2025 || 0;
                totals.q4_2025 += account.q4_2025 || 0;
                totals.total_2025 += (account.q1_2025 || 0) + (account.q2_2025 || 0) + (account.q3_2025 || 0) + (account.q4_2025 || 0);
                
                const q1Yoy = account.q1_2025 > 0 ? ((account.q1_2026 / account.q1_2025) * 100).toFixed(1) : 'N/A';
                const pacingClass = q1Yoy === 'N/A' ? '' : (parseFloat(q1Yoy) >= 40 ? 'pacing-high' : parseFloat(q1Yoy) >= 25 ? 'pacing-medium' : 'pacing-low');
                
                // Get short segment name
                const segmentShort = {
                    'Large Accounts': 'Large',
                    'Enterprise': 'Ent',
                    'Mid-Market Assigned': 'MM-A',
                    'Mid-Market Scaled': 'MM-S'
                }[account.service_model] || account.service_model;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${account.name}</td>
                    <td><a class="account-link" href="${account.sfdc_url}" target="_blank">üîó</a></td>
                    <td style="font-size: 0.8em; color: var(--text-secondary);">${segmentShort}</td>
                    <td class="number">${formatCurrency(account.l12m_gmv)}</td>
                    <td class="number">${formatCurrency(account.l12m_revenue)}</td>
                    <td class="number">${(account.take_rate || 0).toFixed(2)}%</td>
                    <td class="number">${formatCurrency((account.q1_2025 || 0) + (account.q2_2025 || 0) + (account.q3_2025 || 0) + (account.q4_2025 || 0))}</td>
                    <td class="number">${formatCurrency(account.q1_2025)}</td>
                    <td class="number">${formatCurrency(account.q1_2026)}</td>
                    <td class="${pacingClass}">${q1Yoy}${q1Yoy !== 'N/A' ? '%' : ''}</td>
                    <td class="number">${formatCurrency(account.q2_2025)}</td>
                    <td class="number">$0</td>
                    <td>-</td>
                    <td class="number">${formatCurrency(account.q3_2025)}</td>
                    <td class="number">$0</td>
                    <td>-</td>
                    <td class="number">${formatCurrency(account.q4_2025)}</td>
                    <td class="number">$0</td>
                    <td>-</td>
                `;
                tbody.appendChild(row);
            });
            
            // Add total row
            const totalQ1Yoy = totals.q1_2025 > 0 ? ((totals.q1_2026 / totals.q1_2025) * 100).toFixed(1) : 'N/A';
            const totalTakeRate = totals.l12m_gmv > 0 ? (totals.l12m_revenue / totals.l12m_gmv) * 100 : 0;
            const totalRow = document.createElement('tr');
            totalRow.style.cssText = 'background: var(--accent-blue); font-weight: 700; position: sticky; bottom: 0;';
            totalRow.innerHTML = `
                <td style="color: white;">üìä TOTAL (${data.accounts.length} accounts)</td>
                <td></td>
                <td></td>
                <td class="number" style="color: white;">${formatCurrency(totals.l12m_gmv, true)}</td>
                <td class="number" style="color: white;">${formatCurrency(totals.l12m_revenue, true)}</td>
                <td class="number" style="color: white;">${totalTakeRate.toFixed(2)}%</td>
                <td class="number" style="color: white;">${formatCurrency(totals.total_2025, true)}</td>
                <td class="number" style="color: white;">${formatCurrency(totals.q1_2025, true)}</td>
                <td class="number" style="color: #00ff88; font-size: 1.1em;">${formatCurrency(totals.q1_2026, true)}</td>
                <td style="color: white;">${totalQ1Yoy}%</td>
                <td class="number" style="color: white;">${formatCurrency(totals.q2_2025, true)}</td>
                <td class="number" style="color: white;">$0</td>
                <td style="color: white;">-</td>
                <td class="number" style="color: white;">${formatCurrency(totals.q3_2025, true)}</td>
                <td class="number" style="color: white;">$0</td>
                <td style="color: white;">-</td>
                <td class="number" style="color: white;">${formatCurrency(totals.q4_2025, true)}</td>
                <td class="number" style="color: white;">$0</td>
                <td style="color: white;">-</td>
            `;
            tbody.appendChild(totalRow);
            
            // Update Q1 Performance table (show ALL accounts)
            const q1Tbody = document.getElementById('all-accounts-q1');
            if (q1Tbody) {
                const sortedByQ1 = [...data.accounts].sort((a, b) => (b.q1_2026 || 0) - (a.q1_2026 || 0));
                q1Tbody.innerHTML = sortedByQ1.map(acc => {
                    const q1Yoy = acc.q1_2025 > 0 ? ((acc.q1_2026 / acc.q1_2025) * 100).toFixed(1) : 'N/A';
                    const pacingClass = q1Yoy === 'N/A' ? '' : (parseFloat(q1Yoy) >= 40 ? 'pacing-high' : parseFloat(q1Yoy) >= 25 ? 'pacing-medium' : 'pacing-low');
                    return `<tr>
                        <td>${acc.name}</td>
                        <td class="number">${formatCurrency(acc.q1_2025)}</td>
                        <td class="number">${formatCurrency(acc.q1_2026)}</td>
                        <td class="${pacingClass}">${q1Yoy}${q1Yoy !== 'N/A' ? '%' : ''}</td>
                    </tr>`;
                }).join('');
            }
            
            // Update Needs Attention table
            const needsAttentionTbody = document.getElementById('needs-attention');
            if (needsAttentionTbody) {
                const needsAttention = data.accounts.filter(acc => {
                    if (!acc.q1_2025 || acc.q1_2025 <= 0) return false;
                    const yoy = (acc.q1_2026 / acc.q1_2025) * 100;
                    return yoy < 25;
                }).sort((a, b) => {
                    const aYoy = a.q1_2025 > 0 ? (a.q1_2026 / a.q1_2025) : 0;
                    const bYoy = b.q1_2025 > 0 ? (b.q1_2026 / b.q1_2025) : 0;
                    return aYoy - bYoy;
                });
                
                needsAttentionTbody.innerHTML = needsAttention.slice(0, 10).map(acc => {
                    const q1Yoy = acc.q1_2025 > 0 ? ((acc.q1_2026 / acc.q1_2025) * 100).toFixed(1) : 'N/A';
                    return `<tr>
                        <td>${acc.name}</td>
                        <td class="number">${formatCurrency(acc.q1_2025)}</td>
                        <td class="number">${formatCurrency(acc.q1_2026)}</td>
                        <td class="pacing-low">${q1Yoy}%</td>
                    </tr>`;
                }).join('');
            }
            
            document.getElementById('report-content').scrollIntoView({ behavior: 'smooth' });
        }

        // Global variables for NRR tracker
        let currentQuarterRevenue = 0;
        let projectedQuarterRevenue = 0;
        let selectedQuarter = 'Q1-2026';
        
        // Quarter date ranges
        const quarterConfig = {
            'Q1-2026': { start: new Date('2026-01-01'), end: new Date('2026-03-31'), label: 'Q1 2026', short: 'Q1' },
            'Q2-2026': { start: new Date('2026-04-01'), end: new Date('2026-06-30'), label: 'Q2 2026', short: 'Q2' },
            'Q3-2026': { start: new Date('2026-07-01'), end: new Date('2026-09-30'), label: 'Q3 2026', short: 'Q3' },
            'Q4-2026': { start: new Date('2026-10-01'), end: new Date('2026-12-31'), label: 'Q4 2026', short: 'Q4' }
        };
        
        function getQuarterElapsedPercent(quarter) {
            const config = quarterConfig[quarter];
            const now = new Date();
            const start = config.start;
            const end = config.end;
            
            // If quarter hasn't started yet
            if (now < start) return 0;
            // If quarter has ended
            if (now > end) return 1;
            
            const totalDays = (end - start) / (1000 * 60 * 60 * 24);
            const elapsedDays = (now - start) / (1000 * 60 * 60 * 24);
            return elapsedDays / totalDays;
        }
        
        function onQuarterChange() {
            selectedQuarter = document.getElementById('quarter-selector').value;
            const config = quarterConfig[selectedQuarter];
            
            // Save quarter selection
            localStorage.setItem('selected_quarter', selectedQuarter);
            
            // Update labels
            document.getElementById('nrr-quarter-title').textContent = config.label;
            document.getElementById('quarter-ytd-label').textContent = config.label;
            document.getElementById('quarter-est-label').textContent = config.short;
            
            // Update quarter elapsed note
            const elapsedPercent = getQuarterElapsedPercent(selectedQuarter);
            document.getElementById('quarter-progress-note').textContent = `~${Math.round(elapsedPercent * 100)}% of quarter elapsed`;
            
            // Load saved target for this quarter
            loadSavedNRRTarget();
            
            // Reload data if we have a CSM name
            const csmName = document.getElementById('csm-name-input').value.trim();
            if (csmName) {
                loadLiveData();
            }
        }
        
        // NRR Target Tracker function
        function updateNRRTracker() {
            const targetInput = document.getElementById('nrr-target-input');
            const targetInM = parseFloat(targetInput.value) || 0;
            const target = targetInM * 1000000; // Convert from millions to dollars
            
            if (target <= 0) {
                document.getElementById('nrr-pacing').textContent = '-';
                document.getElementById('nrr-status').innerHTML = '';
                document.getElementById('nrr-progress-container').style.display = 'none';
                return;
            }
            
            // Show progress bar
            document.getElementById('nrr-progress-container').style.display = 'block';
            
            // Calculate pacing: if current pace continues, will we hit target?
            const quarterElapsedPercent = getQuarterElapsedPercent(selectedQuarter);
            const projected = quarterElapsedPercent > 0 ? currentQuarterRevenue / quarterElapsedPercent : 0;
            const pacingPercent = (projected / target) * 100;
            const progressPercent = Math.min((currentQuarterRevenue / target) * 100, 100);
            
            // Update pacing display
            document.getElementById('nrr-pacing').textContent = pacingPercent.toFixed(0) + '%';
            document.getElementById('nrr-progress-bar').style.width = progressPercent + '%';
            document.getElementById('nrr-current-display').textContent = formatCurrency(currentQuarterRevenue, true);
            document.getElementById('nrr-target-display').textContent = formatCurrency(target, true);
            
            // Update estimated Q1 total
            document.getElementById('nrr-projected').textContent = formatCurrency(projected, true);
            const projectedDiff = projected - target;
            const projectedNote = document.getElementById('nrr-projected-note');
            if (projectedDiff >= 0) {
                projectedNote.innerHTML = `<span style="color: var(--accent-green);">+${formatCurrency(projectedDiff, true)} over target</span>`;
            } else {
                projectedNote.innerHTML = `<span style="color: var(--accent-red);">${formatCurrency(projectedDiff, true)} under target</span>`;
            }
            
            // Status message and colors
            const statusEl = document.getElementById('nrr-status');
            const pacingEl = document.getElementById('nrr-pacing');
            const diff = projected - target;
            
            if (pacingPercent >= 100) {
                statusEl.innerHTML = `<span style="color: var(--accent-green);">‚úÖ On track</span>`;
                pacingEl.style.color = 'var(--accent-green)';
                document.getElementById('nrr-progress-bar').style.background = 'linear-gradient(90deg, var(--accent-green), #00ff88)';
            } else if (pacingPercent >= 80) {
                statusEl.innerHTML = `<span style="color: var(--accent-yellow);">‚ö° Close</span>`;
                pacingEl.style.color = 'var(--accent-yellow)';
                document.getElementById('nrr-progress-bar').style.background = 'linear-gradient(90deg, var(--accent-yellow), var(--accent-green))';
            } else {
                statusEl.innerHTML = `<span style="color: var(--accent-orange);">‚ö†Ô∏è Behind</span>`;
                pacingEl.style.color = 'var(--accent-orange)';
                document.getElementById('nrr-progress-bar').style.background = 'linear-gradient(90deg, var(--accent-orange), var(--accent-yellow))';
            }
            
            // Save target to localStorage for persistence (save in M, per quarter)
            localStorage.setItem('nrr_target_' + selectedQuarter, targetInM);
        }
        
        // Load saved NRR target for selected quarter
        function loadSavedNRRTarget() {
            const savedTarget = localStorage.getItem('nrr_target_' + selectedQuarter);
            document.getElementById('nrr-target-input').value = savedTarget || '';
            
            // Update display if we have data
            if (savedTarget && currentQuarterRevenue > 0) {
                updateNRRTracker();
            }
        }

        // Initialize on page load
        window.onload = function() {
            document.getElementById('current-csm-badge').style.display = 'flex';
            document.getElementById('current-csm-name').textContent = 'Enter your name above';
            document.getElementById('report-content').classList.add('active');
            
            // Load saved quarter selection
            const savedQuarter = localStorage.getItem('selected_quarter') || 'Q1-2026';
            selectedQuarter = savedQuarter;
            document.getElementById('quarter-selector').value = savedQuarter;
            
            // Update UI labels for selected quarter
            const config = quarterConfig[selectedQuarter];
            document.getElementById('nrr-quarter-title').textContent = config.label;
            document.getElementById('quarter-ytd-label').textContent = config.label;
            document.getElementById('quarter-est-label').textContent = config.short;
            
            // Update quarter elapsed note
            const elapsedPercent = getQuarterElapsedPercent(selectedQuarter);
            document.getElementById('quarter-progress-note').textContent = `~${Math.round(elapsedPercent * 100)}% of quarter elapsed`;
            
            // Load saved target for this quarter
            loadSavedNRRTarget();
        };


        function updateDashboardWithData(data) {
            // Update the main book of business table
            const tbody = document.getElementById('full-book');
            tbody.innerHTML = '';
            
            data.accounts.forEach(account => {
                const q1Yoy = account.q1_2025 > 0 ? ((account.q1_2026 / account.q1_2025) * 100).toFixed(1) : 'N/A';
                const pacingClass = q1Yoy === 'N/A' ? '' : (parseFloat(q1Yoy) >= 40 ? 'pacing-high' : parseFloat(q1Yoy) >= 25 ? 'pacing-medium' : 'pacing-low');
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${account.name}</td>
                    <td><a class="account-link" href="${account.sfdc_url}" target="_blank">üîó</a></td>
                    <td class="number">${formatCurrency(account.l12m_gmv)}</td>
                    <td class="number">${formatCurrency(account.l12m_revenue)}</td>
                    <td class="number">${account.take_rate.toFixed(2)}%</td>
                    <td class="number">${formatCurrency(account.q1_2025 + account.q2_2025 + account.q3_2025 + account.q4_2025)}</td>
                    <td class="number">${formatCurrency(account.q1_2025)}</td>
                    <td class="number">${formatCurrency(account.q1_2026)}</td>
                    <td class="${pacingClass}">${q1Yoy}${q1Yoy !== 'N/A' ? '%' : ''}</td>
                    <td class="number">${formatCurrency(account.q2_2025)}</td>
                    <td class="number">$0</td>
                    <td>-</td>
                    <td class="number">${formatCurrency(account.q3_2025)}</td>
                    <td class="number">$0</td>
                    <td>-</td>
                    <td class="number">${formatCurrency(account.q4_2025)}</td>
                    <td class="number">$0</td>
                    <td>-</td>
                `;
                tbody.appendChild(row);
            });
        }

        // formatCurrency is defined below - removed duplicate
        
        function updateDashboard(data) {
            const metrics = data.portfolio_metrics;
            const accounts = data.accounts;
            
            // Update top metrics
            document.getElementById('metric-accounts').textContent = metrics.total_accounts;
            document.getElementById('metric-2025-rev').textContent = formatCurrency(metrics.total_2025_revenue, true);
            document.getElementById('metric-gmv').textContent = formatCurrency(metrics.total_l12m_gmv, true);
            document.getElementById('metric-take-rate').textContent = metrics.avg_take_rate.toFixed(2) + '%';
            
            // Update YoY comparison
            updateYoYComparison(metrics);
            
            // Update quarterly performance
            updateQuarterlyPerformance(metrics);
            
            // Update all accounts Q1 table
            updateAllAccountsQ1(accounts);
            
            // Update needs attention table
            updateNeedsAttention(accounts);
            
            // Update full book of business table
            updateFullBook(accounts);
            
            // Update take rate opportunities
            updateTakeRateOpportunities(accounts);
        }
        
        function formatCurrency(value, short = false) {
            if (short) {
                if (value >= 1000000000) return '$' + (value / 1000000000).toFixed(2) + 'B';
                if (value >= 1000000) return '$' + (value / 1000000).toFixed(2) + 'M';
                if (value >= 1000) return '$' + (value / 1000).toFixed(0) + 'K';
            }
            return '$' + value.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
        }
        
        function formatPercent(value) {
            if (value === null || value === undefined) return 'N/A';
            return value.toFixed(1) + '%';
        }
        
        function getPacingClass(value) {
            if (value === null || value === undefined) return '';
            if (value > 40) return 'pacing-high';
            if (value >= 25) return 'pacing-medium';
            return 'pacing-low';
        }
        
        function updateYoYComparison(metrics) {
            // Update YoY comparison card values
            const q1_2025_el = document.querySelector('.yoy-metric-value.previous');
            const q1_2026_el = document.querySelector('.yoy-metric-value.current');
            const pacing_el = document.querySelector('.yoy-metric-value.pacing-value');
            const projected_el = document.querySelector('.yoy-projected strong');
            
            if (q1_2025_el) q1_2025_el.textContent = formatCurrency(metrics.q1_2025_total, true);
            if (q1_2026_el) q1_2026_el.textContent = formatCurrency(metrics.q1_2026_total, true);
            if (pacing_el) pacing_el.textContent = formatPercent(metrics.portfolio_q1_yoy_pacing);
            if (projected_el) projected_el.textContent = formatCurrency(metrics.q1_2026_total * 6, true);
        }
        
        function updateQuarterlyPerformance(metrics) {
            // This would update the quarterly grid - for now we'll keep the static values
            // A full implementation would rebuild the quarterly cards dynamically
        }
        
        function updateAllAccountsQ1(accounts) {
            const tbody = document.getElementById('all-accounts-q1');
            if (!tbody) return;
            
            // Sort by Q1 2026 revenue
            const sorted = [...accounts].sort((a, b) => b.q1_2026 - a.q1_2026);
            
            tbody.innerHTML = sorted.map(acc => `
                <tr>
                    <td>${acc.account_name}</td>
                    <td class="number">${formatCurrency(acc.q1_2025)}</td>
                    <td class="number">${formatCurrency(acc.q1_2026)}</td>
                    <td class="${getPacingClass(acc.q1_yoy_pacing)}">${formatPercent(acc.q1_yoy_pacing)}${acc.q1_yoy_pacing > 100 ? ' üî•' : ''}</td>
                </tr>
            `).join('');
        }
        
        function updateNeedsAttention(accounts) {
            const tbody = document.getElementById('needs-attention');
            if (!tbody) return;
            
            // Filter to accounts with pacing < 25%
            const needsAttention = accounts
                .filter(acc => acc.q1_yoy_pacing !== null && acc.q1_yoy_pacing < 25)
                .sort((a, b) => a.q1_yoy_pacing - b.q1_yoy_pacing);
            
            tbody.innerHTML = needsAttention.map(acc => `
                <tr>
                    <td>${acc.account_name}</td>
                    <td class="number">${formatCurrency(acc.q1_2025)}</td>
                    <td class="number">${formatCurrency(acc.q1_2026)}</td>
                    <td class="pacing-low">${formatPercent(acc.q1_yoy_pacing)}</td>
                </tr>
            `).join('');
        }
        
        function updateFullBook(accounts) {
            const tbody = document.getElementById('full-book');
            if (!tbody) return;
            
            tbody.innerHTML = accounts.map(acc => `
                <tr>
                    <td>${acc.account_name}</td>
                    <td><a class="account-link" href="${acc.salesforce_url}" target="_blank">üîó</a></td>
                    <td class="number">${formatCurrency(acc.l12m_gmv, true)}</td>
                    <td class="number">${formatCurrency(acc.l12m_revenue, true)}</td>
                    <td class="number">${acc.take_rate.toFixed(2)}%</td>
                    <td class="number">${formatCurrency(acc.total_2025)}</td>
                    <td class="number">${formatCurrency(acc.q1_2025)}</td>
                    <td class="number">${formatCurrency(acc.q1_2026)}</td>
                    <td class="${getPacingClass(acc.q1_yoy_pacing)}">${formatPercent(acc.q1_yoy_pacing)}</td>
                    <td class="number">${formatCurrency(acc.q2_2025)}</td>
                    <td class="number">$0</td>
                    <td>-</td>
                    <td class="number">${formatCurrency(acc.q3_2025)}</td>
                    <td class="number">$0</td>
                    <td>-</td>
                    <td class="number">${formatCurrency(acc.q4_2025)}</td>
                    <td class="number">$0</td>
                    <td>-</td>
                </tr>
            `).join('');
            
            // Update filter count
            document.getElementById('filter-count').textContent = `Showing ${accounts.length} accounts`;
        }
        
        function updateTakeRateOpportunities(accounts) {
            // Filter accounts with take rate < 3%
            const lowTakeRate = accounts
                .filter(acc => acc.take_rate < 3)
                .sort((a, b) => a.take_rate - b.take_rate);
            
            // Update the bar chart and recommendations table would go here
            // For now, the static content serves as an example
        }


        // Filter functionality for Book of Business table
        function filterTable() {
            const searchText = document.getElementById('account-search').value.toLowerCase();
            const pacingFilter = document.getElementById('pacing-filter').value;
            const revenueFilter = document.getElementById('revenue-filter').value;
            
            const table = document.getElementById('full-book');
            const rows = table.getElementsByTagName('tr');
            let visibleCount = 0;
            
            for (let i = 0; i < rows.length; i++) {
                const row = rows[i];
                const cells = row.getElementsByTagName('td');
                
                // Skip summary rows
                if (cells.length < 5) {
                    continue;
                }
                
                const accountName = cells[0].textContent.toLowerCase();
                const revenue2025Text = cells[5].textContent.replace(/[$,]/g, '');
                const revenue2025 = parseFloat(revenue2025Text) || 0;
                const yoyPacingCell = cells[8].textContent;
                
                // Parse YoY pacing
                let pacingValue = 0;
                let pacingCategory = 'na';
                if (yoyPacingCell && yoyPacingCell !== '-' && yoyPacingCell !== 'N/A') {
                    pacingValue = parseFloat(yoyPacingCell.replace('%', '').replace('üî•', '').trim());
                    if (pacingValue > 40) pacingCategory = 'high';
                    else if (pacingValue >= 25) pacingCategory = 'medium';
                    else pacingCategory = 'low';
                }
                
                // Apply filters
                let showRow = true;
                
                // Search filter
                if (searchText && !accountName.includes(searchText)) {
                    showRow = false;
                }
                
                // Pacing filter
                if (pacingFilter !== 'all') {
                    if (pacingFilter === 'high' && pacingCategory !== 'high') showRow = false;
                    if (pacingFilter === 'medium' && pacingCategory !== 'medium') showRow = false;
                    if (pacingFilter === 'low' && pacingCategory !== 'low') showRow = false;
                }
                
                // Revenue filter
                if (revenueFilter !== 'all') {
                    if (revenueFilter === '1m' && revenue2025 < 1000000) showRow = false;
                    if (revenueFilter === '500k' && (revenue2025 < 500000 || revenue2025 >= 1000000)) showRow = false;
                    if (revenueFilter === '100k' && (revenue2025 < 100000 || revenue2025 >= 500000)) showRow = false;
                    if (revenueFilter === 'under100k' && revenue2025 >= 100000) showRow = false;
                }
                
                if (showRow) {
                    row.classList.remove('hidden');
                    visibleCount++;
                } else {
                    row.classList.add('hidden');
                }
            }
            
            // Update count
            document.getElementById('filter-count').textContent = `Showing ${visibleCount} accounts`;
        }
        
        function clearFilters() {
            document.getElementById('account-search').value = '';
            document.getElementById('pacing-filter').value = 'all';
            document.getElementById('revenue-filter').value = 'all';
            filterTable();
        }

        // Sorting functionality
        let currentSortCol = -1;
        let currentSortDir = 'none';

        function sortTable(colIndex, type) {
            const table = document.getElementById('book-table');
            const tbody = document.getElementById('full-book');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            const headers = table.querySelectorAll('th.sortable');
            
            // Determine sort direction
            if (currentSortCol === colIndex) {
                currentSortDir = currentSortDir === 'asc' ? 'desc' : 'asc';
            } else {
                currentSortDir = 'desc'; // Default to descending for numbers
                if (type === 'string') currentSortDir = 'asc';
            }
            currentSortCol = colIndex;
            
            // Update header styles
            headers.forEach(h => {
                h.classList.remove('asc', 'desc');
            });
            const currentHeader = table.querySelector(`th[data-col="${colIndex}"]`);
            if (currentHeader) {
                currentHeader.classList.add(currentSortDir);
            }
            
            // Sort rows
            rows.sort((a, b) => {
                const cellA = a.cells[colIndex];
                const cellB = b.cells[colIndex];
                
                if (!cellA || !cellB) return 0;
                
                let valA = cellA.textContent.trim();
                let valB = cellB.textContent.trim();
                
                // Parse based on type
                if (type === 'currency') {
                    valA = parseFloat(valA.replace(/[$,KM]/g, '')) || 0;
                    valB = parseFloat(valB.replace(/[$,KM]/g, '')) || 0;
                    // Handle K and M suffixes
                    if (cellA.textContent.includes('K')) valA *= 1000;
                    if (cellA.textContent.includes('M')) valA *= 1000000;
                    if (cellB.textContent.includes('K')) valB *= 1000;
                    if (cellB.textContent.includes('M')) valB *= 1000000;
                } else if (type === 'percent') {
                    valA = parseFloat(valA.replace(/[%üî•]/g, '')) || -999;
                    valB = parseFloat(valB.replace(/[%üî•]/g, '')) || -999;
                    if (valA === -999 || cellA.textContent === '-' || cellA.textContent === 'N/A') valA = -999;
                    if (valB === -999 || cellB.textContent === '-' || cellB.textContent === 'N/A') valB = -999;
                }
                
                // Compare
                let comparison = 0;
                if (type === 'string') {
                    comparison = valA.localeCompare(valB);
                } else {
                    comparison = valA - valB;
                }
                
                return currentSortDir === 'asc' ? comparison : -comparison;
            });
            
            // Re-append sorted rows
            rows.forEach(row => tbody.appendChild(row));
        }
    </script>
</body>
</html>
