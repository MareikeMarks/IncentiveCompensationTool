<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Incentive Compensation Tool | Book of Business</title>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <!-- Quick.js for BigQuery access -->
    <script src="/client/quick.js"></script>
    <style>
        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-card: #1a1a24;
            --accent-green: #00ff88;
            --accent-blue: #00d4ff;
            --accent-purple: #a855f7;
            --accent-red: #ff4757;
            --accent-yellow: #ffd93d;
            --accent-orange: #ff9f43;
            --text-primary: #ffffff;
            --text-secondary: #a0a0b0;
            --border: #2a2a3a;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Space Grotesk', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            background-image: 
                radial-gradient(circle at 20% 80%, rgba(0, 255, 136, 0.05) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(0, 212, 255, 0.05) 0%, transparent 50%);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        header {
            background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-card) 100%);
            border-bottom: 1px solid var(--border);
            padding: 1.5rem 0;
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo {
            font-size: 2rem;
        }

        h1 {
            font-size: 1.75rem;
            font-weight: 700;
            background: linear-gradient(90deg, var(--accent-green), var(--accent-blue));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        /* CSM Selector */
        .csm-selector {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 2rem;
            margin: 2rem 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1.5rem;
        }

        .csm-selector h2 {
            font-size: 1.25rem;
            color: var(--text-primary);
        }

        /* Step Container */
        .step-container {
            width: 100%;
            max-width: 700px;
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
        }

        .step-container.hidden {
            display: none;
        }

        .step-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .step-badge {
            width: 28px;
            height: 28px;
            background: var(--accent-purple);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.875rem;
        }

        .step-title {
            font-weight: 600;
            color: var(--text-primary);
        }

        .step-hint {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: 0.75rem;
            text-align: center;
        }

        /* Prompt Box */
        .prompt-box {
            background: #1a1a2e;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
            position: relative;
        }

        .prompt-box pre {
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.75rem;
            color: #a8dadc;
            white-space: pre-wrap;
            word-break: break-word;
            max-height: 200px;
            overflow-y: auto;
            margin: 0;
        }

        .copy-btn {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: var(--accent-purple);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 0.4rem 0.75rem;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .copy-btn:hover {
            background: var(--accent-blue);
            transform: scale(1.02);
        }

        .copy-btn.copied {
            background: var(--accent-green);
        }

        /* JSON Textarea */
        .json-textarea {
            width: 100%;
            min-height: 150px;
            background: #1a1a2e;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
            color: var(--text-primary);
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.8rem;
            resize: vertical;
            margin-bottom: 1rem;
        }

        .json-textarea::placeholder {
            color: var(--text-secondary);
            opacity: 0.6;
        }

        .json-textarea:focus {
            outline: none;
            border-color: var(--accent-purple);
        }

        /* Reset Button */
        .reset-btn {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-secondary);
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
        }

        .reset-btn:hover {
            border-color: var(--accent-purple);
            color: var(--text-primary);
        }

        .reset-btn.hidden {
            display: none;
        }

        /* Google Sign-in */
        .google-signin-btn {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            background: white;
            color: #1f1f1f;
            border: 1px solid #dadce0;
            border-radius: 8px;
            padding: 0.75rem 1.5rem;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .google-signin-btn:hover {
            background: #f8f9fa;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        /* User Info */
        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
            padding: 1rem;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
        }

        .user-avatar {
            width: 48px;
            height: 48px;
            background: var(--accent-purple);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .user-name {
            font-weight: 600;
            color: var(--text-primary);
        }

        .user-email {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .signout-btn {
            margin-top: 0.75rem;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 0.8rem;
            cursor: pointer;
            text-decoration: underline;
        }

        .signout-btn:hover {
            color: var(--text-primary);
        }

        #user-section.hidden {
            display: none;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .input-group {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            justify-content: center;
            width: 100%;
            max-width: 600px;
        }

        .csm-input {
            flex: 1;
            min-width: 250px;
            padding: 1rem 1.5rem;
            font-size: 1rem;
            font-family: 'Space Grotesk', sans-serif;
            background: var(--bg-secondary);
            border: 2px solid var(--border);
            border-radius: 12px;
            color: var(--text-primary);
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .csm-input:focus {
            outline: none;
            border-color: var(--accent-green);
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.2);
        }

        .csm-input::placeholder {
            color: var(--text-secondary);
        }

        .load-btn {
            padding: 1rem 2rem;
            font-size: 1rem;
            font-family: 'Space Grotesk', sans-serif;
            font-weight: 600;
            background: linear-gradient(135deg, var(--accent-green), var(--accent-blue));
            border: none;
            border-radius: 12px;
            color: var(--bg-primary);
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .load-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(0, 255, 136, 0.3);
        }

        .load-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Current CSM Badge */
        .current-csm {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            background: var(--bg-card);
            border: 1px solid var(--accent-green);
            padding: 0.5rem 1rem;
            border-radius: 2rem;
        }

        .current-csm-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .current-csm-name {
            font-weight: 600;
            color: var(--accent-green);
        }

        /* Metrics */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .metric-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.25rem;
            transition: transform 0.2s, border-color 0.2s;
        }

        .metric-card:hover {
            transform: translateY(-2px);
            border-color: var(--accent-blue);
        }

        .metric-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .metric-value {
            font-size: 1.5rem;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
        }

        .metric-value.green { color: var(--accent-green); }
        .metric-value.blue { color: var(--accent-blue); }
        .metric-value.purple { color: var(--accent-purple); }
        .metric-value.yellow { color: var(--accent-yellow); }
        .metric-value.orange { color: var(--accent-orange); }

        /* YoY Comparison Card */
        .yoy-comparison-card {
            background: linear-gradient(135deg, var(--bg-card) 0%, rgba(0, 212, 255, 0.1) 100%);
            border: 1px solid var(--accent-blue);
            border-radius: 12px;
            padding: 1.25rem;
            margin-bottom: 2rem;
        }

        .yoy-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .yoy-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .yoy-note {
            font-size: 0.7rem;
            color: var(--text-secondary);
            background: var(--bg-secondary);
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
        }

        .yoy-metrics {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .yoy-metric {
            text-align: center;
            flex: 1;
            min-width: 120px;
        }

        .yoy-metric.pacing {
            background: var(--bg-secondary);
            padding: 1rem;
            border-radius: 8px;
            flex: 1.5;
        }

        .yoy-metric-label {
            font-size: 0.7rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.25rem;
        }

        .yoy-metric-value {
            font-size: 1.75rem;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
        }

        .yoy-metric-value.previous {
            color: var(--text-secondary);
        }

        .yoy-metric-value.current {
            color: var(--accent-purple);
        }

        .yoy-metric-value.pacing-value {
            color: var(--accent-yellow);
        }

        .yoy-arrow {
            font-size: 1.5rem;
            color: var(--accent-blue);
            flex-shrink: 0;
        }

        .yoy-projected {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 0.5rem;
        }

        .yoy-projected strong {
            color: var(--accent-green);
        }

        /* Sections */
        section {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        h2 {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        h2 .emoji {
            font-size: 1.25rem;
        }

        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.8rem;
        }

        th, td {
            padding: 0.625rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        th {
            background: var(--bg-secondary);
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            font-size: 0.7rem;
            letter-spacing: 0.05em;
            position: sticky;
            top: 0;
        }

        tr:hover {
            background: rgba(0, 255, 136, 0.05);
        }

        .account-link {
            color: var(--accent-blue);
            text-decoration: none;
            font-weight: 500;
        }

        .account-link:hover {
            text-decoration: underline;
        }

        .pacing-high { color: var(--accent-green); font-weight: 600; }
        .pacing-medium { color: var(--accent-yellow); font-weight: 600; }
        .pacing-low { color: var(--accent-red); font-weight: 600; }

        .table-container {
            overflow-x: auto;
            max-height: 500px;
            overflow-y: auto;
        }

        .number {
            font-family: 'JetBrains Mono', monospace;
        }

        /* Quarterly Cards */
        .quarterly-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
        }

        .quarter-card {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
        }

        .quarter-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.75rem;
        }

        .quarter-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            font-weight: 600;
        }

        .quarter-values {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .quarter-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .year-label {
            font-size: 0.7rem;
            color: var(--text-secondary);
        }

        .quarter-value {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 600;
            font-size: 0.875rem;
        }

        .yoy-badge {
            font-size: 0.7rem;
            padding: 0.125rem 0.375rem;
            border-radius: 4px;
            font-weight: 600;
        }

        .yoy-positive {
            background: rgba(0, 255, 136, 0.2);
            color: var(--accent-green);
        }

        .yoy-negative {
            background: rgba(255, 71, 87, 0.2);
            color: var(--accent-red);
        }

        .yoy-neutral {
            background: rgba(160, 160, 176, 0.2);
            color: var(--text-secondary);
        }

        /* Loading State */
        .loading {
            display: none;
            text-align: center;
            padding: 3rem;
            color: var(--text-secondary);
        }

        .loading.active {
            display: block;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border);
            border-top-color: var(--accent-green);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Report Content - always visible */
        #report-content {
            display: block;
        }

        /* Take Rate Section */
        .take-rate-section {
            background: linear-gradient(135deg, var(--bg-card) 0%, rgba(168, 85, 247, 0.1) 100%);
            border: 1px solid var(--accent-purple);
        }

        .section-description {
            color: var(--text-secondary);
            font-size: 0.875rem;
            margin-bottom: 1.5rem;
        }

        .take-rate-chart {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .chart-header span {
            font-weight: 600;
            color: var(--text-primary);
        }

        .chart-legend {
            display: flex;
            gap: 1rem;
            font-size: 0.75rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            color: var(--text-secondary);
        }

        .legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 2px;
        }

        .legend-dot.low { background: var(--accent-red); }
        .legend-dot.medium { background: var(--accent-yellow); }
        .legend-dot.high { background: var(--accent-green); }

        .bar-chart {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .bar-row {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .bar-label {
            width: 120px;
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-align: right;
            flex-shrink: 0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .bar-container {
            flex: 1;
            height: 24px;
            background: var(--bg-card);
            border-radius: 4px;
            overflow: hidden;
        }

        .bar {
            height: 100%;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 0.5rem;
            min-width: 60px;
            transition: width 0.5s ease;
        }

        .bar.low { background: linear-gradient(90deg, var(--accent-red), #ff6b7a); }
        .bar.medium { background: linear-gradient(90deg, var(--accent-yellow), #ffe066); }
        .bar.high { background: linear-gradient(90deg, var(--accent-green), #66ffaa); }

        .bar-value {
            font-size: 0.7rem;
            font-family: 'JetBrains Mono', monospace;
            font-weight: 600;
            color: var(--bg-primary);
        }

        .opportunities-table h3 {
            font-size: 1rem;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .recommendation-note {
            font-size: 0.75rem;
            color: var(--accent-yellow);
            margin-bottom: 1rem;
            padding: 0.5rem;
            background: rgba(255, 217, 61, 0.1);
            border-radius: 4px;
            border-left: 3px solid var(--accent-yellow);
        }

        .product-tag {
            display: inline-block;
            padding: 0.125rem 0.5rem;
            border-radius: 4px;
            font-size: 0.65rem;
            font-weight: 600;
            margin: 0.125rem;
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }

        .product-tag.payments {
            background: rgba(0, 212, 255, 0.2);
            color: var(--accent-blue);
            border: 1px solid var(--accent-blue);
        }

        .product-tag.installments {
            background: rgba(168, 85, 247, 0.2);
            color: var(--accent-purple);
            border: 1px solid var(--accent-purple);
        }

        .product-tag.capital {
            background: rgba(0, 255, 136, 0.2);
            color: var(--accent-green);
            border: 1px solid var(--accent-green);
        }

        .product-tag.shipping {
            background: rgba(255, 159, 67, 0.2);
            color: var(--accent-orange);
            border: 1px solid var(--accent-orange);
        }

        .product-tag.pos {
            background: rgba(255, 71, 87, 0.2);
            color: var(--accent-red);
            border: 1px solid var(--accent-red);
        }

        .product-tag.b2b {
            background: rgba(255, 217, 61, 0.2);
            color: var(--accent-yellow);
            border: 1px solid var(--accent-yellow);
        }

        .product-tag.markets {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
            border: 1px solid var(--text-secondary);
        }

        .take-rate-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .summary-card {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .summary-icon {
            font-size: 2rem;
        }

        .summary-content {
            display: flex;
            flex-direction: column;
        }

        .summary-value {
            font-size: 1.5rem;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
            color: var(--accent-green);
        }

        .summary-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        /* Filter Bar */
        .filter-bar {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            align-items: flex-end;
            margin-bottom: 1rem;
            padding: 1rem;
            background: var(--bg-secondary);
            border-radius: 8px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .filter-group label {
            font-size: 0.7rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .filter-input {
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
            font-family: 'Space Grotesk', sans-serif;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            min-width: 200px;
            transition: border-color 0.2s;
        }

        .filter-input:focus {
            outline: none;
            border-color: var(--accent-green);
        }

        .filter-select {
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
            font-family: 'Space Grotesk', sans-serif;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            cursor: pointer;
            min-width: 150px;
        }

        .filter-select:focus {
            outline: none;
            border-color: var(--accent-green);
        }

        .clear-filters-btn {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            font-family: 'Space Grotesk', sans-serif;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
        }

        .clear-filters-btn:hover {
            border-color: var(--accent-red);
            color: var(--accent-red);
        }

        .filter-count {
            margin-left: auto;
            font-size: 0.8rem;
            color: var(--accent-green);
            font-family: 'JetBrains Mono', monospace;
        }

        tr.hidden {
            display: none;
        }

        .sort-hint {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .sortable {
            cursor: pointer;
            user-select: none;
            transition: background 0.2s;
        }

        .sortable:hover {
            background: var(--bg-card);
        }

        .sort-icon {
            opacity: 0.4;
            font-size: 0.7rem;
            margin-left: 0.25rem;
        }

        .sortable.asc .sort-icon,
        .sortable.desc .sort-icon {
            opacity: 1;
            color: var(--accent-green);
        }

        .sortable.asc .sort-icon::after { content: '‚Üë'; }
        .sortable.desc .sort-icon::after { content: '‚Üì'; }

        /* Exclude Checkbox Styling */
        .exclude-checkbox {
            appearance: none;
            -webkit-appearance: none;
            width: 20px !important;
            height: 20px !important;
            border: 2px solid var(--accent-orange);
            border-radius: 4px;
            background: transparent;
            cursor: pointer;
            position: relative;
            transition: all 0.2s;
        }
        
        .exclude-checkbox:checked {
            background: var(--accent-orange);
            border-color: var(--accent-orange);
        }
        
        .exclude-checkbox:checked::after {
            content: '‚úì';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #000;
            font-size: 14px;
            font-weight: bold;
        }
        
        .exclude-checkbox:hover {
            border-color: var(--accent-yellow);
            box-shadow: 0 0 8px rgba(255, 159, 67, 0.4);
        }

        /* Footer */
        footer {
            text-align: center;
            padding: 2rem;
            color: var(--text-secondary);
            font-size: 0.8rem;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .quarterly-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            h1 {
                font-size: 1.25rem;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo-section">
                    <span class="logo">üí∞</span>
                    <div>
                        <h1>Incentive Compensation Tool</h1>
                        <p class="subtitle">Book of Business & Revenue Tracking</p>
                    </div>
                </div>
                <div class="current-csm" id="current-csm-badge" style="display: flex;">
                    <span class="current-csm-label">Viewing:</span>
                    <span class="current-csm-name" id="current-csm-name">Maya Marks</span>
                </div>
            </div>
        </div>
    </header>

    <main class="container">
        <!-- CSM Selector - Live BigQuery Data -->
        <div class="csm-selector">
            <h2>üë§ Load Your Book of Business</h2>
            
            <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">Enter your name to pull live data from BigQuery</p>
            
            <!-- Auth Status -->
            <div id="auth-status" style="display: none; margin-bottom: 1rem; padding: 0.75rem 1rem; border-radius: 8px; font-size: 0.875rem;"></div>
            
            <!-- Name Input -->
            <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap; justify-content: center; margin-bottom: 0.75rem;">
                <input 
                    type="text" 
                    id="csm-name-input" 
                    placeholder="Enter your name (e.g., Maya Marks)"
                    value=""
                    style="padding: 0.75rem 1rem; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-primary); color: var(--text-primary); font-size: 1rem; min-width: 280px;"
                    onkeypress="if(event.key === 'Enter') loadLiveData()"
                >
                <button id="load-btn" onclick="loadLiveData()" style="padding: 0.75rem 1.5rem; border-radius: 8px; background: linear-gradient(135deg, #00ff88, #00d4ff); color: #0a0a0f; border: none; cursor: pointer; font-weight: 600;">
                    ‚ö° Load Live Data
                </button>
            </div>
            <div style="display: flex; gap: 0.5rem; align-items: center; justify-content: center; margin-bottom: 1rem;">
                <input type="checkbox" id="include-midmarket-scaled" style="width: 18px; height: 18px; cursor: pointer;">
                <label for="include-midmarket-scaled" style="color: var(--text-secondary); font-size: 0.9rem; cursor: pointer;">
                    Include Mid-Market Scaled accounts <span style="color: var(--accent-purple);">(check if you're a Mid-Market Scaled CSM)</span>
                </label>
            </div>
            
            <!-- Error Message -->
            <div id="error-message" style="display: none; background: rgba(255, 71, 87, 0.1); border: 1px solid var(--accent-red); border-radius: 8px; padding: 1rem; margin-top: 1rem; max-width: 600px; text-align: left;">
                <p style="color: var(--accent-red); margin: 0; font-size: 0.875rem;" id="error-text"></p>
            </div>
            
            <p style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 1rem;">
                ‚ö° Live data from BigQuery ‚Ä¢ <span id="data-source-label">shopify-dw.finance + shopify-dw.sales</span>
            </p>
        </div>

        <!-- Success Message (shown briefly after loading) -->
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Processing data...</p>
        </div>

        <!-- Report Content -->
        <div id="report-content">
            <!-- Metrics -->
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-label">Total Accounts</div>
                    <div class="metric-value blue" id="metric-accounts">37</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">2025 Total Revenue</div>
                    <div class="metric-value green" id="metric-2025-rev">$15.7M</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">L12M GMV</div>
                    <div class="metric-value blue" id="metric-gmv">$1.38B</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Avg Take Rate</div>
                    <div class="metric-value orange" id="metric-take-rate">4.49%</div>
                </div>
            </div>

            <!-- NRR Target Tracker (Configurable by Quarter) -->
            <div class="yoy-comparison-card" id="nrr-target-section">
                <div class="yoy-header">
                    <span class="yoy-title">üéØ <span id="nrr-quarter-title">Q1 2026</span> NRR Target</span>
                    <select id="quarter-selector" onchange="onQuarterChange()" 
                        style="padding: 0.4rem 0.8rem; border-radius: 6px; border: 1px solid var(--border); 
                        background: var(--bg-secondary); color: var(--accent-blue); font-weight: 600; cursor: pointer;">
                        <option value="Q1-2026">Q1 2026</option>
                        <option value="Q2-2026">Q2 2026</option>
                        <option value="Q3-2026">Q3 2026</option>
                        <option value="Q4-2026">Q4 2026</option>
                    </select>
                    <span class="yoy-note" id="quarter-progress-note">~22% of quarter elapsed</span>
                </div>
                <div class="yoy-metrics">
                    <div class="yoy-metric">
                        <div class="yoy-metric-label"><span id="quarter-ytd-label">Q1 2026</span> (YTD)</div>
                        <div class="yoy-metric-value current" id="q1-2026-ytd">$0</div>
                    </div>
                    <div class="yoy-arrow">‚Üí</div>
                    <div class="yoy-metric">
                        <div class="yoy-metric-label">My Target (in millions)</div>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <span style="color: var(--accent-purple); font-size: 1.5rem;">$</span>
                            <input type="number" id="nrr-target-input" placeholder="e.g. 3.88" step="0.01"
                                style="padding: 0.5rem; border-radius: 8px; border: 1px solid var(--border); 
                                background: var(--bg-secondary); color: var(--accent-purple); width: 100px; 
                                font-size: 1.25rem; font-weight: 700; text-align: center;"
                                onchange="updateNRRTracker()" onkeyup="updateNRRTracker()">
                            <span style="color: var(--text-secondary); font-size: 1rem;">M</span>
                        </div>
                    </div>
                    <div class="yoy-metric pacing">
                        <div class="yoy-metric-label">Pacing to Target</div>
                        <div class="yoy-metric-value pacing-value" id="nrr-pacing">-</div>
                        <div id="nrr-status" style="font-size: 0.85rem; margin-top: 0.25rem;"></div>
                    </div>
                    <div class="yoy-arrow">‚Üí</div>
                    <div class="yoy-metric">
                        <div class="yoy-metric-label">Estimated <span id="quarter-est-label">Q1</span> Total</div>
                        <div class="yoy-metric-value" id="nrr-projected" style="color: var(--accent-cyan);">-</div>
                        <div id="nrr-projected-note" style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.25rem;"></div>
                    </div>
                </div>
                <div id="nrr-progress-container" style="margin-top: 1rem; display: none;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem; font-size: 0.85rem;">
                        <span style="color: var(--text-secondary);">Progress: <span id="nrr-current-display">$0</span></span>
                        <span style="color: var(--text-secondary);">Target: <span id="nrr-target-display">$0</span></span>
                    </div>
                    <div style="background: var(--bg-secondary); border-radius: 8px; height: 12px; overflow: hidden;">
                        <div id="nrr-progress-bar" style="height: 100%; background: linear-gradient(90deg, var(--accent-green), var(--accent-blue)); 
                            border-radius: 8px; transition: width 0.5s ease; width: 0%;"></div>
                    </div>
                </div>
            </div>

            <!-- Quarterly Performance -->
            <section>
                <h2><span class="emoji">üìà</span> Quarterly Performance</h2>
                <div class="quarterly-grid" id="quarterly-performance-grid">
                    <div class="quarter-card"><div class="quarter-label">Q1</div><div class="quarter-values"><span style="color: var(--text-secondary);">Loading...</span></div></div>
                    <div class="quarter-card"><div class="quarter-label">Q2</div><div class="quarter-values"><span style="color: var(--text-secondary);">Loading...</span></div></div>
                    <div class="quarter-card"><div class="quarter-label">Q3</div><div class="quarter-values"><span style="color: var(--text-secondary);">Loading...</span></div></div>
                    <div class="quarter-card"><div class="quarter-label">Q4</div><div class="quarter-values"><span style="color: var(--text-secondary);">Loading...</span></div></div>
                </div>
            </section>

            <!-- All Accounts Q1 Performance -->
            <section>
                <h2><span class="emoji">üìä</span> All Accounts - Q1 Performance (Sorted by Q1 2026 Revenue)</h2>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Account</th>
                                <th>Q1 2025</th>
                                <th>Q1 2026</th>
                                <th>YoY Pacing</th>
                            </tr>
                        </thead>
                        <tbody id="all-accounts-q1">
                            <tr><td colspan="4" style="text-align: center; color: var(--text-secondary);">Load your data to see Q1 performance</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Needs Attention -->
            <section>
                <h2><span class="emoji">‚ö†Ô∏è</span> Needs Attention (Q1 YoY < 25%)</h2>
                <p class="section-description">Accounts with revenue pacing below 25% YoY. GMV compares same days in Q1 (YTD vs YTD). "Likely Cause" shows payment issues when GMV is healthy but revenue isn't.</p>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Account</th>
                                <th>Q1 '25 Rev</th>
                                <th>Q1 '26 Rev</th>
                                <th>Rev YoY</th>
                                <th>Q1 '25 GMV</th>
                                <th>Q1 '26 GMV</th>
                                <th>GMV YoY</th>
                                <th>Likely Cause</th>
                            </tr>
                        </thead>
                        <tbody id="needs-attention">
                            <tr><td colspan="8" style="text-align: center; color: var(--text-secondary);">Load your data to see accounts needing attention</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Full Book of Business -->
            <section>
                <h2><span class="emoji">üìã</span> Complete Book of Business</h2>
                <div class="filter-bar">
                    <div class="filter-group">
                        <label for="account-search">üîç Search</label>
                        <input type="text" id="account-search" class="filter-input" placeholder="Filter by account name..." onkeyup="filterTable()">
                    </div>
                    <div class="filter-group">
                        <label for="pacing-filter">üìà Q1 Pacing</label>
                        <select id="pacing-filter" class="filter-select" onchange="filterTable()">
                            <option value="all">All Accounts</option>
                            <option value="high">High (> 40%)</option>
                            <option value="medium">Medium (25-40%)</option>
                            <option value="low">Needs Attention (< 25%)</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="revenue-filter">üí∞ 2025 Revenue</label>
                        <select id="revenue-filter" class="filter-select" onchange="filterTable()">
                            <option value="all">All</option>
                            <option value="1m">$1M+</option>
                            <option value="500k">$500K - $1M</option>
                            <option value="100k">$100K - $500K</option>
                            <option value="under100k">Under $100K</option>
                        </select>
                    </div>
                    <button class="clear-filters-btn" onclick="clearFilters()">Clear Filters</button>
                    <span class="filter-count" id="filter-count">Showing 37 accounts</span>
                </div>
                <div style="display: flex; align-items: center; gap: 1rem; margin: 1rem 0; flex-wrap: wrap;">
                    <p class="sort-hint" style="margin: 0;">üí° Click any column header to sort</p>
                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-left: auto;">
                        <span id="excluded-count" style="color: var(--accent-orange); font-size: 0.85rem;"></span>
                        <button id="recalc-btn" onclick="recalculateNRR()" 
                            style="padding: 0.5rem 1rem; border-radius: 8px; border: 1px solid var(--accent-blue); 
                            background: rgba(0, 212, 255, 0.2); color: var(--accent-blue); cursor: pointer; 
                            font-weight: 600; font-size: 0.85rem; transition: all 0.2s;">
                            üîÑ Recalculate NRR
                        </button>
                        <button onclick="clearExclusions()" 
                            style="padding: 0.5rem 0.75rem; border-radius: 8px; border: 1px solid var(--border); 
                            background: transparent; color: var(--text-secondary); cursor: pointer; 
                            font-size: 0.8rem;">
                            Clear
                        </button>
                    </div>
                </div>
                <div class="table-container">
                    <table id="book-table">
                        <thead>
                            <tr>
                                <th style="width: 50px; text-align: center;">Excl</th>
                                <th class="sortable" data-col="1" onclick="sortTable(1, 'string')">Account <span class="sort-icon">‚áÖ</span></th>
                                <th>SFDC</th>
                                <th class="sortable" data-col="3" onclick="sortTable(3, 'string')">Segment <span class="sort-icon">‚áÖ</span></th>
                                <th class="sortable" data-col="4" onclick="sortTable(4, 'currency')">L12M GMV <span class="sort-icon">‚áÖ</span></th>
                                <th class="sortable" data-col="5" onclick="sortTable(5, 'currency')">L12M Rev <span class="sort-icon">‚áÖ</span></th>
                                <th class="sortable" data-col="6" onclick="sortTable(6, 'percent')">Take Rate <span class="sort-icon">‚áÖ</span></th>
                                <th class="sortable" data-col="7" onclick="sortTable(7, 'currency')">2025 Total Rev <span class="sort-icon">‚áÖ</span></th>
                                <th class="sortable" data-col="8" onclick="sortTable(8, 'currency')">Q1 '25 <span class="sort-icon">‚áÖ</span></th>
                                <th class="sortable" data-col="9" onclick="sortTable(9, 'currency')">Q1 '26 <span class="sort-icon">‚áÖ</span></th>
                                <th class="sortable" data-col="10" onclick="sortTable(10, 'percent')">Q1 YoY <span class="sort-icon">‚áÖ</span></th>
                                <th class="sortable" data-col="11" onclick="sortTable(11, 'currency')">Q2 '25 <span class="sort-icon">‚áÖ</span></th>
                                <th class="sortable" data-col="12" onclick="sortTable(12, 'currency')">Q2 '26 <span class="sort-icon">‚áÖ</span></th>
                                <th class="sortable" data-col="13" onclick="sortTable(13, 'percent')">Q2 YoY <span class="sort-icon">‚áÖ</span></th>
                                <th class="sortable" data-col="14" onclick="sortTable(14, 'currency')">Q3 '25 <span class="sort-icon">‚áÖ</span></th>
                                <th class="sortable" data-col="15" onclick="sortTable(15, 'currency')">Q3 '26 <span class="sort-icon">‚áÖ</span></th>
                                <th class="sortable" data-col="16" onclick="sortTable(16, 'percent')">Q3 YoY <span class="sort-icon">‚áÖ</span></th>
                                <th class="sortable" data-col="17" onclick="sortTable(17, 'currency')">Q4 '25 <span class="sort-icon">‚áÖ</span></th>
                                <th class="sortable" data-col="18" onclick="sortTable(18, 'currency')">Q4 '26 <span class="sort-icon">‚áÖ</span></th>
                                <th class="sortable" data-col="19" onclick="sortTable(19, 'percent')">Q4 YoY <span class="sort-icon">‚áÖ</span></th>
                            </tr>
                        </thead>
                        <tbody id="full-book">
                            <tr><td colspan="20" style="text-align: center; color: var(--text-secondary); padding: 2rem;">Enter your name and click "Load My Data" to see your accounts</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Take Rate Optimization - Explainer Only -->
            <section class="take-rate-section">
                <h2><span class="emoji">üìâ</span> Take Rate Optimization Opportunities</h2>
                <p class="section-description">Identify accounts with SP growth potential. Low GMV Take Rate but high SP Take Rate = merchant uses another payment provider.</p>
                
                <!-- Take Rate Explainer -->
                <div class="take-rate-explainer" style="background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(168, 85, 247, 0.1)); border-radius: 12px; padding: 1.25rem; margin-bottom: 1.5rem; border: 1px solid rgba(99, 102, 241, 0.2);">
                    <h4 style="margin: 0 0 0.5rem 0; color: var(--text-primary); font-size: 0.95rem;">üìä Understanding Take Rate Metrics</h4>
                    <p style="font-size: 0.8rem; color: var(--text-secondary); margin: 0 0 1rem 0; font-style: italic;">Example: Merchant has $100M GMV total. $60M through SP, $40M through PayPal. SP Revenue = $1.2M, Total Revenue = $1.5M</p>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem;">
                        <div style="background: rgba(0,0,0,0.2); padding: 0.75rem 1rem; border-radius: 8px;">
                            <div style="font-weight: 600; color: #f59e0b; margin-bottom: 0.25rem;">GMV Take Rate = Total Revenue √∑ GMV</div>
                            <div style="font-size: 0.85rem; color: var(--text-secondary);">All Shopify revenue as % of total sales.</div>
                            <div style="font-size: 0.8rem; color: #f59e0b; margin-top: 0.5rem; background: rgba(245, 158, 11, 0.1); padding: 0.4rem 0.6rem; border-radius: 4px;">üìå Example: $1.5M √∑ $100M = <strong>1.5%</strong></div>
                        </div>
                        <div style="background: rgba(0,0,0,0.2); padding: 0.75rem 1rem; border-radius: 8px;">
                            <div style="font-weight: 600; color: #10b981; margin-bottom: 0.25rem;">Pure SP Take Rate = SP Revenue √∑ GPV</div>
                            <div style="font-size: 0.85rem; color: var(--text-secondary);">SP fees as % of SP volume only. Shows true SP efficiency.</div>
                            <div style="font-size: 0.8rem; color: #10b981; margin-top: 0.5rem; background: rgba(16, 185, 129, 0.1); padding: 0.4rem 0.6rem; border-radius: 4px;">üìå Example: $1.2M √∑ $60M = <strong>2.0%</strong></div>
                    </div>
                        <div style="background: rgba(0,0,0,0.2); padding: 0.75rem 1rem; border-radius: 8px;">
                            <div style="font-weight: 600; color: #6366f1; margin-bottom: 0.25rem;">SP Penetration = GPV √∑ GMV</div>
                            <div style="font-size: 0.85rem; color: var(--text-secondary);">% of sales through SP. Low = uses external PSP.</div>
                            <div style="font-size: 0.8rem; color: #6366f1; margin-top: 0.5rem; background: rgba(99, 102, 241, 0.1); padding: 0.4rem 0.6rem; border-radius: 4px;">üìå Example: $60M √∑ $100M = <strong>60%</strong> (40% via PayPal)</div>
                        </div>
                        <div style="background: rgba(0,0,0,0.2); padding: 0.75rem 1rem; border-radius: 8px;">
                            <div style="font-weight: 600; color: #60a5fa; margin-bottom: 0.25rem;">GPV = Gross Payments Volume</div>
                            <div style="font-size: 0.85rem; color: var(--text-secondary);">$ value through Shopify Payments only.</div>
                            <div style="font-size: 0.8rem; color: #60a5fa; margin-top: 0.5rem; background: rgba(96, 165, 250, 0.1); padding: 0.4rem 0.6rem; border-radius: 4px;">üìå Example: <strong>$60M</strong> of $100M total sales</div>
                        </div>
                        <div style="background: rgba(0,0,0,0.2); padding: 0.75rem 1rem; border-radius: 8px;">
                            <div style="font-weight: 600; color: #a78bfa; margin-bottom: 0.25rem;">SP Revenue = Processing + FX + Chargeback Fees</div>
                            <div style="font-size: 0.85rem; color: var(--text-secondary);">Revenue from SP transactions only (not subs or gateway fees).</div>
                            <div style="font-size: 0.8rem; color: #a78bfa; margin-top: 0.5rem; background: rgba(167, 139, 250, 0.1); padding: 0.4rem 0.6rem; border-radius: 4px;">üìå Example: <strong>$1.2M</strong> from the $60M GPV</div>
                        </div>
                        </div>
                        </div>
            </section>

            <!-- Low GMV Take Rate Accounts -->
            <section class="take-rate-section">
                <div class="opportunities-table">
                    <h3>üéØ Low GMV Take Rate Accounts (< 3%)</h3>
                    <div class="table-container">
                        <table id="low-take-rate-table">
                            <thead>
                                <tr>
                                    <th>Account</th>
                                    <th>Country</th>
                                    <th>Shops</th>
                                    <th>GMV Take Rate</th>
                                    <th>Pure SP Take Rate</th>
                                    <th>SP Penetration</th>
                                    <th>L12M GMV</th>
                                    <th>L12M GPV</th>
                                    <th>L12M SP Revenue</th>
                                    <th>Opportunity</th>
                                </tr>
                            </thead>
                            <tbody id="low-take-rate-tbody">
                                <tr><td colspan="10" style="text-align: center; color: var(--text-secondary);">Load your data to see low take rate accounts</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Revenue Sources & Products Info -->
                <div style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(34, 197, 94, 0.1)); border-radius: 12px; padding: 1.25rem; margin-top: 1.5rem; border: 1px solid rgba(16, 185, 129, 0.2);">
                    <h4 style="margin: 0 0 1rem 0; color: var(--text-primary); font-size: 0.95rem;">üí∞ What's Included in Revenue & Products That Boost Take Rate</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 1.5rem;">
                        <!-- Total Revenue Column -->
                        <div>
                            <div style="font-weight: 600; color: #f59e0b; margin-bottom: 0.5rem; font-size: 0.9rem;">üìä Total Revenue (GMV Take Rate)</div>
                            <div style="background: rgba(0,0,0,0.2); padding: 0.75rem; border-radius: 8px; font-size: 0.8rem; color: var(--text-secondary);">
                                <div style="margin-bottom: 0.25rem;">‚úÖ Subscription fees (Basic, Plus, etc.)</div>
                                <div style="margin-bottom: 0.25rem;">‚úÖ SP processing fees</div>
                                <div style="margin-bottom: 0.25rem;">‚úÖ Non-SP transaction fees (Adyen, Stripe)</div>
                                <div style="margin-bottom: 0.25rem;">‚úÖ Shipping label margins</div>
                                <div style="margin-bottom: 0.25rem;">‚úÖ Capital loan fees</div>
                                <div style="margin-bottom: 0.25rem;">‚úÖ Tax filing fees</div>
                                <div style="margin-bottom: 0.25rem;">‚úÖ POS subscription fees</div>
                                <div>‚úÖ App/theme revenue share</div>
                        </div>
                    </div>
                        <!-- SP Revenue Column -->
                        <div>
                            <div style="font-weight: 600; color: #10b981; margin-bottom: 0.5rem; font-size: 0.9rem;">üí≥ SP Revenue (Pure SP Take Rate)</div>
                            <div style="background: rgba(0,0,0,0.2); padding: 0.75rem; border-radius: 8px; font-size: 0.8rem; color: var(--text-secondary);">
                                <div style="margin-bottom: 0.25rem;">‚úÖ SP processing fees (~2.4-2.9%)</div>
                                <div style="margin-bottom: 0.25rem;">‚úÖ FX conversion fees (1.5%)</div>
                                <div style="margin-bottom: 0.25rem;">‚úÖ Chargeback fees</div>
                                <div style="margin-top: 0.75rem; padding-top: 0.5rem; border-top: 1px solid rgba(255,255,255,0.1);">
                                    <div style="color: #ef4444;">‚ùå Subscription fees</div>
                                    <div style="color: #ef4444;">‚ùå Non-SP transaction fees</div>
                                    <div style="color: #ef4444;">‚ùå Capital, Shipping, Tax, etc.</div>
                        </div>
                    </div>
                        </div>
                        <!-- Products That Boost Take Rate -->
                        <div>
                            <div style="font-weight: 600; color: #6366f1; margin-bottom: 0.5rem; font-size: 0.9rem;">üöÄ Products That Boost Take Rate</div>
                            <div style="background: rgba(0,0,0,0.2); padding: 0.75rem; border-radius: 8px; font-size: 0.8rem;">
                                <div style="margin-bottom: 0.4rem;"><span style="color: #10b981; font-weight: 600;">Shop Pay Installments</span> <span style="color: var(--text-secondary);">~5-6% vs 2.9%</span></div>
                                <div style="margin-bottom: 0.4rem;"><span style="color: #10b981; font-weight: 600;">Shopify Markets</span> <span style="color: var(--text-secondary);">+1.5% FX fee</span></div>
                                <div style="margin-bottom: 0.4rem;"><span style="color: #10b981; font-weight: 600;">Shopify Capital</span> <span style="color: var(--text-secondary);">Loan fees</span></div>
                                <div style="margin-bottom: 0.4rem;"><span style="color: #10b981; font-weight: 600;">Shopify Shipping</span> <span style="color: var(--text-secondary);">Label margins</span></div>
                                <div style="margin-bottom: 0.4rem;"><span style="color: #10b981; font-weight: 600;">Shopify Tax</span> <span style="color: var(--text-secondary);">Per-filing fees</span></div>
                                <div style="margin-bottom: 0.4rem;"><span style="color: #10b981; font-weight: 600;">POS Pro</span> <span style="color: var(--text-secondary);">$89/mo + processing</span></div>
                                <div><span style="color: #10b981; font-weight: 600;">Shop Pay</span> <span style="color: var(--text-secondary);">Higher conversion ‚Üí more GPV</span></div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <footer>
        <p>üí∞ Incentive Compensation Tool | Data from Revenue MCP & BigQuery</p>
        <p style="margin-top: 0.5rem;">Q1 2026 data is Jan 1-15 only (~17% of quarter elapsed)</p>
    </footer>

    <script>
        // === LIVE BIGQUERY DATA FUNCTIONS ===
        
        let hasAuth = false;
        
        // Global storage for accounts data (for recalculation)
        let globalAccountsData = null;
        let globalPortfolioMetrics = null;
        
        // Get excluded accounts from localStorage
        function getExcludedAccounts() {
            const saved = localStorage.getItem('excluded_accounts');
            return saved ? JSON.parse(saved) : [];
        }
        
        // Save excluded accounts to localStorage
        function saveExcludedAccounts(excluded) {
            localStorage.setItem('excluded_accounts', JSON.stringify(excluded));
        }
        
        // Toggle account exclusion
        function toggleExclude(accountId, checkbox) {
            // Skip if accountId is undefined (old corrupted data)
            if (!accountId || accountId === 'undefined') {
                console.warn('Skipping invalid accountId:', accountId);
                return;
            }
            
            let excluded = getExcludedAccounts();
            // Clean any undefined entries from old data
            excluded = excluded.filter(id => id && id !== 'undefined');
            
            console.log('Before toggle:', excluded, 'Account:', accountId, 'Checked:', checkbox.checked);
            
            if (checkbox.checked) {
                if (!excluded.includes(accountId)) {
                    excluded.push(accountId);
                }
                // Update checkbox visual
                checkbox.style.background = '#ff9f43';
                // Dim the row
                checkbox.closest('tr').style.opacity = '0.5';
                checkbox.closest('tr').style.background = 'rgba(255, 71, 87, 0.1)';
            } else {
                excluded = excluded.filter(id => id !== accountId);
                // Update checkbox visual
                checkbox.style.background = 'transparent';
                // Restore the row
                checkbox.closest('tr').style.opacity = '1';
                checkbox.closest('tr').style.background = '';
            }
            
            saveExcludedAccounts(excluded);
            console.log('After toggle:', excluded);
            updateExcludedCount();
            
            // Auto-recalculate NRR when checkbox is toggled
            recalculateNRR();
        }
        
        // Update excluded count display
        function updateExcludedCount() {
            const excluded = getExcludedAccounts();
            const countEl = document.getElementById('excluded-count');
            if (countEl) {
                countEl.textContent = excluded.length > 0 ? `(${excluded.length} excluded)` : '';
            }
        }
        
        // Recalculate NRR excluding checked accounts
        function recalculateNRR() {
            if (!globalAccountsData) {
                console.log('No data loaded yet, skipping recalculation');
                return;
            }
            
            const excluded = getExcludedAccounts();
            const includedAccounts = globalAccountsData.filter(acc => !excluded.includes(acc.account_id));
            
            // Recalculate all totals
            let totalQ1_2026 = 0, totalQ1_2025 = 0;
            let totalQ2_2025 = 0, totalQ3_2025 = 0, totalQ4_2025 = 0;
            let total2025 = 0;
            let totalGmv = 0;
            let totalRevenue = 0;
            
            includedAccounts.forEach(acc => {
                totalQ1_2026 += acc.q1_2026 || 0;
                totalQ1_2025 += acc.q1_2025 || 0;
                totalQ2_2025 += acc.q2_2025 || 0;
                totalQ3_2025 += acc.q3_2025 || 0;
                totalQ4_2025 += acc.q4_2025 || 0;
                total2025 += (acc.q1_2025 || 0) + (acc.q2_2025 || 0) + (acc.q3_2025 || 0) + (acc.q4_2025 || 0);
                totalGmv += acc.l12m_gmv || 0;
                totalRevenue += acc.l12m_revenue || 0;
            });
            
            // Update the Q1 2026 YTD display
            const q1YtdEl = document.getElementById('q1-2026-ytd');
            if (q1YtdEl) {
                q1YtdEl.textContent = formatCurrency(totalQ1_2026, true);
            }
            
            // Update metrics
            const accountsEl = document.getElementById('metric-accounts');
            const revEl = document.getElementById('metric-2025-rev');
            const gmvEl = document.getElementById('metric-gmv');
            const takeRateEl = document.getElementById('metric-take-rate');
            
            if (accountsEl) accountsEl.textContent = includedAccounts.length;
            if (revEl) revEl.textContent = formatCurrency(total2025, true);
            if (gmvEl) gmvEl.textContent = formatCurrency(totalGmv, true);
            
            const avgTakeRate = totalGmv > 0 ? (totalRevenue / totalGmv * 100) : 0;
            if (takeRateEl) takeRateEl.textContent = avgTakeRate.toFixed(2) + '%';
            
            // Update YoY pacing
            const q1YoyPacing = totalQ1_2025 > 0 ? (totalQ1_2026 / totalQ1_2025 * 100) : 0;
            const pacingEl = document.getElementById('q1-yoy-pacing');
            if (pacingEl) {
                pacingEl.textContent = formatPercent(q1YoyPacing);
            }
            
            // Update the TOTAL row in the BOB table
            const tbody = document.getElementById('full-book');
            if (tbody) {
                const rows = tbody.querySelectorAll('tr');
                const totalRow = rows[rows.length - 1]; // Last row is the total
                if (totalRow && totalRow.style.background && totalRow.style.background.includes('accent-blue')) {
                    // Found total row, update it
                    const totalQ1Yoy = totalQ1_2025 > 0 ? ((totalQ1_2026 / totalQ1_2025) * 100).toFixed(1) : 'N/A';
                    totalRow.innerHTML = `
                        <td></td>
                        <td style="color: white;">üìä TOTAL (${includedAccounts.length} accounts)</td>
                        <td></td>
                        <td></td>
                        <td class="number" style="color: white;">${formatCurrency(totalGmv, true)}</td>
                        <td class="number" style="color: white;">${formatCurrency(totalRevenue, true)}</td>
                        <td class="number" style="color: white;">${avgTakeRate.toFixed(2)}%</td>
                        <td class="number" style="color: white;">${formatCurrency(total2025, true)}</td>
                        <td class="number" style="color: white;">${formatCurrency(totalQ1_2025, true)}</td>
                        <td class="number" style="color: #00ff88; font-size: 1.1em;">${formatCurrency(totalQ1_2026, true)}</td>
                        <td style="color: white;">${totalQ1Yoy}%</td>
                        <td class="number" style="color: white;">${formatCurrency(totalQ2_2025, true)}</td>
                        <td class="number" style="color: white;">-</td>
                        <td style="color: white;">-</td>
                        <td class="number" style="color: white;">${formatCurrency(totalQ3_2025, true)}</td>
                        <td class="number" style="color: white;">-</td>
                        <td style="color: white;">-</td>
                        <td class="number" style="color: white;">${formatCurrency(totalQ4_2025, true)}</td>
                        <td class="number" style="color: white;">-</td>
                        <td style="color: white;">-</td>
                    `;
                }
            }
            
            // Flash the button to confirm (only if button exists and we're not auto-updating)
            const btn = document.getElementById('recalc-btn');
            if (btn && excluded.length > 0) {
                btn.textContent = '‚úÖ Updated!';
                btn.style.background = 'rgba(0, 255, 136, 0.3)';
                setTimeout(() => {
                    btn.textContent = 'üîÑ Recalculate NRR';
                    btn.style.background = 'rgba(0, 212, 255, 0.2)';
                }, 1000);
            }
            
            console.log(`üìä Recalculated: ${excluded.length} accounts excluded, ${includedAccounts.length} included`);
            console.log(`üìä New Q1 2026 Total: ${formatCurrency(totalQ1_2026, true)}`);
        }
        
        // Clear all exclusions
        function clearExclusions() {
            if (confirm('Clear all excluded accounts?')) {
                localStorage.removeItem('excluded_accounts');
                // Uncheck all checkboxes and reset row styling
                document.querySelectorAll('.exclude-checkbox').forEach(cb => {
                    cb.checked = false;
                    cb.style.background = 'transparent';
                    const row = cb.closest('tr');
                    if (row) {
                        row.style.opacity = '1';
                        row.style.background = '';
                    }
                });
                updateExcludedCount();
                recalculateNRR();
            }
        }
        
        // Initialize and check BigQuery auth on page load
        async function initAuth() {
            try {
                const authResult = await quick.auth.requestScopes([
                    "https://www.googleapis.com/auth/bigquery",
                ]);
                hasAuth = authResult.hasRequiredScopes;
                
                if (hasAuth) {
                    showAuthStatus('‚úÖ Connected to BigQuery', 'success');
                    // Auto-populate name from user identity
                    if (quick.id && quick.id.fullName) {
                        document.getElementById('csm-name-input').value = quick.id.fullName;
                    }
                }
            } catch (e) {
                console.log('Auth check:', e);
            }
        }
        
        function showAuthStatus(message, type) {
            const el = document.getElementById('auth-status');
            el.style.display = 'block';
            el.textContent = message;
            el.style.background = type === 'success' ? 'rgba(0, 255, 136, 0.1)' : 'rgba(255, 71, 87, 0.1)';
            el.style.border = type === 'success' ? '1px solid var(--accent-green)' : '1px solid var(--accent-red)';
            el.style.color = type === 'success' ? 'var(--accent-green)' : 'var(--accent-red)';
        }
        
        function showError(message) {
            const el = document.getElementById('error-message');
            const textEl = document.getElementById('error-text');
            el.style.display = 'block';
            textEl.textContent = message;
        }
        
        function hideError() {
            document.getElementById('error-message').style.display = 'none';
        }
        
        // Main function to load live data from BigQuery
        async function loadLiveData() {
            const nameInput = document.getElementById('csm-name-input');
            const name = nameInput.value.trim();
            
            if (!name) {
                showError('Please enter your name');
                nameInput.focus();
                return;
            }

            hideError();
            
            // Request BigQuery auth if not already granted
            if (!hasAuth) {
                try {
                    const authResult = await quick.auth.requestScopes([
                        "https://www.googleapis.com/auth/bigquery",
                    ]);
                    if (!authResult.hasRequiredScopes) {
                        showError('BigQuery access required. Please grant permission when prompted.');
                return;
                    }
                    hasAuth = true;
                } catch (e) {
                    showError('Failed to authenticate: ' + e.message);
                    return;
                }
            }
            
            // Show loading state
            document.getElementById('loading').classList.add('active');
            const loadBtn = document.getElementById('load-btn');
            loadBtn.textContent = '‚è≥ Loading...';
            loadBtn.disabled = true;
            
            try {
                // Debug: Log the name being searched
                console.log('üîç Searching for CSM:', name);
                showAuthStatus(`üîç Searching for: "${name}"`, 'success');
                
                // Query 1: Get accounts for this CSM from sales data
                // Filters: account_type = 'Customer' to exclude churned/prospects
                //          Optionally exclude Mid-Market Scaled unless checkbox is checked
                const includeMidMarketScaled = document.getElementById('include-midmarket-scaled').checked;
                const midMarketFilter = includeMidMarketScaled ? '' : "AND sa.service_model != 'Mid-Market Scaled'";
                
                const accountsQuery = `
                    SELECT DISTINCT
                        sa.account_id,
                        sa.name AS account_name,
                        sa.account_url,
                        sa.merchant_success_manager,
                        sa.account_country_code,
                        sa.account_type,
                        COALESCE(sa.service_model, 'SMB') AS service_model,
                        m.shop_id
                    FROM \`shopify-dw.sales.sales_accounts\` sa
                    LEFT JOIN \`shopify-dw.sales.sales_unified_entity_mapping\` m
                        ON sa.account_id = m.salesforce_account_id
                    WHERE LOWER(sa.merchant_success_manager) LIKE '%${name.toLowerCase().split(' ').join('%')}%'
                    AND sa.account_type = 'Customer'
                    ${midMarketFilter}
                    AND m.shop_id IS NOT NULL
                `;
                
                const accountsResult = await quick.dw.querySync(accountsQuery);
                
                if (!accountsResult.results || accountsResult.results.length === 0) {
                    throw new Error(`No accounts found for "${name}". Make sure your name matches how it appears in Salesforce.`);
                }
                
                // Debug: Show account stats (note: results.length includes shop duplicates)
                const foundCSMs = [...new Set(accountsResult.results.map(r => r.merchant_success_manager))];
                const uniqueAccountIds = [...new Set(accountsResult.results.map(r => r.account_id))];
                console.log('üìã CSM:', foundCSMs.join(', '));
                console.log('üìä Distinct accounts:', uniqueAccountIds.length);
                console.log('üîó Total shop mappings:', accountsResult.results.length);
                
                const shopIds = accountsResult.results.map(r => r.shop_id).filter(Boolean);
                const accountMap = {};
                accountsResult.results.forEach(r => {
                    if (!accountMap[r.account_id]) {
                        accountMap[r.account_id] = {
                            name: r.account_name,
                            sfdc_url: r.account_url || `https://shopify.lightning.force.com/lightning/r/Account/${r.account_id}/view`,
                            country: r.account_country_code || 'US',
                            service_model: r.service_model || 'Unknown',
                            shop_ids: []
                        };
                    }
                    if (r.shop_id) accountMap[r.account_id].shop_ids.push(r.shop_id);
                });
                
                // Query 2: Get revenue data
                const revenueQuery = `
                    SELECT 
                        shop_id,
                        SUM(CASE WHEN date >= DATE_SUB(CURRENT_DATE(), INTERVAL 365 DAY) THEN estimated_profit_usd ELSE 0 END) AS l12m_revenue,
                        SUM(CASE WHEN date BETWEEN '2025-01-01' AND '2025-03-31' THEN estimated_profit_usd ELSE 0 END) AS q1_2025,
                        SUM(CASE WHEN date BETWEEN '2025-04-01' AND '2025-06-30' THEN estimated_profit_usd ELSE 0 END) AS q2_2025,
                        SUM(CASE WHEN date BETWEEN '2025-07-01' AND '2025-09-30' THEN estimated_profit_usd ELSE 0 END) AS q3_2025,
                        SUM(CASE WHEN date BETWEEN '2025-10-01' AND '2025-12-31' THEN estimated_profit_usd ELSE 0 END) AS q4_2025,
                        SUM(CASE WHEN date BETWEEN '2026-01-01' AND '2026-03-31' THEN estimated_profit_usd ELSE 0 END) AS q1_2026,
                        SUM(CASE WHEN date BETWEEN '2026-04-01' AND '2026-06-30' THEN estimated_profit_usd ELSE 0 END) AS q2_2026,
                        SUM(CASE WHEN date BETWEEN '2026-07-01' AND '2026-09-30' THEN estimated_profit_usd ELSE 0 END) AS q3_2026,
                        SUM(CASE WHEN date BETWEEN '2026-10-01' AND '2026-12-31' THEN estimated_profit_usd ELSE 0 END) AS q4_2026
                    FROM \`shopify-dw.finance.shop_netsuite_account_daily_profit_summary\`
                    WHERE shop_id IN (${shopIds.join(',')})
                    AND account_type = 'Income'
                    AND date >= '2024-01-15'
                    GROUP BY shop_id
                `;
                
                // Query 3: Get GMV data (using FULL quarters to match revenue query)
                const gmvQuery = `
                    SELECT 
                        shop_id,
                        SUM(CASE WHEN date >= DATE_SUB(CURRENT_DATE(), INTERVAL 365 DAY) THEN gmv_usd ELSE 0 END) AS l12m_gmv,
                        SUM(CASE WHEN date BETWEEN '2025-01-01' AND '2025-03-31' THEN gmv_usd ELSE 0 END) AS q1_gmv_2025,
                        SUM(CASE WHEN date BETWEEN '2026-01-01' AND '2026-03-31' THEN gmv_usd ELSE 0 END) AS q1_gmv_2026
                    FROM \`shopify-dw.finance.shop_gmv_daily_summary_v1\`
                    WHERE shop_id IN (${shopIds.join(',')})
                    AND date >= DATE_SUB(CURRENT_DATE(), INTERVAL 365 DAY)
                    GROUP BY shop_id
                `;
                
                // Query 4: Get SP status
                const spQuery = `
                    SELECT shop_id, is_enabled AS sp_enabled
                    FROM \`shopify-dw.money_products.shopify_payments_adoption_current\`
                    WHERE shop_id IN (${shopIds.join(',')})
                `;
                
                // Query 5: Get GPV (Gross Payments Volume - payments through Shopify Payments only)
                const gpvQuery = `
                    SELECT 
                        shop_id,
                        SUM(CASE WHEN date >= DATE_SUB(CURRENT_DATE(), INTERVAL 365 DAY) THEN gpv_usd ELSE 0 END) AS l12m_gpv
                    FROM \`shopify-dw.finance.shop_gpv_daily_summary_v1\`
                    WHERE shop_id IN (${shopIds.join(',')})
                    AND date >= DATE_SUB(CURRENT_DATE(), INTERVAL 365 DAY)
                    GROUP BY shop_id
                `;
                
                // Query 6: Get SP-specific revenue (processing fees from Shopify Payments only)
                const spRevenueQuery = `
                    SELECT 
                        shop_id,
                        SUM(processing_revenue_usd) AS l12m_sp_revenue,
                        SUM(fx_fee_revenue_usd) AS l12m_fx_revenue,
                        SUM(chargeback_revenue_usd) AS l12m_chargeback_revenue
                    FROM \`shopify-dw.finance.payments_revenue_and_costs_v1\`
                    WHERE shop_id IN (${shopIds.join(',')})
                    AND DATE(date) >= DATE_SUB(CURRENT_DATE(), INTERVAL 365 DAY)
                    GROUP BY shop_id
                `;
                
                // Run all 5 queries in parallel for speed
                const [revenueResult, gmvResult, spResult, gpvResult, spRevenueResult] = await Promise.all([
                    quick.dw.querySync(revenueQuery),
                    quick.dw.querySync(gmvQuery),
                    quick.dw.querySync(spQuery),
                    quick.dw.querySync(gpvQuery),
                    quick.dw.querySync(spRevenueQuery)
                ]);
                
                console.log('üìä Revenue query returned', revenueResult.results?.length || 0, 'shops');
                console.log('üìä GMV query returned', gmvResult.results?.length || 0, 'shops');
                console.log('üìä SP query returned', spResult.results?.length || 0, 'shops');
                console.log('üìä GPV query returned', gpvResult.results?.length || 0, 'shops');
                console.log('üìä SP Revenue query returned', spRevenueResult.results?.length || 0, 'shops');
                
                // Build maps from results
                const revenueMap = {};
                let debugQ1_2026_Total = 0;
                (revenueResult.results || []).forEach(r => {
                    const q1_2026_val = parseFloat(r.q1_2026) || 0;
                    debugQ1_2026_Total += q1_2026_val;
                    revenueMap[r.shop_id] = {
                        l12m_revenue: parseFloat(r.l12m_revenue) || 0,
                        q1_2025: parseFloat(r.q1_2025) || 0,
                        q2_2025: parseFloat(r.q2_2025) || 0,
                        q3_2025: parseFloat(r.q3_2025) || 0,
                        q4_2025: parseFloat(r.q4_2025) || 0,
                        q1_2026: q1_2026_val,
                        q2_2026: parseFloat(r.q2_2026) || 0,
                        q3_2026: parseFloat(r.q3_2026) || 0,
                        q4_2026: parseFloat(r.q4_2026) || 0
                    };
                });
                
                const gmvMap = {};
                (gmvResult.results || []).forEach(r => {
                    gmvMap[r.shop_id] = {
                        l12m_gmv: parseFloat(r.l12m_gmv) || 0,
                        q1_gmv_2025: parseFloat(r.q1_gmv_2025) || 0,
                        q1_gmv_2026: parseFloat(r.q1_gmv_2026) || 0
                    };
                });
                
                const spStatusMap = {};
                (spResult.results || []).forEach(r => {
                    spStatusMap[r.shop_id] = {
                        sp_enabled_current: r.sp_enabled === true
                    };
                });
                
                const gpvMap = {};
                (gpvResult.results || []).forEach(r => {
                    gpvMap[r.shop_id] = {
                        l12m_gpv: parseFloat(r.l12m_gpv) || 0
                    };
                });
                
                const spRevenueMap = {};
                (spRevenueResult.results || []).forEach(r => {
                    spRevenueMap[r.shop_id] = {
                        l12m_sp_revenue: parseFloat(r.l12m_sp_revenue) || 0,
                        l12m_fx_revenue: parseFloat(r.l12m_fx_revenue) || 0,
                        l12m_chargeback_revenue: parseFloat(r.l12m_chargeback_revenue) || 0
                    };
                });
                
                console.log('üìä Total Q1 2026 from revenue query:', debugQ1_2026_Total);
                
                // Aggregate data by account
                const accounts = [];
                let totalGmv = 0, totalRevenue = 0, total2025 = 0;
                let totalGpv = 0, totalSpRevenue = 0;
                let totalQ1_2025 = 0, totalQ2_2025 = 0, totalQ3_2025 = 0, totalQ4_2025 = 0;
                let totalQ1_2026 = 0, totalQ2_2026 = 0, totalQ3_2026 = 0, totalQ4_2026 = 0;
                
                Object.entries(accountMap).forEach(([accountId, account]) => {
                    let accGmv = 0, accRevenue = 0, accGpv = 0, accSpRevenue = 0;
                    let accQ1_25 = 0, accQ2_25 = 0, accQ3_25 = 0, accQ4_25 = 0;
                    let accQ1_26 = 0, accQ2_26 = 0, accQ3_26 = 0, accQ4_26 = 0;
                    let accQ1Gmv25 = 0, accQ1Gmv26 = 0;
                    let spEnabledShops = 0, spDisabledShops = 0;
                    
                    account.shop_ids.forEach(shopId => {
                        const gmvData = gmvMap[shopId];
                        if (gmvData) {
                            accGmv += gmvData.l12m_gmv || 0;
                            accQ1Gmv25 += gmvData.q1_gmv_2025 || 0;
                            accQ1Gmv26 += gmvData.q1_gmv_2026 || 0;
                        }
                        const gpvData = gpvMap[shopId];
                        if (gpvData) {
                            accGpv += gpvData.l12m_gpv || 0;
                        }
                        const spRevData = spRevenueMap[shopId];
                        if (spRevData) {
                            // SP Revenue = Processing fees + FX fees + Chargeback fees
                            accSpRevenue += (spRevData.l12m_sp_revenue || 0) + 
                                           (spRevData.l12m_fx_revenue || 0) + 
                                           (spRevData.l12m_chargeback_revenue || 0);
                        }
                        const rev = revenueMap[shopId];
                        if (rev) {
                            accRevenue += rev.l12m_revenue || 0;
                            accQ1_25 += rev.q1_2025 || 0;
                            accQ2_25 += rev.q2_2025 || 0;
                            accQ3_25 += rev.q3_2025 || 0;
                            accQ4_25 += rev.q4_2025 || 0;
                            accQ1_26 += rev.q1_2026 || 0;
                            accQ2_26 += rev.q2_2026 || 0;
                            accQ3_26 += rev.q3_2026 || 0;
                            accQ4_26 += rev.q4_2026 || 0;
                        }
                        // Check Shopify Payments current status
                        const spStatus = spStatusMap[shopId];
                        if (spStatus) {
                            if (spStatus.sp_enabled_current) {
                                spEnabledShops++;
                } else {
                                spDisabledShops++;
                            }
                        }
                    });
                    
                    // SP is disabled for account if NO shops have SP enabled
                    const spCurrentlyDisabled = spEnabledShops === 0 && spDisabledShops > 0;
                    
                    // Calculate take rates:
                    // GMV Take Rate = Total Revenue / GMV (overall revenue efficiency)
                    // SP Take Rate (Old) = Total Revenue / GPV (includes non-SP revenue in numerator)
                    // Pure SP Take Rate = SP-only Revenue / GPV (true SP efficiency)
                    // SP Penetration = GPV / GMV (% of sales through SP)
                    const takeRate = accGmv > 0 ? (accRevenue / accGmv) * 100 : 0;
                    const spTakeRate = accGpv > 0 ? (accRevenue / accGpv) * 100 : 0;
                    const pureSpTakeRate = accGpv > 0 ? (accSpRevenue / accGpv) * 100 : 0;
                    const spPenetration = accGmv > 0 ? (accGpv / accGmv) * 100 : 0;
                    const acc2025 = accQ1_25 + accQ2_25 + accQ3_25 + accQ4_25;
                    
                    accounts.push({
                        account_id: accountId,
                        name: account.name,
                        sfdc_url: account.sfdc_url,
                        service_model: account.service_model,
                        shop_count: account.shop_ids.length,
                        l12m_gmv: accGmv,
                        l12m_gpv: accGpv,
                        l12m_revenue: accRevenue,
                        l12m_sp_revenue: accSpRevenue,
                        take_rate: takeRate,
                        sp_take_rate: spTakeRate,
                        pure_sp_take_rate: pureSpTakeRate,
                        sp_penetration: spPenetration,
                        q1_2025: accQ1_25,
                        q2_2025: accQ2_25,
                        q3_2025: accQ3_25,
                        q4_2025: accQ4_25,
                        q1_2026: accQ1_26,
                        q2_2026: accQ2_26,
                        q3_2026: accQ3_26,
                        q4_2026: accQ4_26,
                        q1_gmv_2025: accQ1Gmv25,
                        q1_gmv_2026: accQ1Gmv26,
                        country: account.country,
                        sp_currently_disabled: spCurrentlyDisabled
                    });
                    
                    totalGmv += accGmv;
                    totalGpv += accGpv;
                    totalSpRevenue += accSpRevenue;
                    totalRevenue += accRevenue;
                    total2025 += acc2025;
                    totalQ1_2025 += accQ1_25;
                    totalQ2_2025 += accQ2_25;
                    totalQ3_2025 += accQ3_25;
                    totalQ4_2025 += accQ4_25;
                    totalQ1_2026 += accQ1_26;
                    totalQ2_2026 += accQ2_26;
                    totalQ3_2026 += accQ3_26;
                    totalQ4_2026 += accQ4_26;
                });
                
                // Sort accounts by L12M revenue
                accounts.sort((a, b) => b.l12m_revenue - a.l12m_revenue);
                
                console.log('üìä After aggregation - Total Q1 2026:', totalQ1_2026);
                console.log('üìä Number of accounts:', accounts.length);
                
                // Get selected quarter's revenue
                const quarterTotals = {
                    'Q1-2026': totalQ1_2026,
                    'Q2-2026': totalQ2_2026,
                    'Q3-2026': totalQ3_2026,
                    'Q4-2026': totalQ4_2026
                };
                const selectedQuarterRevenue = quarterTotals[selectedQuarter] || totalQ1_2026;
                
                // Build final data object
                const data = {
                    csm_name: name,
                    generated_at: new Date().toISOString(),
                    data_source: 'live',
                    totals: {
                        account_count: accounts.length,
                        total_l12m_gmv: totalGmv,
                        total_l12m_gpv: totalGpv,
                        total_l12m_revenue: totalRevenue,
                        total_l12m_sp_revenue: totalSpRevenue,
                        total_2025_revenue: total2025,
                        avg_take_rate: totalGmv > 0 ? (totalRevenue / totalGmv) * 100 : 0,
                        avg_sp_take_rate: totalGpv > 0 ? (totalRevenue / totalGpv) * 100 : 0,
                        avg_pure_sp_take_rate: totalGpv > 0 ? (totalSpRevenue / totalGpv) * 100 : 0,
                        sp_penetration: totalGmv > 0 ? (totalGpv / totalGmv) * 100 : 0
                    },
                    q1_comparison: {
                        q1_2025: totalQ1_2025,
                        q1_2026_ytd: totalQ1_2026,
                        pacing_rate: totalQ1_2025 > 0 ? (totalQ1_2026 / totalQ1_2025) * 100 : 0
                    },
                    quarter_totals_2025: {
                        'Q1': totalQ1_2025,
                        'Q2': totalQ2_2025,
                        'Q3': totalQ3_2025,
                        'Q4': totalQ4_2025
                    },
                    quarter_totals: quarterTotals,
                    selected_quarter: selectedQuarter,
                    selected_quarter_ytd: selectedQuarterRevenue,
                    accounts: accounts
                };
                
                // Update dashboard
                updateDashboardFromGitHub(data);
                
                // Show live data indicator
                document.getElementById('current-csm-badge').style.display = 'flex';
                document.getElementById('current-csm-name').innerHTML = `<span style="color: var(--accent-green);">‚ö° LIVE</span> ${name}`;
                showAuthStatus(`‚úÖ Loaded ${accounts.length} accounts from BigQuery`, 'success');
                
            } catch (e) {
                console.error('Query error:', e);
                showError('Failed to load data: ' + e.message);
            } finally {
                document.getElementById('loading').classList.remove('active');
                loadBtn.textContent = '‚ö° Load Live Data';
                loadBtn.disabled = false;
            }
        }
        
        // Initialize auth on page load
        document.addEventListener('DOMContentLoaded', initAuth);
        
        // Update Quarterly Performance grid with live data
        function updateQuarterlyPerformance(data) {
            const grid = document.getElementById('quarterly-performance-grid');
            if (!grid) {
                console.error('‚ùå quarterly-performance-grid not found');
                return;
            }
            
            const quarters = ['Q1', 'Q2', 'Q3', 'Q4'];
            const totals2025 = data.quarter_totals_2025 || {};
            const totals2026 = data.quarter_totals || {};
            
            console.log('üìä Quarterly Performance - 2025:', totals2025);
            console.log('üìä Quarterly Performance - 2026:', totals2026);
            
            // Determine which quarters have started in 2026
            const now = new Date();
            const currentMonth = now.getMonth() + 1; // 1-12
            const quarterStarted = {
                'Q1': currentMonth >= 1,  // Jan-Mar
                'Q2': currentMonth >= 4,  // Apr-Jun
                'Q3': currentMonth >= 7,  // Jul-Sep
                'Q4': currentMonth >= 10  // Oct-Dec
            };
            
            grid.innerHTML = quarters.map(q => {
                const val2025 = totals2025[q] || 0;
                const val2026 = totals2026[`${q}-2026`] || 0;
                const yoy = val2025 > 0 ? ((val2026 / val2025) * 100).toFixed(1) : 0;
                // Only show 2026 data if the quarter has actually started
                const hasData2026 = quarterStarted[q] && val2026 > 0;
                
                // Determine badge style
                let badgeClass = 'yoy-neutral';
                let badgeText = 'Not started';
                if (hasData2026) {
                    badgeClass = yoy >= 50 ? 'yoy-positive' : yoy >= 25 ? 'yoy-neutral' : 'yoy-negative';
                    badgeText = `${yoy}% YoY`;
                }
                
                return `
                    <div class="quarter-card">
                        <div class="quarter-label">${q}</div>
                        <div class="quarter-values">
                            <div class="quarter-row">
                                <span class="year-label">2025</span>
                                <span class="quarter-value">${formatCurrency(val2025, true)}</span>
                            </div>
                            <div class="quarter-row">
                                <span class="year-label">2026</span>
                                <span class="quarter-value" style="color: ${hasData2026 ? 'var(--accent-green)' : 'var(--text-secondary)'};">
                                    ${hasData2026 ? formatCurrency(val2026, true) : '-'}
                                </span>
                            </div>
                            <span class="yoy-badge ${badgeClass}">${badgeText}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateDashboardFromGitHub(data) {
            document.getElementById('loading').classList.remove('active');
            
            // Update header
            document.getElementById('current-csm-badge').style.display = 'flex';
            document.getElementById('current-csm-name').textContent = data.csm_name;
            
            // Update metrics
            if (data.totals) {
                document.getElementById('metric-accounts').textContent = data.totals.account_count || data.accounts.length;
                document.getElementById('metric-gmv').textContent = formatCurrency(data.totals.total_l12m_gmv, true);
                document.getElementById('metric-2025-rev').textContent = formatCurrency(data.totals.total_2025_revenue, true);
                document.getElementById('metric-take-rate').textContent = (data.totals.avg_take_rate || 0).toFixed(2) + '%';
            }
            
            // Update Quarterly Performance grid
            updateQuarterlyPerformance(data);
            
            // Update NRR tracker section with selected quarter
            const quarterRevenue = data.selected_quarter_ytd || data.q1_comparison?.q1_2026_ytd || 0;
            const config = quarterConfig[selectedQuarter];
            console.log(`üí∞ ${config.label} YTD Revenue:`, quarterRevenue, '‚Üí', formatCurrency(quarterRevenue, true));
            
            // Update YTD display
            const ytdElement = document.getElementById('q1-2026-ytd');
            if (ytdElement) {
                ytdElement.textContent = formatCurrency(quarterRevenue, true);
                console.log('‚úÖ Updated quarter YTD element');
            }
            
            // Update quarter elapsed note
            const elapsedPercent = getQuarterElapsedPercent(selectedQuarter);
            document.getElementById('quarter-progress-note').textContent = `~${Math.round(elapsedPercent * 100)}% of quarter elapsed`;
            
            // Set global variables for NRR tracker
            currentQuarterRevenue = quarterRevenue;
            
            // Update NRR tracker if target is set
            if (document.getElementById('nrr-target-input').value) {
                updateNRRTracker();
            }
            
            // Update table
            const tbody = document.getElementById('full-book');
            tbody.innerHTML = '';
            
            // Store globally for recalculation
            globalAccountsData = data.accounts;
            
            // Get excluded accounts
            const excluded = getExcludedAccounts();
            
            // Calculate totals
            let totals = {
                l12m_gmv: 0, l12m_revenue: 0, total_2025: 0,
                q1_2025: 0, q1_2026: 0, q2_2025: 0, q3_2025: 0, q4_2025: 0
            };
            
            data.accounts.forEach(account => {
                // Accumulate totals
                totals.l12m_gmv += account.l12m_gmv || 0;
                totals.l12m_revenue += account.l12m_revenue || 0;
                totals.q1_2025 += account.q1_2025 || 0;
                totals.q1_2026 += account.q1_2026 || 0;
                totals.q2_2025 += account.q2_2025 || 0;
                totals.q3_2025 += account.q3_2025 || 0;
                totals.q4_2025 += account.q4_2025 || 0;
                totals.total_2025 += (account.q1_2025 || 0) + (account.q2_2025 || 0) + (account.q3_2025 || 0) + (account.q4_2025 || 0);
                
                const q1Yoy = account.q1_2025 > 0 ? ((account.q1_2026 / account.q1_2025) * 100).toFixed(1) : 'N/A';
                const pacingClass = q1Yoy === 'N/A' ? '' : (parseFloat(q1Yoy) >= 40 ? 'pacing-high' : parseFloat(q1Yoy) >= 25 ? 'pacing-medium' : 'pacing-low');
                
                // Get short segment name
                const segmentShort = {
                    'Large Accounts': 'Large',
                    'Enterprise': 'Ent',
                    'Mid-Market Assigned': 'MM-A',
                    'Mid-Market Scaled': 'MM-S'
                }[account.service_model] || account.service_model;
                
                // Check if excluded
                const isExcluded = excluded.includes(account.account_id);
                
                const row = document.createElement('tr');
                row.style.cssText = isExcluded ? 'opacity: 0.5; background: rgba(255, 71, 87, 0.1);' : '';
                row.innerHTML = `
                    <td style="text-align: center;">
                        <input type="checkbox" class="exclude-checkbox" 
                            data-account-id="${account.account_id}"
                            ${isExcluded ? 'checked' : ''} 
                            onchange="toggleExclude('${account.account_id}', this)"
                            style="appearance: none; -webkit-appearance: none; width: 20px; height: 20px; border: 2px solid #ff9f43; border-radius: 4px; background: ${isExcluded ? '#ff9f43' : 'transparent'}; cursor: pointer;">
                    </td>
                    <td>${account.name}</td>
                    <td><a class="account-link" href="${account.sfdc_url}" target="_blank">üîó</a></td>
                    <td style="font-size: 0.8em; color: var(--text-secondary);">${segmentShort}</td>
                    <td class="number">${formatCurrency(account.l12m_gmv, true)}</td>
                    <td class="number">${formatCurrency(account.l12m_revenue, true)}</td>
                    <td class="number">${(account.take_rate || 0).toFixed(2)}%</td>
                    <td class="number">${formatCurrency((account.q1_2025 || 0) + (account.q2_2025 || 0) + (account.q3_2025 || 0) + (account.q4_2025 || 0), true)}</td>
                    <td class="number">${formatCurrency(account.q1_2025, true)}</td>
                    <td class="number">${formatCurrency(account.q1_2026, true)}</td>
                    <td class="${pacingClass}">${q1Yoy}${q1Yoy !== 'N/A' ? '%' : ''}</td>
                    <td class="number">${formatCurrency(account.q2_2025, true)}</td>
                    <td class="number">-</td>
                    <td>-</td>
                    <td class="number">${formatCurrency(account.q3_2025, true)}</td>
                    <td class="number">-</td>
                    <td>-</td>
                    <td class="number">${formatCurrency(account.q4_2025, true)}</td>
                    <td class="number">-</td>
                    <td>-</td>
                `;
                tbody.appendChild(row);
            });
            
            // Update excluded count and filter count
            updateExcludedCount();
            document.getElementById('filter-count').textContent = `Showing ${data.accounts.length} accounts`;
            
            // Add total row
            const totalQ1Yoy = totals.q1_2025 > 0 ? ((totals.q1_2026 / totals.q1_2025) * 100).toFixed(1) : 'N/A';
            const totalTakeRate = totals.l12m_gmv > 0 ? (totals.l12m_revenue / totals.l12m_gmv) * 100 : 0;
            const totalRow = document.createElement('tr');
            totalRow.style.cssText = 'background: var(--accent-blue); font-weight: 700; position: sticky; bottom: 0;';
            totalRow.innerHTML = `
                <td></td>
                <td style="color: white;">üìä TOTAL (${data.accounts.length} accounts)</td>
                <td></td>
                <td></td>
                <td class="number" style="color: white;">${formatCurrency(totals.l12m_gmv, true)}</td>
                <td class="number" style="color: white;">${formatCurrency(totals.l12m_revenue, true)}</td>
                <td class="number" style="color: white;">${totalTakeRate.toFixed(2)}%</td>
                <td class="number" style="color: white;">${formatCurrency(totals.total_2025, true)}</td>
                <td class="number" style="color: white;">${formatCurrency(totals.q1_2025, true)}</td>
                <td class="number" style="color: #00ff88; font-size: 1.1em;">${formatCurrency(totals.q1_2026, true)}</td>
                <td style="color: white;">${totalQ1Yoy}%</td>
                <td class="number" style="color: white;">${formatCurrency(totals.q2_2025, true)}</td>
                <td class="number" style="color: white;">$0</td>
                <td style="color: white;">-</td>
                <td class="number" style="color: white;">${formatCurrency(totals.q3_2025, true)}</td>
                <td class="number" style="color: white;">$0</td>
                <td style="color: white;">-</td>
                <td class="number" style="color: white;">${formatCurrency(totals.q4_2025, true)}</td>
                <td class="number" style="color: white;">$0</td>
                <td style="color: white;">-</td>
            `;
            tbody.appendChild(totalRow);
            
            // Update Q1 Performance table (show ALL accounts)
            const q1Tbody = document.getElementById('all-accounts-q1');
            if (q1Tbody) {
                const sortedByQ1 = [...data.accounts].sort((a, b) => (b.q1_2026 || 0) - (a.q1_2026 || 0));
                q1Tbody.innerHTML = sortedByQ1.map(acc => {
                    const q1Yoy = acc.q1_2025 > 0 ? ((acc.q1_2026 / acc.q1_2025) * 100).toFixed(1) : 'N/A';
                    const pacingClass = q1Yoy === 'N/A' ? '' : (parseFloat(q1Yoy) >= 40 ? 'pacing-high' : parseFloat(q1Yoy) >= 25 ? 'pacing-medium' : 'pacing-low');
                    return `<tr>
                        <td>${acc.name}</td>
                        <td class="number">${formatCurrency(acc.q1_2025)}</td>
                        <td class="number">${formatCurrency(acc.q1_2026)}</td>
                        <td class="${pacingClass}">${q1Yoy}${q1Yoy !== 'N/A' ? '%' : ''}</td>
                    </tr>`;
                }).join('');
            }
            
            // Update Needs Attention table
            const needsAttentionTbody = document.getElementById('needs-attention');
            if (needsAttentionTbody) {
                const needsAttention = data.accounts.filter(acc => {
                    if (!acc.q1_2025 || acc.q1_2025 <= 0) return false;
                    const yoy = (acc.q1_2026 / acc.q1_2025) * 100;
                    return yoy < 25;
                }).sort((a, b) => {
                    const aYoy = a.q1_2025 > 0 ? (a.q1_2026 / a.q1_2025) : 0;
                    const bYoy = b.q1_2025 > 0 ? (b.q1_2026 / b.q1_2025) : 0;
                    return aYoy - bYoy;
                });
                
                needsAttentionTbody.innerHTML = needsAttention.slice(0, 10).map(acc => {
                    const revYoy = acc.q1_2025 > 0 ? ((acc.q1_2026 / acc.q1_2025) * 100).toFixed(1) : 'N/A';
                    const gmvYoyNum = acc.q1_gmv_2025 > 0 ? (acc.q1_gmv_2026 / acc.q1_gmv_2025) * 100 : 0;
                    const gmvYoy = acc.q1_gmv_2025 > 0 ? gmvYoyNum.toFixed(1) : 'N/A';
                    const gmvYoyClass = gmvYoy === 'N/A' ? '' : (gmvYoyNum >= 100 ? 'pacing-high' : gmvYoyNum >= 50 ? 'pacing-medium' : 'pacing-low');
                    
                    // Determine likely cause based on GMV vs Revenue pattern
                    // Key insight: If GMV is healthy but revenue isn't, it's a payment capture issue
                    let likelyCause = '';
                    let causeClass = '';
                    const revYoyNum = parseFloat(revYoy) || 0;
                    
                    if (gmvYoyNum >= 80 && revYoyNum < 25) {
                        // üö® GMV stable/growing but revenue tanked = PAYMENT ISSUE (actionable!)
                        if (acc.sp_currently_disabled) {
                            likelyCause = 'üí≥ SP Disabled';
                            causeClass = 'style="color: #ff4444; font-weight: 700; background: rgba(255,68,68,0.15);"';
                        } else {
                            likelyCause = 'üí≥ External PSP?';
                            causeClass = 'style="color: var(--accent-purple); font-weight: 600;"';
                        }
                    } else if (gmvYoyNum >= 50 && gmvYoyNum < 80 && revYoyNum < 25) {
                        // GMV somewhat down but revenue way more down = possible payment shift
                        likelyCause = 'üîç Mixed - Check PSP';
                        causeClass = 'style="color: var(--accent-yellow);"';
                    } else {
                        // GMV down tracks with revenue down = normal business decline
                        likelyCause = 'üìâ GMV Decline';
                        causeClass = 'style="color: var(--text-secondary);"';
                    }
                    
                    return `<tr>
                        <td>${acc.name}</td>
                        <td class="number">${formatCurrency(acc.q1_2025)}</td>
                        <td class="number">${formatCurrency(acc.q1_2026)}</td>
                        <td class="pacing-low">${revYoy}%</td>
                        <td class="number">${formatCurrency(acc.q1_gmv_2025 || 0, true)}</td>
                        <td class="number">${formatCurrency(acc.q1_gmv_2026 || 0, true)}</td>
                        <td class="${gmvYoyClass}">${gmvYoy}${gmvYoy !== 'N/A' ? '%' : ''}</td>
                        <td ${causeClass}>${likelyCause}</td>
                    </tr>`;
                }).join('');
            }
            
            // Update Take Rate Opportunities
            updateTakeRateSection(data.accounts);
            
            document.getElementById('report-content').scrollIntoView({ behavior: 'smooth' });
        }
        
        // Update Take Rate section with live data
        function updateTakeRateSection(accounts) {
            // Filter accounts with take rate < 3% and > 0%
            const lowTakeRate = accounts
                .filter(acc => acc.take_rate < 3 && acc.take_rate > 0)
                .sort((a, b) => a.take_rate - b.take_rate);
            
            // Update the table with all new columns
            const tbody = document.getElementById('low-take-rate-tbody');
            if (tbody) {
                if (lowTakeRate.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="10" style="text-align: center; color: var(--text-secondary);">No accounts with GMV take rate below 3% üéâ</td></tr>';
            } else {
                    tbody.innerHTML = lowTakeRate.map(acc => {
                        const countryFlag = getCountryFlag(acc.country);
                        const spPen = acc.sp_penetration || 0;
                        const pureSpTr = acc.pure_sp_take_rate || 0;
                        
                        // Determine opportunity type based on metrics
                        let opportunity = '';
                        let oppStyle = '';
                        
                        if (spPen < 30) {
                            // Low SP penetration = merchant routes most payments elsewhere
                            opportunity = 'üéØ Win Back Volume';
                            oppStyle = 'color: #ef4444; font-weight: 600;';
                        } else if (spPen >= 30 && spPen < 70) {
                            // Moderate SP penetration, room to grow
                            if (pureSpTr < 2) {
                                opportunity = 'üìà Upsell SP Products';
                                oppStyle = 'color: #f59e0b; font-weight: 600;';
                            } else {
                                opportunity = 'üîÑ Increase SP Share';
                                oppStyle = 'color: #6366f1; font-weight: 600;';
                            }
                        } else if (spPen >= 70) {
                            // High SP penetration but low GMV take rate = upsell products
                            if (pureSpTr < 2) {
                                opportunity = 'üíé Upsell Products';
                                oppStyle = 'color: #10b981; font-weight: 600;';
                            } else {
                                opportunity = '‚úÖ SP Optimized';
                                oppStyle = 'color: var(--text-secondary);';
                            }
                        }
                        
                        // Color code SP penetration
                        const spPenClass = spPen < 30 ? 'pacing-low' : spPen < 70 ? 'pacing-medium' : 'pacing-high';
                        // Color code Pure SP Take Rate (typical range 1.5-3% for healthy SP accounts)
                        const pureSpTrClass = pureSpTr < 1.5 ? 'pacing-low' : pureSpTr < 2.5 ? 'pacing-medium' : 'pacing-high';
                        
                        return `
                            <tr>
                                <td><a class="account-link" href="${acc.sfdc_url}" target="_blank">${acc.name}</a></td>
                                <td>${countryFlag} ${acc.country || 'Unknown'}</td>
                                <td class="number">${acc.shop_count || 0}</td>
                                <td class="number pacing-low">${acc.take_rate.toFixed(2)}%</td>
                                <td class="number ${pureSpTrClass}">${pureSpTr.toFixed(2)}%</td>
                                <td class="number ${spPenClass}">${spPen.toFixed(1)}%</td>
                                <td class="number">${formatCurrency(acc.l12m_gmv, true)}</td>
                                <td class="number">${formatCurrency(acc.l12m_gpv || 0, true)}</td>
                                <td class="number">${formatCurrency(acc.l12m_sp_revenue || 0, true)}</td>
                                <td style="${oppStyle}">${opportunity}</td>
                            </tr>
                        `;
                    }).join('');
                }
            }
        }
        
        function getCountryFlag(countryCode) {
            const flags = {
                'US': 'üá∫üá∏', 'GB': 'üá¨üáß', 'UK': 'üá¨üáß', 'DE': 'üá©üá™', 'FR': 'üá´üá∑', 
                'CA': 'üá®üá¶', 'AU': 'üá¶üá∫', 'NL': 'üá≥üá±', 'CH': 'üá®üá≠', 'AT': 'üá¶üáπ',
                'BE': 'üáßüá™', 'IT': 'üáÆüáπ', 'ES': 'üá™üá∏', 'PL': 'üáµüá±', 'SE': 'üá∏üá™',
                'DK': 'üá©üá∞', 'NO': 'üá≥üá¥', 'FI': 'üá´üáÆ', 'IE': 'üáÆüá™', 'PT': 'üáµüáπ',
                'NZ': 'üá≥üáø', 'JP': 'üáØüáµ', 'SG': 'üá∏üá¨', 'HK': 'üá≠üá∞', 'IN': 'üáÆüá≥',
                'BR': 'üáßüá∑', 'MX': 'üá≤üáΩ', 'ZA': 'üáøüá¶', 'AE': 'üá¶üá™', 'IL': 'üáÆüá±'
            };
            return flags[countryCode] || 'üåç';
        }

        // Global variables for NRR tracker
        let currentQuarterRevenue = 0;
        let projectedQuarterRevenue = 0;
        let selectedQuarter = 'Q1-2026';
        
        // Quarter date ranges
        const quarterConfig = {
            'Q1-2026': { start: new Date('2026-01-01'), end: new Date('2026-03-31'), label: 'Q1 2026', short: 'Q1' },
            'Q2-2026': { start: new Date('2026-04-01'), end: new Date('2026-06-30'), label: 'Q2 2026', short: 'Q2' },
            'Q3-2026': { start: new Date('2026-07-01'), end: new Date('2026-09-30'), label: 'Q3 2026', short: 'Q3' },
            'Q4-2026': { start: new Date('2026-10-01'), end: new Date('2026-12-31'), label: 'Q4 2026', short: 'Q4' }
        };
        
        function getQuarterElapsedPercent(quarter) {
            const config = quarterConfig[quarter];
            const now = new Date();
            const start = config.start;
            const end = config.end;
            
            // If quarter hasn't started yet
            if (now < start) return 0;
            // If quarter has ended
            if (now > end) return 1;
            
            const totalDays = (end - start) / (1000 * 60 * 60 * 24);
            const elapsedDays = (now - start) / (1000 * 60 * 60 * 24);
            return elapsedDays / totalDays;
        }
        
        function onQuarterChange() {
            selectedQuarter = document.getElementById('quarter-selector').value;
            const config = quarterConfig[selectedQuarter];
            
            // Save quarter selection
            localStorage.setItem('selected_quarter', selectedQuarter);
            
            // Update labels
            document.getElementById('nrr-quarter-title').textContent = config.label;
            document.getElementById('quarter-ytd-label').textContent = config.label;
            document.getElementById('quarter-est-label').textContent = config.short;
            
            // Update quarter elapsed note
            const elapsedPercent = getQuarterElapsedPercent(selectedQuarter);
            document.getElementById('quarter-progress-note').textContent = `~${Math.round(elapsedPercent * 100)}% of quarter elapsed`;
            
            // Load saved target for this quarter
            loadSavedNRRTarget();
            
            // Reload data if we have a CSM name
            const csmName = document.getElementById('csm-name-input').value.trim();
            if (csmName) {
                loadLiveData();
            }
        }
        
        // NRR Target Tracker function
        function updateNRRTracker() {
            const targetInput = document.getElementById('nrr-target-input');
            const targetInM = parseFloat(targetInput.value) || 0;
            const target = targetInM * 1000000; // Convert from millions to dollars
            
            if (target <= 0) {
                document.getElementById('nrr-pacing').textContent = '-';
                document.getElementById('nrr-status').innerHTML = '';
                document.getElementById('nrr-progress-container').style.display = 'none';
                    return;
                }

            // Show progress bar
            document.getElementById('nrr-progress-container').style.display = 'block';
            
            // Calculate pacing: if current pace continues, will we hit target?
            const quarterElapsedPercent = getQuarterElapsedPercent(selectedQuarter);
            const projected = quarterElapsedPercent > 0 ? currentQuarterRevenue / quarterElapsedPercent : 0;
            const pacingPercent = (projected / target) * 100;
            const progressPercent = Math.min((currentQuarterRevenue / target) * 100, 100);
            
            // Update pacing display
            document.getElementById('nrr-pacing').textContent = pacingPercent.toFixed(0) + '%';
            document.getElementById('nrr-progress-bar').style.width = progressPercent + '%';
            document.getElementById('nrr-current-display').textContent = formatCurrency(currentQuarterRevenue, true);
            document.getElementById('nrr-target-display').textContent = formatCurrency(target, true);
            
            // Update estimated Q1 total
            document.getElementById('nrr-projected').textContent = formatCurrency(projected, true);
            const projectedDiff = projected - target;
            const projectedNote = document.getElementById('nrr-projected-note');
            if (projectedDiff >= 0) {
                projectedNote.innerHTML = `<span style="color: var(--accent-green);">+${formatCurrency(projectedDiff, true)} over target</span>`;
            } else {
                projectedNote.innerHTML = `<span style="color: var(--accent-red);">${formatCurrency(projectedDiff, true)} under target</span>`;
            }
            
            // Status message and colors
            const statusEl = document.getElementById('nrr-status');
            const pacingEl = document.getElementById('nrr-pacing');
            const diff = projected - target;
            
            if (pacingPercent >= 100) {
                statusEl.innerHTML = `<span style="color: var(--accent-green);">‚úÖ On track</span>`;
                pacingEl.style.color = 'var(--accent-green)';
                document.getElementById('nrr-progress-bar').style.background = 'linear-gradient(90deg, var(--accent-green), #00ff88)';
            } else if (pacingPercent >= 80) {
                statusEl.innerHTML = `<span style="color: var(--accent-yellow);">‚ö° Close</span>`;
                pacingEl.style.color = 'var(--accent-yellow)';
                document.getElementById('nrr-progress-bar').style.background = 'linear-gradient(90deg, var(--accent-yellow), var(--accent-green))';
            } else {
                statusEl.innerHTML = `<span style="color: var(--accent-orange);">‚ö†Ô∏è Behind</span>`;
                pacingEl.style.color = 'var(--accent-orange)';
                document.getElementById('nrr-progress-bar').style.background = 'linear-gradient(90deg, var(--accent-orange), var(--accent-yellow))';
            }
            
            // Save target to localStorage for persistence (save in M, per quarter)
            localStorage.setItem('nrr_target_' + selectedQuarter, targetInM);
        }
        
        // Load saved NRR target for selected quarter
        function loadSavedNRRTarget() {
            const savedTarget = localStorage.getItem('nrr_target_' + selectedQuarter);
            document.getElementById('nrr-target-input').value = savedTarget || '';
            
            // Update display if we have data
            if (savedTarget && currentQuarterRevenue > 0) {
                updateNRRTracker();
            }
        }

        // Initialize on page load
        window.onload = function() {
            document.getElementById('current-csm-badge').style.display = 'flex';
            document.getElementById('current-csm-name').textContent = 'Enter your name above';
            document.getElementById('report-content').classList.add('active');
            
            // Load saved quarter selection
            const savedQuarter = localStorage.getItem('selected_quarter') || 'Q1-2026';
            selectedQuarter = savedQuarter;
            document.getElementById('quarter-selector').value = savedQuarter;
            
            // Update UI labels for selected quarter
            const config = quarterConfig[selectedQuarter];
            document.getElementById('nrr-quarter-title').textContent = config.label;
            document.getElementById('quarter-ytd-label').textContent = config.label;
            document.getElementById('quarter-est-label').textContent = config.short;
            
            // Update quarter elapsed note
            const elapsedPercent = getQuarterElapsedPercent(selectedQuarter);
            document.getElementById('quarter-progress-note').textContent = `~${Math.round(elapsedPercent * 100)}% of quarter elapsed`;
            
            // Load saved target for this quarter
            loadSavedNRRTarget();
        };


        function updateDashboardWithData(data) {
            // Update the main book of business table
            const tbody = document.getElementById('full-book');
            tbody.innerHTML = '';
            
            data.accounts.forEach(account => {
                const q1Yoy = account.q1_2025 > 0 ? ((account.q1_2026 / account.q1_2025) * 100).toFixed(1) : 'N/A';
                const pacingClass = q1Yoy === 'N/A' ? '' : (parseFloat(q1Yoy) >= 40 ? 'pacing-high' : parseFloat(q1Yoy) >= 25 ? 'pacing-medium' : 'pacing-low');
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${account.name}</td>
                    <td><a class="account-link" href="${account.sfdc_url}" target="_blank">üîó</a></td>
                    <td class="number">${formatCurrency(account.l12m_gmv, true)}</td>
                    <td class="number">${formatCurrency(account.l12m_revenue, true)}</td>
                    <td class="number">${account.take_rate.toFixed(2)}%</td>
                    <td class="number">${formatCurrency(account.q1_2025 + account.q2_2025 + account.q3_2025 + account.q4_2025, true)}</td>
                    <td class="number">${formatCurrency(account.q1_2025, true)}</td>
                    <td class="number">${formatCurrency(account.q1_2026, true)}</td>
                    <td class="${pacingClass}">${q1Yoy}${q1Yoy !== 'N/A' ? '%' : ''}</td>
                    <td class="number">${formatCurrency(account.q2_2025, true)}</td>
                    <td class="number">-</td>
                    <td>-</td>
                    <td class="number">${formatCurrency(account.q3_2025, true)}</td>
                    <td class="number">-</td>
                    <td>-</td>
                    <td class="number">${formatCurrency(account.q4_2025, true)}</td>
                    <td class="number">-</td>
                    <td>-</td>
                `;
                tbody.appendChild(row);
            });
        }

        // formatCurrency is defined below - removed duplicate
        
        function updateDashboard(data) {
            const metrics = data.portfolio_metrics;
            const accounts = data.accounts;
            
            // Update top metrics
            document.getElementById('metric-accounts').textContent = metrics.total_accounts;
            document.getElementById('metric-2025-rev').textContent = formatCurrency(metrics.total_2025_revenue, true);
            document.getElementById('metric-gmv').textContent = formatCurrency(metrics.total_l12m_gmv, true);
            document.getElementById('metric-take-rate').textContent = metrics.avg_take_rate.toFixed(2) + '%';
            
            // Update YoY comparison
            updateYoYComparison(metrics);
            
            // Update quarterly performance
            updateQuarterlyPerformance(metrics);
            
            // Update all accounts Q1 table
            updateAllAccountsQ1(accounts);
            
            // Update needs attention table
            updateNeedsAttention(accounts);
            
            // Update full book of business table
            updateFullBook(accounts);
            
            // Update take rate opportunities
            updateTakeRateOpportunities(accounts);
        }
        
        function formatCurrency(value, short = false) {
            if (short) {
                if (value >= 1000000000) return '$' + (value / 1000000000).toFixed(2) + 'B';
                if (value >= 1000000) return '$' + (value / 1000000).toFixed(1) + 'M';
                if (value >= 1000) return '$' + (value / 1000).toFixed(1) + 'K';
                return '$' + value.toFixed(0);
            }
            return '$' + value.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
        }
        
        function formatPercent(value) {
            if (value === null || value === undefined) return 'N/A';
            return value.toFixed(1) + '%';
        }
        
        function getPacingClass(value) {
            if (value === null || value === undefined) return '';
            if (value > 40) return 'pacing-high';
            if (value >= 25) return 'pacing-medium';
            return 'pacing-low';
        }
        
        function updateYoYComparison(metrics) {
            // Update YoY comparison card values
            const q1_2025_el = document.querySelector('.yoy-metric-value.previous');
            const q1_2026_el = document.querySelector('.yoy-metric-value.current');
            const pacing_el = document.querySelector('.yoy-metric-value.pacing-value');
            const projected_el = document.querySelector('.yoy-projected strong');
            
            if (q1_2025_el) q1_2025_el.textContent = formatCurrency(metrics.q1_2025_total, true);
            if (q1_2026_el) q1_2026_el.textContent = formatCurrency(metrics.q1_2026_total, true);
            if (pacing_el) pacing_el.textContent = formatPercent(metrics.portfolio_q1_yoy_pacing);
            if (projected_el) projected_el.textContent = formatCurrency(metrics.q1_2026_total * 6, true);
        }
        
        function updateAllAccountsQ1(accounts) {
            const tbody = document.getElementById('all-accounts-q1');
            if (!tbody) return;
            
            // Sort by Q1 2026 revenue
            const sorted = [...accounts].sort((a, b) => b.q1_2026 - a.q1_2026);
            
            tbody.innerHTML = sorted.map(acc => `
                <tr>
                    <td>${acc.account_name}</td>
                    <td class="number">${formatCurrency(acc.q1_2025)}</td>
                    <td class="number">${formatCurrency(acc.q1_2026)}</td>
                    <td class="${getPacingClass(acc.q1_yoy_pacing)}">${formatPercent(acc.q1_yoy_pacing)}${acc.q1_yoy_pacing > 100 ? ' üî•' : ''}</td>
                </tr>
            `).join('');
        }
        
        function updateNeedsAttention(accounts) {
            const tbody = document.getElementById('needs-attention');
            if (!tbody) return;
            
            // Filter to accounts with pacing < 25%
            const needsAttention = accounts
                .filter(acc => acc.q1_yoy_pacing !== null && acc.q1_yoy_pacing < 25)
                .sort((a, b) => a.q1_yoy_pacing - b.q1_yoy_pacing);
            
            tbody.innerHTML = needsAttention.map(acc => `
                <tr>
                    <td>${acc.account_name}</td>
                    <td class="number">${formatCurrency(acc.q1_2025)}</td>
                    <td class="number">${formatCurrency(acc.q1_2026)}</td>
                    <td class="pacing-low">${formatPercent(acc.q1_yoy_pacing)}</td>
                </tr>
            `).join('');
        }
        
        function updateFullBook(accounts) {
            const tbody = document.getElementById('full-book');
            if (!tbody) return;
            
            // Store globally for recalculation
            globalAccountsData = accounts;
            
            // Get excluded accounts
            const excluded = getExcludedAccounts();
            
            tbody.innerHTML = accounts.map(acc => {
                const segment = getSegmentAbbrev(acc.service_model);
                const isExcluded = excluded.includes(acc.account_id);
                return `
                <tr style="${isExcluded ? 'opacity: 0.5; background: rgba(255, 71, 87, 0.1);' : ''}">
                    <td style="text-align: center;">
                        <input type="checkbox" class="exclude-checkbox" 
                            data-account-id="${acc.account_id}"
                            ${isExcluded ? 'checked' : ''} 
                            onchange="toggleExclude('${acc.account_id}', this)"
                            style="appearance: none; -webkit-appearance: none; width: 20px; height: 20px; border: 2px solid #ff9f43; border-radius: 4px; background: ${isExcluded ? '#ff9f43' : 'transparent'}; cursor: pointer;">
                    </td>
                    <td>${acc.account_name}</td>
                    <td><a class="account-link" href="${acc.salesforce_url}" target="_blank">üîó</a></td>
                    <td>${segment}</td>
                    <td class="number">${formatCurrency(acc.l12m_gmv, true)}</td>
                    <td class="number">${formatCurrency(acc.l12m_revenue, true)}</td>
                    <td class="number">${acc.take_rate.toFixed(2)}%</td>
                    <td class="number">${formatCurrency(acc.total_2025, true)}</td>
                    <td class="number">${formatCurrency(acc.q1_2025, true)}</td>
                    <td class="number">${formatCurrency(acc.q1_2026, true)}</td>
                    <td class="${getPacingClass(acc.q1_yoy_pacing)}">${formatPercent(acc.q1_yoy_pacing)}</td>
                    <td class="number">${formatCurrency(acc.q2_2025, true)}</td>
                    <td class="number">-</td>
                    <td>-</td>
                    <td class="number">${formatCurrency(acc.q3_2025, true)}</td>
                    <td class="number">-</td>
                    <td>-</td>
                    <td class="number">${formatCurrency(acc.q4_2025, true)}</td>
                    <td class="number">-</td>
                    <td>-</td>
                </tr>
            `}).join('');
            
            // Update filter count and excluded count
            document.getElementById('filter-count').textContent = `Showing ${accounts.length} accounts`;
            updateExcludedCount();
        }
        
        function getSegmentAbbrev(serviceModel) {
            if (!serviceModel) return '-';
            if (serviceModel.includes('Large')) return 'L';
            if (serviceModel.includes('Enterprise')) return 'E';
            if (serviceModel.includes('Mid-Market Assigned')) return 'MM-A';
            if (serviceModel.includes('Mid-Market Scaled')) return 'MM-S';
            return serviceModel.substring(0, 4);
        }
        


        // Filter functionality for Book of Business table
        function filterTable() {
            const searchText = document.getElementById('account-search').value.toLowerCase();
            const pacingFilter = document.getElementById('pacing-filter').value;
            const revenueFilter = document.getElementById('revenue-filter').value;
            
            const table = document.getElementById('full-book');
            const rows = table.getElementsByTagName('tr');
            let visibleCount = 0;
            
            for (let i = 0; i < rows.length; i++) {
                const row = rows[i];
                const cells = row.getElementsByTagName('td');
                
                // Skip summary rows and TOTAL row
                if (cells.length < 5) {
                    continue;
                }
                
                // Skip the TOTAL row (it contains "üìä TOTAL")
                if (row.textContent.includes('TOTAL')) {
                    continue;
                }
                
                const accountName = cells[1].textContent.toLowerCase();
                // Column indices after adding Exclude checkbox and Segment column:
                // 0=Excl, 1=Account, 2=SFDC, 3=Segment, 4=GMV, 5=Rev, 6=TakeRate, 7=2025Total, 8=Q1'25, 9=Q1'26, 10=Q1YoY
                const revenue2025Text = cells[7].textContent.replace(/[$,]/g, '');
                const revenue2025 = parseFloat(revenue2025Text) || 0;
                const yoyPacingCell = cells[10].textContent;
                
                // Parse YoY pacing
                let pacingValue = 0;
                let pacingCategory = 'na';
                if (yoyPacingCell && yoyPacingCell !== '-' && yoyPacingCell !== 'N/A') {
                    pacingValue = parseFloat(yoyPacingCell.replace('%', '').replace('üî•', '').trim());
                    if (pacingValue > 40) pacingCategory = 'high';
                    else if (pacingValue >= 25) pacingCategory = 'medium';
                    else pacingCategory = 'low';
                }
                
                // Apply filters
                let showRow = true;
                
                // Search filter
                if (searchText && !accountName.includes(searchText)) {
                    showRow = false;
                }
                
                // Pacing filter
                if (pacingFilter !== 'all') {
                    if (pacingFilter === 'high' && pacingCategory !== 'high') showRow = false;
                    if (pacingFilter === 'medium' && pacingCategory !== 'medium') showRow = false;
                    if (pacingFilter === 'low' && pacingCategory !== 'low') showRow = false;
                }
                
                // Revenue filter
                if (revenueFilter !== 'all') {
                    if (revenueFilter === '1m' && revenue2025 < 1000000) showRow = false;
                    if (revenueFilter === '500k' && (revenue2025 < 500000 || revenue2025 >= 1000000)) showRow = false;
                    if (revenueFilter === '100k' && (revenue2025 < 100000 || revenue2025 >= 500000)) showRow = false;
                    if (revenueFilter === 'under100k' && revenue2025 >= 100000) showRow = false;
                }
                
                if (showRow) {
                    row.classList.remove('hidden');
                    visibleCount++;
                } else {
                    row.classList.add('hidden');
                }
            }
            
            // Update count
            document.getElementById('filter-count').textContent = `Showing ${visibleCount} accounts`;
        }
        
        function clearFilters() {
            document.getElementById('account-search').value = '';
            document.getElementById('pacing-filter').value = 'all';
            document.getElementById('revenue-filter').value = 'all';
            filterTable();
        }

        // Sorting functionality
        let currentSortCol = -1;
        let currentSortDir = 'none';

        function sortTable(colIndex, type) {
            const table = document.getElementById('book-table');
            const tbody = document.getElementById('full-book');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            const headers = table.querySelectorAll('th.sortable');
            
            // Determine sort direction
            if (currentSortCol === colIndex) {
                currentSortDir = currentSortDir === 'asc' ? 'desc' : 'asc';
            } else {
                currentSortDir = 'desc'; // Default to descending for numbers
                if (type === 'string') currentSortDir = 'asc';
            }
            currentSortCol = colIndex;
            
            // Update header styles
            headers.forEach(h => {
                h.classList.remove('asc', 'desc');
            });
            const currentHeader = table.querySelector(`th[data-col="${colIndex}"]`);
            if (currentHeader) {
                currentHeader.classList.add(currentSortDir);
            }
            
            // Sort rows
            rows.sort((a, b) => {
                const cellA = a.cells[colIndex];
                const cellB = b.cells[colIndex];
                
                if (!cellA || !cellB) return 0;
                
                let valA = cellA.textContent.trim();
                let valB = cellB.textContent.trim();
                
                // Parse based on type
                if (type === 'currency') {
                    valA = parseFloat(valA.replace(/[$,KM]/g, '')) || 0;
                    valB = parseFloat(valB.replace(/[$,KM]/g, '')) || 0;
                    // Handle K and M suffixes
                    if (cellA.textContent.includes('K')) valA *= 1000;
                    if (cellA.textContent.includes('M')) valA *= 1000000;
                    if (cellB.textContent.includes('K')) valB *= 1000;
                    if (cellB.textContent.includes('M')) valB *= 1000000;
                } else if (type === 'percent') {
                    valA = parseFloat(valA.replace(/[%üî•]/g, '')) || -999;
                    valB = parseFloat(valB.replace(/[%üî•]/g, '')) || -999;
                    if (valA === -999 || cellA.textContent === '-' || cellA.textContent === 'N/A') valA = -999;
                    if (valB === -999 || cellB.textContent === '-' || cellB.textContent === 'N/A') valB = -999;
                }
                
                // Compare
                let comparison = 0;
                if (type === 'string') {
                    comparison = valA.localeCompare(valB);
                } else {
                    comparison = valA - valB;
                }
                
                return currentSortDir === 'asc' ? comparison : -comparison;
            });
            
            // Re-append sorted rows
            rows.forEach(row => tbody.appendChild(row));
        }
    </script>
</body>
</html>
